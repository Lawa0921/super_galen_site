<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>È≥≥Ê¢®ËÄÅÂ∏´ | The Golden Spiral</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=LXGW+WenKai+TC:wght@300;400;700&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <style>
        :root {
            --bg-color: #2b2000; /* Dark Gold/Brown for contrast */
            --light-bg: #FFFACD; /* LemonChiffon */
            --primary: #FFD700; /* Gold */
            --accent: #FFA500; /* Orange */
            --text-main: #5D4037;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'LXGW WenKai TC', sans-serif;
            overflow: hidden;
            width: 100vw; height: 100vh;
        }

        #canvas-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1; outline: none;
        }

        /* UI Layer */
        .ui-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 20; pointer-events: none;
        }

        .nav-bar {
            position: absolute; top: 2rem; left: 2rem;
            pointer-events: auto;
            color: #FFF; text-shadow: 0 0 10px var(--primary);
        }
        .back-link {
            text-decoration: none; color: inherit; font-size: 1.2rem; font-weight: bold;
            display: flex; align-items: center; gap: 0.5rem;
            transition: color 0.3s;
        }
        .back-link:hover { color: var(--primary); }
        .back-link i { font-size: 1.5rem; }

        /* Loading / Start Screen */
        .start-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #FFFACD 0%, #FFD700 100%);
            z-index: 100;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: transform 1s cubic-bezier(0.7, 0, 0.3, 1), opacity 0.5s;
        }
        .start-screen.active { pointer-events: auto; }
        .start-screen.hidden { transform: translateY(-100%); pointer-events: none; }

        .title-group { text-align: center; margin-bottom: 3rem; }
        .main-title {
            font-size: 4rem; font-weight: 700; color: #5D4037;
            margin-bottom: 0.5rem; letter-spacing: 0.1em;
            text-shadow: 2px 2px 0px #FFF;
        }
        .sub-title {
            font-family: 'Orbitron', sans-serif; font-size: 1.5rem; color: #E65100;
            letter-spacing: 0.3em;
        }

        .start-btn {
            padding: 1rem 3rem; font-size: 1.5rem;
            background: #5D4037; color: #FFD700;
            border: 2px solid #5D4037; border-radius: 50px;
            cursor: pointer; font-family: 'Orbitron', sans-serif;
            transition: all 0.3s;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            position: relative; overflow: hidden;
            pointer-events: auto;
        }
        .start-btn:hover {
            background: #FFD700; color: #5D4037;
            transform: scale(1.05);
            box-shadow: 0 0 30px var(--primary);
        }
        .start-btn::after {
            content: ''; position: absolute; top: -50%; left: -50%;
            width: 200%; height: 200%;
            background: rgba(255,255,255,0.2);
            transform: rotate(45deg) translateY(-100%);
            transition: transform 0.5s;
        }
        .start-btn:hover::after { transform: rotate(45deg) translateY(0); }

        /* HUD */
        .hud-progress {
            position: absolute; right: 2rem; top: 50%; transform: translateY(-50%);
            height: 60vh; width: 4px; background: rgba(255,255,255,0.1);
            border-radius: 2px;
            display: flex; flex-direction: column; justify-content: flex-start;
        }
        .hud-bar {
            width: 100%; height: 0%; background: var(--primary);
            box-shadow: 0 0 10px var(--primary);
            border-radius: 2px;
        }
        .hud-marker {
            position: absolute; right: 10px; font-family: 'Orbitron'; font-size: 12px;
            color: var(--primary); opacity: 0.5; transition: opacity 0.3s;
            white-space: nowrap;
        }
        .hud-marker.active { opacity: 1; text-shadow: 0 0 5px var(--primary); font-weight: bold; }

        .tutorial {
            position: absolute; bottom: 2rem; width: 100%; text-align: center;
            color: #FFF; font-family: 'Orbitron'; letter-spacing: 2px; font-size: 0.9rem;
            animation: pulse 2s infinite; opacity: 0; transition: opacity 1s;
        }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }

        /* Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(43, 32, 0, 0.9);
            z-index: 200;
            display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }

        .modal-content {
            background: #FFFACD; color: #5D4037;
            padding: 3rem; border-radius: 20px;
            max-width: 800px; width: 90%; max-height: 85vh;
            overflow-y: auto;
            border: 4px solid #FFD700;
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.5);
            position: relative;
            transform: translateY(20px) scale(0.95); transition: all 0.3s;
        }
        .modal-overlay.active .modal-content { transform: translateY(0) scale(1); }

        .modal-close {
            position: absolute; top: 1.5rem; right: 1.5rem;
            font-size: 2rem; color: #5D4037; cursor: pointer;
            transition: color 0.3s;
        }
        .modal-close:hover { color: #E65100; transform: scale(1.1); }

        .modal-title { font-size: 2.5rem; margin-bottom: 1.5rem; font-weight: bold; color: #E65100; border-bottom: 2px solid #5D4037; padding-bottom: 0.5rem; }
        .modal-text { font-size: 1.2rem; line-height: 1.8; white-space: pre-line; text-align: justify; }

    </style>
</head>
<body>

    <!-- Start Screen -->
    <div class="start-screen active" id="startScreen">
        <div class="title-group">
            <div class="main-title">È≥≥Ê¢®ËÄÅÂ∏´</div>
            <div class="sub-title">MATH UNIVERSE</div>
        </div>
        <button class="start-btn" id="startBtn">ENTER WORLD</button>
    </div>

    <div id="canvas-container"></div>

    <div class="ui-layer">
        <nav class="nav-bar">
            <a href="index.html" class="back-link"><i class="fa-solid fa-arrow-left"></i> GUILD</a>
        </nav>

        <div class="hud-progress">
            <div class="hud-bar" id="progressBar"></div>
            <!-- Markers injected via JS -->
        </div>

        <div class="tutorial" id="tutorialText">SCROLL TO EXPLORE<br><span style="font-size:0.7em; opacity:0.8;">CLICK CARDS FOR DETAILS</span></div>
    </div>

    <!-- Modal -->
    <div class="modal-overlay" id="infoModal">
        <div class="modal-content">
            <i class="fas fa-times modal-close" id="modalClose"></i>
            <div class="modal-title" id="modalTitle">Title</div>
            <div class="modal-text" id="modalText">Content...</div>
        </div>
    </div>

    <!-- Hidden Asset Config -->
    <div id="assets" style="display:none;">
        <img id="img-avatar" src="../assets/img/guild/pineapple/avatar.webp">
        <!-- Gallery Images -->
        <img id="img-g1" src="../assets/img/guild/pineapple/gallery_1.webp">
        <img id="img-g2" src="../assets/img/guild/pineapple/gallery_2.webp">
        <img id="img-g3" src="../assets/img/guild/pineapple/gallery_3.webp">
        <img id="img-g4" src="../assets/img/guild/pineapple/gallery_4.webp">
        <img id="img-g5" src="../assets/img/guild/pineapple/gallery_5.webp">
        <img id="img-g6" src="../assets/img/guild/pineapple/gallery_6.webp">
        <img id="img-g7" src="../assets/img/guild/pineapple/gallery_7.webp">
        <img id="img-g8" src="../assets/img/guild/pineapple/gallery_8.webp">
        <img id="img-g9" src="../assets/img/guild/pineapple/gallery_9.webp">
    </div>

    <script>
        // --- Configuration ---
        const config = {
            colors: {
                bg: 0x2b2000,
                primary: 0xFFD700, // Gold
                secondary: 0xFFA500, // Orange
                text: 0x5D4037, // Brown
                light: 0xFFFACD // LemonChiffon
            },
            spiral: {
                radius: 15,
                height: 120,
                loops: 3,
                tubeRadius: 1
            },
            camera: {
                fov: 60
            }
        };

        // --- State ---
        let state = {
            scroll: 0,
            targetScroll: 0,
            isStarted: false,
            markers: []
        };

        // --- Init Three.js ---
        const container = document.getElementById('canvas-container');
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(config.colors.bg);
        scene.fog = new THREE.FogExp2(config.colors.bg, 0.02);

        const camera = new THREE.PerspectiveCamera(config.camera.fov, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.shadowMap.enabled = true;
        container.appendChild(renderer.domElement);

        // --- Lighting ---
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
        scene.add(ambientLight);

        const spotLight = new THREE.SpotLight(config.colors.primary, 2);
        spotLight.position.set(0, 50, 0);
        spotLight.angle = 1;
        spotLight.penumbra = 0.5;
        spotLight.castShadow = true;
        scene.add(spotLight);

        // --- The Spiral Path ---
        // Create points for a helical path
        const points = [];
        const curvePoints = 200;
        for (let i = 0; i <= curvePoints; i++) {
            const t = i / curvePoints;
            const angle = t * Math.PI * 2 * config.spiral.loops;
            const y = (1 - t) * config.spiral.height - (config.spiral.height/2); // Top to bottom
            const x = Math.cos(angle) * config.spiral.radius;
            const z = Math.sin(angle) * config.spiral.radius;
            points.push(new THREE.Vector3(x, y, z));
        }
        const curve = new THREE.CatmullRomCurve3(points);

        // Visual Guide for the Path
        const tubeGeo = new THREE.TubeGeometry(curve, 200, 0.2, 8, false);
        const tubeMat = new THREE.MeshBasicMaterial({
            color: config.colors.secondary,
            transparent: true,
            opacity: 0.3,
            wireframe: true
        });
        const tube = new THREE.Mesh(tubeGeo, tubeMat);
        scene.add(tube);

        // --- The "Core" (Pineapple Logic Engine) ---
        // Placed at the bottom/center
        const coreGeo = new THREE.IcosahedronGeometry(5, 1);
        const coreMat = new THREE.MeshBasicMaterial({ color: config.colors.primary, wireframe: true });
        const core = new THREE.Mesh(coreGeo, coreMat);
        core.position.set(0, -config.spiral.height/2 - 10, 0);
        scene.add(core);

        // Core glow
        const glowGeo = new THREE.IcosahedronGeometry(4, 0);
        const glowMat = new THREE.MeshBasicMaterial({ color: config.colors.secondary, transparent: true, opacity: 0.8 });
        const glow = new THREE.Mesh(glowGeo, glowMat);
        core.add(glow);

        // --- Math Particles System (Global) ---
        const particleCount = 500;
        const particleGroup = new THREE.Group();
        scene.add(particleGroup);

        const symbols = ['+', '-', '√ó', '√∑', '‚àë', 'œÄ', '‚àö', '‚àû', '0', '1', 'sin', 'log'];

        function createTextSprite(text, color) {
            const canvas = document.createElement('canvas');
            canvas.width = 128; canvas.height = 64;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = color || '#FFD700';
            ctx.font = 'bold 40px "Orbitron"';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(text, 64, 32);
            return new THREE.CanvasTexture(canvas);
        }

        const symbolTextures = symbols.map(s => createTextSprite(s, '#FFD700'));

        for(let i=0; i<particleCount; i++) {
            const tex = symbolTextures[Math.floor(Math.random() * symbolTextures.length)];
            const mat = new THREE.SpriteMaterial({ map: tex, transparent: true, opacity: Math.random() * 0.5 + 0.2 });
            const sprite = new THREE.Sprite(mat);

            // Random pos in a cylinder volume around the spiral
            const r = Math.random() * 40;
            const theta = Math.random() * Math.PI * 2;
            const y = (Math.random() - 0.5) * config.spiral.height * 1.5;

            sprite.position.set(r * Math.cos(theta), y, r * Math.sin(theta));
            sprite.scale.set(2, 1, 1);

            sprite.userData = {
                yVel: (Math.random() - 0.5) * 0.1,
                rotSpeed: (Math.random() - 0.5) * 0.02
            };
            particleGroup.add(sprite);
        }

        // --- Stations (Content Islands) ---
        const stations = [
            { t: 0.05, type: 'intro', title: 'È≥≥Ê¢®ËÄÅÂ∏´', sub: 'Mathematical Pineapple', fullText: "ÊàëÊòØÈ≥≥Ê¢®ËÄÅÂ∏´üçç\nÊòØ‰∏Ä‰ΩçË£úÁøíÁè≠Êï∏Â≠∏ËÄÅÂ∏´/ÂÆâË¶™Áè≠ËÄÅÂ∏´/Ê°åÈÅäËÄÅÂ∏´/ÂúãÂ∞èÂ•ßÊï∏ËÄÅÂ∏´\nÂÖ•Ë°åÂ§ßÁ¥Ñ7Âπ¥" },
            { t: 0.20, type: 'bio', title: 'ÈóúÊñºÊàë', text: '7Âπ¥ÊïôÂ≠∏Á∂ìÈ©ó | ÂîáÈ°éË£ÇÊÇ£ËÄÖ | Ê∫´ÊöñËàáÈÇèËºØ', img: 'img-avatar', fullText: "ÊàëÊòØ‰∏Ä‰ΩçÂîáÈ°éË£ÇÊÇ£ËÄÖÔºåÂæûÂ∞è‰æøÊé•ÂèóÂà∞Ë®±Â§ö‰∫∫ÁöÑÂπ´Âä©Ôºå‰πüËÆìÊàëÊ±∫ÂÆöÂæû‰∫ã‰∏Ä‰ªΩÂèØ‰ª•ÂõûÈ•ãÁ§æÊúÉ„ÄÅÂπ´Âä©‰∫∫ÁöÑÂ∑•‰ΩúÔºåÂ∞çÊàë‰æÜË™™ÔºåÈÄôÂ∑≤‰∏çÂÉÖÂÉÖÊòØÂ∑•‰ΩúÔºåËÄåÊòØÊàëÁöÑ‰ΩøÂëΩ‰∫Ü„ÄÇ\n\nÊàëÁöÑ‰∫∫Áâ©È¢®Ê†ºÊòØÔºöÈ≥≥Ê¢®„ÄÅËÄÅÂ∏´„ÄÅÊï∏Â≠∏„ÄÅÈÇèËºØ„ÄÅÊ∫´Êöñ„ÄÅÈñãÊúó„ÄÅÂ•ßÊï∏„ÄÅÊ°åÈÅä" },
            { t: 0.40, type: 'mission', title: 'ÊàëÁöÑ‰ΩøÂëΩ', text: '„ÄåÁµ¶‰∫àÔºåÊòØ‰∏ÄÁîüÊúÄÊúâÊÑèÁæ©ÁöÑ‰∫ã„Äç\nÂ∏∂È†òÂ≠©Â≠êÂæÅÊà∞Â•ßÊï∏Ôºå‰∏çÊáºÊÄïÊï∏Â≠∏', fullText: "Áï∂ÁÑ∂Ôºå‰ΩúÁÇ∫‰∏ÄÂêçÊï∏Â≠∏ËÄÅÂ∏´ÔºåÊàëÂ∏åÊúõÂèØ‰ª•ËÆìÂ≠©Â≠êÂÄë‰∏çÊáºÊÄïÊï∏Â≠∏ÔºåÁîöËá≥ÂèØ‰ª•ÂñúÊ≠°‰∏äÊï∏Â≠∏ÔºåÁõÆÂâç‰πüÊ≠£Âú®Âä™ÂäõÈñãÂ•ßÊï∏Áè≠ÔºåÈ†êË®à‰∏ãÂ≠∏ÊúüÂèØ‰ª•ÈñãÊàêÂäüÔºÅ\n\n2024ÊàëÈñãÂßãÂüπË®ìÂ≠©Â≠êÂÄëÂèÉÂä†Â•ßÊûóÂåπÂÖãÊï∏Â≠∏ÂúòÈ´îÁ´∂Ë≥ΩÔºåÁõÆÂâçÂ≠∏ÁîüÊúâÂú®ÂÄã‰∫∫Ë≥Ω‰∏äÁç≤ÂæóÈäÄÁçéÂíåÈäÖÁçéÁöÑ‰Ω≥Á∏æ„ÄÇ\n\n„ÄåÁµ¶‰∫àÔºåÊòØ‰∏ÄÁîüÊúÄÊúâÊÑèÁæ©ÁöÑ‰∫ã„ÄÇ„Äç" },
            { t: 0.60, type: 'gallery', title: 'ÊïôÂ≠∏ÂõûÊÜ∂', text: 'ÈªûÊª¥Á¥ØÁ©ç', imgs: ['img-g1', 'img-g2', 'img-g3'], fullText: "Êàë‰∏ÄÁõ¥ÈÉΩÂ∏åÊúõÂèØ‰ª•Êúâ‰∏ÄÂÄãÁ∂≤Á´ôÔºåÁ¥ÄÈåÑÊàëÁöÑÊïôÂ≠∏ÂõûÊÜ∂ÔºåÂèØ‰ª•Ë®òÈåÑËëóÊàëÁöÑÊïôÂ≠∏ËªåË∑°Ôºå‰∏çÁÆ°ÊòØÁÇ∫Â≠©Â≠êÂÄëËæ¶ÁöÑÊØè‰∏ÄÂ†¥Ê¥ªÂãïÔºåÂèàÊàñËÄÖÊòØÂ∏∂Â≠©Â≠êÂÄëÂæÅÊà∞ÂêÑÂÄãÊØîË≥ΩÁöÑÁï´Èù¢ÔºåÁï∂ÁÑ∂ÔºåÊàë‰πüÂ∏åÊúõÂèØ‰ª•ËÆìÊõ¥Â§ö‰∫∫Ë™çË≠òÊàë„ÄÇ" },
            { t: 0.75, type: 'gallery', title: 'Ê¶ÆËÄÄÊôÇÂàª', text: 'ÂÄã‰∫∫Ë≥ΩÈäÄÁçéÈäÖÁçé‰Ω≥Á∏æ', imgs: ['img-g4', 'img-g5', 'img-g6'], fullText: "Â∏∂È†òÂ≠©Â≠êÂÄëÂèÉÂä†ÊØîË≥ΩÔºåÁúãËëó‰ªñÂÄëÊàêÈï∑ÔºåÊòØÊàëÊúÄÂ§ßÁöÑÂø´Ê®Ç„ÄÇ" },
            { t: 0.90, type: 'contact', title: 'ËÅØÁµ°Êàë', social: true, fullText: "Ê≠°ËøéËøΩËπ§ÊàëÁöÑÁ§æÁæ§ÔºÅ" }
        ];

        // HUD Markers
        const hudContainer = document.querySelector('.hud-progress');
        stations.forEach(s => {
            const m = document.createElement('div');
            m.className = 'hud-marker';
            m.style.top = `${s.t * 100}%`;
            m.innerText = s.type.toUpperCase();
            hudContainer.appendChild(m);
            state.markers.push({ el: m, t: s.t });
        });

        // Interactive Objects array for Raycaster
        const interactiveObjects = [];
        const contentGroups = [];

        // Helper to create content meshes
        function createContentMesh(station) {
            const group = new THREE.Group();
            group.userData.stationInfo = station; // Store info for interaction

            // Platform
            const platGeo = new THREE.CylinderGeometry(4, 3, 0.5, 6);
            const platMat = new THREE.MeshStandardMaterial({
                color: config.colors.light,
                roughness: 0.3, metalness: 0.1
            });
            const platform = new THREE.Mesh(platGeo, platMat);
            group.add(platform);

            // Text Board
            const canvas = document.createElement('canvas');
            canvas.width = 1024; canvas.height = 512;
            const ctx = canvas.getContext('2d');

            // Background for better visibility
            ctx.fillStyle = 'rgba(255, 250, 205, 0.1)';
            ctx.roundRect(0, 0, 1024, 512, 50);
            ctx.fill();

            ctx.textAlign = 'center';
            ctx.fillStyle = '#5D4037';

            // Title
            ctx.font = 'bold 80px "LXGW WenKai TC"';
            ctx.fillText(station.title, 512, 100);

            // Body
            if(station.text) {
                ctx.font = '40px "LXGW WenKai TC"';
                const lines = station.text.split('\n');
                let ly = 200;
                lines.forEach(line => {
                    ctx.fillText(line, 512, ly);
                    ly += 60;
                });
            }

            // Sub for intro
            if(station.sub) {
                 ctx.font = 'bold 60px "Orbitron"';
                 ctx.fillStyle = '#E65100';
                 ctx.fillText(station.sub, 512, 250);
            }

            // Click hint
            ctx.font = '30px "Orbitron"';
            ctx.fillStyle = '#FFA500';
            ctx.fillText("[ CLICK TO READ MORE ]", 512, 450);

            const tex = new THREE.CanvasTexture(canvas);
            const boardGeo = new THREE.PlaneGeometry(8, 4);
            const boardMat = new THREE.MeshBasicMaterial({ map: tex, transparent: true, side: THREE.DoubleSide });
            const board = new THREE.Mesh(boardGeo, boardMat);
            board.position.y = 3;
            board.userData.isInteractable = true;
            board.userData.parentGroup = group;
            group.add(board);
            interactiveObjects.push(board);

            // Images
            if(station.img) {
                const imgEl = document.getElementById(station.img);
                if(imgEl) {
                    const iTex = new THREE.TextureLoader().load(imgEl.src);
                    const iMat = new THREE.MeshBasicMaterial({ map: iTex, side: THREE.DoubleSide });
                    const iMesh = new THREE.Mesh(new THREE.PlaneGeometry(3, 3), iMat);
                    iMesh.position.set(0, 3, 2); // Floating in front
                    // Add border
                    const bMesh = new THREE.Mesh(new THREE.PlaneGeometry(3.2, 3.2), new THREE.MeshBasicMaterial({color: 0xFFD700}));
                    bMesh.position.z = -0.01;
                    iMesh.add(bMesh);

                    iMesh.userData.isInteractable = true;
                    iMesh.userData.parentGroup = group;
                    group.add(iMesh);
                    interactiveObjects.push(iMesh);
                }
            }

            // Gallery Grid
            if(station.imgs) {
                station.imgs.forEach((id, idx) => {
                    const imgEl = document.getElementById(id);
                    if(imgEl) {
                        const iTex = new THREE.TextureLoader().load(imgEl.src);
                        const iMat = new THREE.MeshBasicMaterial({ map: iTex, side: THREE.DoubleSide });
                        const iMesh = new THREE.Mesh(new THREE.PlaneGeometry(2.5, 2.5), iMat);
                        // Arrange in arc
                        const angle = (idx - 1) * 0.5;
                        iMesh.position.set(Math.sin(angle)*4, 4, Math.cos(angle)*2);
                        iMesh.lookAt(0, 4, 10); // Look roughly forward

                        iMesh.userData.isInteractable = true;
                        iMesh.userData.parentGroup = group;
                        group.add(iMesh);
                        interactiveObjects.push(iMesh);
                    }
                });
            }

            // Social Icons for Contact
            if(station.social) {
                 const sCanvas = document.createElement('canvas');
                 sCanvas.width = 512; sCanvas.height = 256;
                 const sCtx = sCanvas.getContext('2d');
                 sCtx.fillStyle = '#5D4037';
                 sCtx.font = '40px "LXGW WenKai TC"';
                 sCtx.textAlign = 'center';
                 sCtx.fillText("Instagram / Threads", 256, 128);
                 const sTex = new THREE.CanvasTexture(sCanvas);
                 const sMesh = new THREE.Mesh(new THREE.PlaneGeometry(4, 2), new THREE.MeshBasicMaterial({map: sTex, transparent: true}));
                 sMesh.position.y = 1.5;
                 group.add(sMesh);
            }

            return group;
        }

        stations.forEach(s => {
            const group = createContentMesh(s);
            // Position on curve
            const point = curve.getPointAt(s.t);
            group.position.copy(point);
            group.position.y -= 2; // Offset below line

            scene.add(group);
            contentGroups.push(group);
        });

        // --- Interaction ---
        // Scroll Logic
        window.addEventListener('wheel', e => {
            if(!state.isStarted || document.getElementById('infoModal').classList.contains('active')) return;
            state.targetScroll += e.deltaY * 0.0005;
            state.targetScroll = Math.max(0, Math.min(1, state.targetScroll));
        });

        // Touch Logic
        let touchStart = 0;
        window.addEventListener('touchstart', e => touchStart = e.touches[0].clientY);
        window.addEventListener('touchmove', e => {
            if(!state.isStarted || document.getElementById('infoModal').classList.contains('active')) return;
            const d = touchStart - e.touches[0].clientY;
            state.targetScroll += d * 0.002;
            state.targetScroll = Math.max(0, Math.min(1, state.targetScroll));
            touchStart = e.touches[0].clientY;
        });

        // Start Button
        document.getElementById('startBtn').addEventListener('click', () => {
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('tutorialText').style.opacity = 1;
            state.isStarted = true;

            // Intro Animation: Camera swoop
            gsap.to(camera.position, {
                duration: 2,
                z: 20, // Start pos
                onUpdate: () => {
                    // Handled in animate loop
                }
            });

            // Explosion Effect
            particleGroup.children.forEach(p => {
                gsap.to(p.position, {
                    x: p.position.x * 2,
                    z: p.position.z * 2,
                    duration: 1,
                    ease: "power2.out",
                    yoyo: true,
                    repeat: 1
                });
            });
        });

        // Modal Logic
        const modal = document.getElementById('infoModal');
        const modalClose = document.getElementById('modalClose');
        const modalTitle = document.getElementById('modalTitle');
        const modalText = document.getElementById('modalText');

        function openModal(title, text) {
            modalTitle.innerText = title;
            modalText.innerText = text;
            modal.classList.add('active');
        }

        modalClose.addEventListener('click', () => {
            modal.classList.remove('active');
        });

        modal.addEventListener('click', (e) => {
            if(e.target === modal) modal.classList.remove('active');
        });

        // Raycaster for clicks
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();

        window.addEventListener('click', (event) => {
            if(!state.isStarted || modal.classList.contains('active')) return;

            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

            raycaster.setFromCamera(mouse, camera);

            const intersects = raycaster.intersectObjects(interactiveObjects);

            if (intersects.length > 0) {
                const target = intersects[0].object;
                if(target.userData.isInteractable && target.userData.parentGroup) {
                    const info = target.userData.parentGroup.userData.stationInfo;
                    if(info.fullText) {
                        openModal(info.title, info.fullText);
                    }
                }
            }
        });

        // Footer Overlay logic
        const footerOverlay = document.createElement('div');
        footerOverlay.style.cssText = `
            position: fixed; bottom: 5%; left: 0; width: 100%;
            text-align: center; opacity: 0; transition: opacity 0.5s; pointer-events: none; z-index: 50;
        `;
        footerOverlay.innerHTML = `
            <div style="display: flex; gap: 2rem; justify-content: center; font-size: 3rem; margin-bottom: 1rem; pointer-events: auto;">
                <a href="https://www.threads.com/@a_l_w_a_y_s_joy" target="_blank" style="color: #FFD700; text-shadow: 0 0 10px #E65100; transition: transform 0.2s;"><i class="fa-brands fa-threads"></i></a>
                <a href="https://www.instagram.com/a_l_w_a_y_s_joy/" target="_blank" style="color: #FFD700; text-shadow: 0 0 10px #E65100; transition: transform 0.2s;"><i class="fa-brands fa-instagram"></i></a>
            </div>
             <p style="font-size: 0.8rem; color: #FFF; opacity: 0.8;">
                Made with love by <a href="index.html" style="color: #FFA500; text-decoration: none;">SuperGalen's Dungeon</a>
            </p>
        `;
        document.body.appendChild(footerOverlay);

        // --- Animation Loop ---
        function animate() {
            requestAnimationFrame(animate);

            // Smooth Scroll
            state.scroll += (state.targetScroll - state.scroll) * 0.1;

            if(state.isStarted) {
                // Camera Follow Path
                const t = Math.max(0.001, Math.min(0.999, state.scroll));

                const pos = curve.getPointAt(t);
                const lookAtPos = curve.getPointAt(Math.min(1, t + 0.05));

                // Camera Offset
                const center = new THREE.Vector3(0, pos.y, 0);
                const normal = new THREE.Vector3().subVectors(pos, center).normalize();
                const camPos = pos.clone().add(normal.multiplyScalar(5)).add(new THREE.Vector3(0, 2, 0));

                camera.position.lerp(camPos, 0.1);
                camera.lookAt(lookAtPos);

                // Billboard Content to Face Camera
                contentGroups.forEach(group => {
                     // Make the group look at the camera
                     group.lookAt(camera.position);
                });

                // Rotate Core
                core.rotation.y += 0.01;
                core.rotation.z += 0.005;

                // Animate Particles
                particleGroup.children.forEach(p => {
                    p.position.y += p.userData.yVel;
                    p.rotation.z += p.userData.rotSpeed;
                    if(Math.abs(p.position.y) > config.spiral.height) p.position.y = -p.position.y;
                });
            }

            // HUD Update
            const progress = document.getElementById('progressBar');
            if(progress) progress.style.height = `${state.scroll * 100}%`;

            // Active Marker
            state.markers.forEach(m => {
                if(Math.abs(state.scroll - m.t) < 0.05) {
                    m.el.classList.add('active');
                    m.el.style.transform = 'scale(1.2) translateX(-5px)';
                } else {
                    m.el.classList.remove('active');
                    m.el.style.transform = 'scale(1) translateX(0)';
                }
            });

            // Show footer
            if(state.scroll > 0.85) {
                footerOverlay.style.opacity = 1;
                footerOverlay.style.pointerEvents = 'auto';
            } else {
                footerOverlay.style.opacity = 0;
                footerOverlay.style.pointerEvents = 'none';
            }

            renderer.render(scene, camera);
        }

        animate();

        // Resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // Hover effects for social icons
        const icons = footerOverlay.querySelectorAll('a');
        icons.forEach(icon => {
            icon.addEventListener('mouseenter', () => icon.style.transform = 'scale(1.2)');
            icon.addEventListener('mouseleave', () => icon.style.transform = 'scale(1)');
        });

    </script>
</body>
</html>
