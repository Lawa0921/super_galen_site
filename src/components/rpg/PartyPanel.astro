---
/**
 * PartyPanel.astro
 * 夥伴召喚系統面板
 * 樣式由全局 _summon.scss 提供
 */
import { type Language, useTranslations } from '@i18n/index';

interface Props {
  lang: Language;
}

const { lang } = Astro.props;
const { all: trans } = useTranslations(lang);
---

<div class="summon-system">
    <!-- 召喚區域 -->
    <div class="summon-section">

        <!-- 召喚門背景區域 -->
        <div class="summon-portal-container">
            <picture>
                <source srcset="/assets/images/summon-portal-bg.webp" type="image/webp">
                <img src="/assets/images/summon-portal-bg.webp" alt="召喚門" class="portal-background" id="portalImage" width="800" height="800" loading="lazy">
            </picture>

            <!-- 召喚動畫影片 -->
            <video id="summonVideo" class="summon-animation-video" preload="auto" playsinline muted>
                <source src="/assets/video/summon-animation.mp4" type="video/mp4">
                您的瀏覽器不支援影片播放。
            </video>

            <!-- 召喚光暈特效 -->
            <div id="summonAura" class="summon-aura"></div>

            <!-- 粒子特效容器 -->
            <div id="particleContainer" class="particle-container"></div>

            <!-- 可點擊的召喚門區域 -->
            <div class="portal-interactive-area"
                 id="portalInteractiveArea">
                <!-- 召喚特效環 -->
                <div class="portal-ring portal-ring-1"></div>
                <div class="portal-ring portal-ring-2"></div>
                <div class="portal-ring portal-ring-3"></div>
                <div class="portal-center">
                    <div class="portal-glow"></div>
                </div>
            </div>

            <!-- 召喚費用提示工具 -->
            <div class="summon-tooltip" id="summonTooltip">
                <div class="tooltip-content">
                    <div class="tooltip-title" data-i18n="ui.summon.click_to_summon">點擊召喚夥伴</div>
                    <div class="tooltip-cost">
                        <img src="/assets/images/pile_of_gold_coins.webp" alt="金幣" class="tooltip-coin" width="256" height="256">
                        <span>10,000 金幣</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 夥伴收藏區域 - 移出summon-system，直接在tab-panel下 -->
<div class="companion-collection">
    <!-- 標題和收集率區域 -->
    <div class="collection-header">
        <h3 class="collection-title" data-i18n="ui.summon.companion_collection">夥伴圖鑑</h3>
        <div class="collection-stats">
            <div class="stats-row">
                <div class="progress-bar-container">
                    <div class="collection-progress-bar" id="collection-progress-bar" style="width: 0%"></div>
                </div>
                <div class="progress-info">
                    <span id="collected-count">0</span> / <span id="total-count">0</span>
                    (<span id="collection-percentage">0%</span>)
                </div>
            </div>
        </div>
    </div>

    <!-- 統一的夥伴網格 -->
    <div class="companion-grid unified-grid">
        <!-- 所有夥伴卡片將由 JavaScript 生成 -->
    </div>
</div>

<!-- 召喚結果模態框 -->
<div class="summon-result-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3></h3>
            <button class="close-btn" id="closeSummonResultBtn">×</button>
        </div>
        <div class="companion-showcase">
            <div class="companion-image">
                <img src="" alt="夥伴立繪">
                <div class="companion-frame"></div>
            </div>
            <div class="companion-details">
                <div class="rarity-stars"></div>
                <h4 class="companion-name"></h4>
                <p class="companion-description"></p>
                <div class="companion-skills"></div>
            </div>
        </div>
    </div>
    <div class="modal-background" id="summonModalBackground"></div>
</div>

<script>
  // 召喚系統事件綁定
  document.addEventListener('DOMContentLoaded', () => {
    const portalArea = document.getElementById('portalInteractiveArea');
    const tooltip = document.getElementById('summonTooltip');
    const closeBtn = document.getElementById('closeSummonResultBtn');
    const modalBg = document.getElementById('summonModalBackground');

    if (portalArea) {
      portalArea.addEventListener('click', () => {
        if (typeof window.performSummon === 'function') {
          window.performSummon();
        }
      });

      portalArea.addEventListener('mouseenter', (e) => {
        if (typeof window.showSummonTooltip === 'function') {
          window.showSummonTooltip(e);
        }
      });

      portalArea.addEventListener('mousemove', (e) => {
        if (typeof window.updateSummonTooltipPosition === 'function') {
          window.updateSummonTooltipPosition(e);
        }
      });

      portalArea.addEventListener('mouseleave', () => {
        if (typeof window.hideSummonTooltip === 'function') {
          window.hideSummonTooltip();
        }
      });
    }

    if (closeBtn) {
      closeBtn.addEventListener('click', () => {
        if (typeof window.closeSummonResult === 'function') {
          window.closeSummonResult();
        }
      });
    }

    if (modalBg) {
      modalBg.addEventListener('click', () => {
        if (typeof window.closeSummonResult === 'function') {
          window.closeSummonResult();
        }
      });
    }
  });
</script>
