---
/**
 * SkillTreePanel.astro
 * æŠ€èƒ½æ¨¹é¢æ¿ - Canvas æ¸²æŸ“çš„éšå±¤å¼æŠ€èƒ½æ¨¹
 */
import { type Language, useTranslations } from '@i18n/index';

interface Props {
  lang: Language;
}

const { lang } = Astro.props;
const { all: trans } = useTranslations(lang);
---

<div class="skills-panel">
  <h3 class="panel-title">
    <i class="fas fa-code-branch"></i>
    {trans.skills?.title || 'æŠ€èƒ½æ¨¹'}
  </h3>

  <div class="skill-tree-wrapper">
    <div class="skill-tree-container">
      <canvas id="skill-tree-canvas"></canvas>

      <!-- ç¸®æ”¾æ§åˆ¶æŒ‰éˆ• -->
      <div class="zoom-controls">
        <button class="zoom-btn" id="zoom-in" title="æ”¾å¤§">
          <i class="fas fa-plus"></i>
        </button>
        <button class="zoom-btn" id="zoom-out" title="ç¸®å°">
          <i class="fas fa-minus"></i>
        </button>
        <button class="zoom-btn" id="zoom-reset" title="é‡ç½®è¦–è§’">
          <i class="fas fa-compress-arrows-alt"></i>
        </button>
      </div>

      <!-- æŠ€èƒ½è©³æƒ…é¢æ¿ -->
      <div class="skill-details-panel" id="skill-details-panel" style="display: none;">
        <button class="close-btn" id="close-skill-details">
          <i class="fas fa-times"></i>
        </button>
        <div class="skill-icon" id="skill-icon"></div>
        <h4 class="skill-name" id="skill-name"></h4>
        <p class="skill-description" id="skill-description"></p>
        <div class="skill-meta">
          <span class="skill-level" id="skill-level"></span>
          <span class="skill-experience" id="skill-experience"></span>
        </div>
      </div>
    </div>

    <p class="skill-tree-hint">
      <i class="fas fa-mouse-pointer"></i>
      {trans.skills?.hint || 'æ‹–æ›³ç§»å‹•è¦–è§’ï¼Œæ»¾è¼ªç¸®æ”¾ï¼Œé»æ“Šç¯€é»æŸ¥çœ‹è©³æƒ…'}
    </p>
  </div>
</div>

<script>
  // æŠ€èƒ½æ¨¹åˆå§‹åŒ–
  document.addEventListener('DOMContentLoaded', () => {
    const canvas = document.getElementById('skill-tree-canvas') as HTMLCanvasElement;
    if (!canvas) return;

    // è¨­å®š Canvas å°ºå¯¸
    const container = canvas.parentElement;
    if (container) {
      const rect = container.getBoundingClientRect();
      canvas.width = Math.max(rect.width, 800);
      canvas.height = 500;
    }

    // ç›£è½ tab åˆ‡æ›äº‹ä»¶ï¼Œç•¶åˆ‡æ›åˆ°æŠ€èƒ½é ç±¤æ™‚åˆå§‹åŒ–
    document.addEventListener('tabChanged', (e: Event) => {
      const customEvent = e as CustomEvent<{ tabId: string }>;
      if (customEvent.detail.tabId === 'skills') {
        initSkillTree();
      }
    });

    // å¦‚æœæŠ€èƒ½é ç±¤å·²ç¶“æ˜¯æ´»å‹•ç‹€æ…‹ï¼Œç«‹å³åˆå§‹åŒ–
    const skillsTab = document.getElementById('skills-tab');
    if (skillsTab?.classList.contains('active')) {
      initSkillTree();
    }
  });

  function initSkillTree() {
    const canvas = document.getElementById('skill-tree-canvas') as HTMLCanvasElement;
    const ctx = canvas?.getContext('2d');
    if (!canvas || !ctx) return;

    // æª¢æŸ¥æ˜¯å¦å·²åˆå§‹åŒ–
    if ((canvas as any).__initialized) return;
    (canvas as any).__initialized = true;

    console.log('ğŸŒ³ åˆå§‹åŒ–æŠ€èƒ½æ¨¹...');

    // æŠ€èƒ½æ¨¹è³‡æ–™çµæ§‹
    const skillTree = buildSkillTree();

    // ç¹ªè£½æŠ€èƒ½æ¨¹
    drawSkillTree(ctx, canvas, skillTree);

    // è¨­ç½®äº’å‹•äº‹ä»¶
    setupInteractions(canvas, ctx, skillTree);

    console.log('âœ… æŠ€èƒ½æ¨¹åˆå§‹åŒ–å®Œæˆ');
  }

  interface SkillNode {
    id: string;
    name: string;
    level: number;
    color: string;
    x?: number;
    y?: number;
    radius?: number;
    children?: SkillNode[];
  }

  function buildSkillTree(): SkillNode {
    return {
      id: 'root',
      name: 'SuperGalen',
      level: 5,
      color: '#ffd700',
      children: [
        {
          id: 'frontend',
          name: 'å‰ç«¯æŠ€è¡“',
          level: 4,
          color: '#6495ed',
          children: [
            { id: 'html', name: 'HTML/CSS', level: 5, color: '#e34c26' },
            { id: 'js', name: 'JavaScript', level: 5, color: '#f7df1e' },
            { id: 'ts', name: 'TypeScript', level: 4, color: '#3178c6' },
            { id: 'react', name: 'React', level: 3, color: '#61dafb' },
          ],
        },
        {
          id: 'backend',
          name: 'å¾Œç«¯æŠ€è¡“',
          level: 4,
          color: '#50c878',
          children: [
            { id: 'ruby', name: 'Ruby/Rails', level: 5, color: '#cc342d' },
            { id: 'elixir', name: 'Elixir/Phoenix', level: 4, color: '#6e4a7e' },
            { id: 'node', name: 'Node.js', level: 3, color: '#68a063' },
            { id: 'db', name: 'PostgreSQL', level: 4, color: '#336791' },
          ],
        },
        {
          id: 'devops',
          name: 'DevOps',
          level: 3,
          color: '#ff7f50',
          children: [
            { id: 'git', name: 'Git/GitHub', level: 5, color: '#f05032' },
            { id: 'aws', name: 'AWS', level: 3, color: '#ff9900' },
            { id: 'docker', name: 'Docker', level: 3, color: '#2496ed' },
          ],
        },
        {
          id: 'blockchain',
          name: 'å€å¡Šéˆ',
          level: 3,
          color: '#9966cc',
          children: [
            { id: 'solidity', name: 'Solidity', level: 3, color: '#363636' },
            { id: 'ethers', name: 'ethers.js', level: 4, color: '#2535a0' },
            { id: 'hardhat', name: 'Hardhat', level: 4, color: '#fff100' },
          ],
        },
        {
          id: 'life',
          name: 'ç”Ÿæ´»æŠ€èƒ½',
          level: 4,
          color: '#ff6b6b',
          children: [
            { id: 'boardgame', name: 'æ¡ŒéŠ', level: 5, color: '#8b4513' },
            { id: 'camping', name: 'éœ²ç‡Ÿ', level: 4, color: '#228b22' },
            { id: 'martial', name: 'æ­¦è¡“', level: 4, color: '#dc143c' },
          ],
        },
      ],
    };
  }

  function drawSkillTree(ctx: CanvasRenderingContext2D, canvas: HTMLCanvasElement, tree: SkillNode) {
    const centerX = canvas.width / 2;
    const centerY = canvas.height / 2;

    // æ¸…é™¤ç•«å¸ƒ
    ctx.fillStyle = 'rgba(10, 14, 39, 0.9)';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // è¨ˆç®—ç¯€é»ä½ç½®
    calculatePositions(tree, centerX, centerY, 0, Math.PI * 2, 150);

    // ç¹ªè£½é€£ç·š
    drawConnections(ctx, tree);

    // ç¹ªè£½ç¯€é»
    drawNodes(ctx, tree);
  }

  function calculatePositions(
    node: SkillNode,
    x: number,
    y: number,
    startAngle: number,
    endAngle: number,
    radius: number
  ) {
    node.x = x;
    node.y = y;
    node.radius = 20 + node.level * 5;

    if (!node.children || node.children.length === 0) return;

    const angleStep = (endAngle - startAngle) / node.children.length;

    node.children.forEach((child, i) => {
      const angle = startAngle + angleStep * (i + 0.5);
      const childX = x + Math.cos(angle) * radius;
      const childY = y + Math.sin(angle) * radius;

      calculatePositions(
        child,
        childX,
        childY,
        angle - angleStep / 2,
        angle + angleStep / 2,
        radius * 0.7
      );
    });
  }

  function drawConnections(ctx: CanvasRenderingContext2D, node: SkillNode) {
    if (!node.children) return;

    node.children.forEach((child) => {
      if (node.x !== undefined && node.y !== undefined && child.x !== undefined && child.y !== undefined) {
        ctx.beginPath();
        ctx.moveTo(node.x, node.y);
        ctx.lineTo(child.x, child.y);
        ctx.strokeStyle = 'rgba(255, 215, 0, 0.3)';
        ctx.lineWidth = 2;
        ctx.stroke();

        drawConnections(ctx, child);
      }
    });
  }

  function drawNodes(ctx: CanvasRenderingContext2D, node: SkillNode) {
    if (node.x === undefined || node.y === undefined || node.radius === undefined) return;

    // ç¹ªè£½ç¯€é»èƒŒæ™¯
    ctx.beginPath();
    ctx.arc(node.x, node.y, node.radius, 0, Math.PI * 2);
    ctx.fillStyle = node.color;
    ctx.fill();

    // ç¹ªè£½é‚Šæ¡†
    ctx.strokeStyle = '#ffd700';
    ctx.lineWidth = 2;
    ctx.stroke();

    // ç¹ªè£½æ–‡å­—
    ctx.fillStyle = '#fff';
    ctx.font = `${Math.max(10, node.radius / 2)}px Arial`;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';

    const name = node.name.length > 6 ? node.name.substring(0, 5) + '...' : node.name;
    ctx.fillText(name, node.x, node.y);

    // ç¹ªè£½ç­‰ç´š
    ctx.font = '10px Arial';
    ctx.fillText(`Lv.${node.level}`, node.x, node.y + node.radius + 12);

    // ç¹ªè£½å­ç¯€é»
    if (node.children) {
      node.children.forEach((child) => drawNodes(ctx, child));
    }
  }

  function setupInteractions(
    canvas: HTMLCanvasElement,
    ctx: CanvasRenderingContext2D,
    tree: SkillNode
  ) {
    const detailsPanel = document.getElementById('skill-details-panel');
    const closeBtn = document.getElementById('close-skill-details');

    // é»æ“Šäº‹ä»¶
    canvas.addEventListener('click', (e) => {
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      const clickedNode = findNodeAtPosition(tree, x, y);
      if (clickedNode && detailsPanel) {
        showSkillDetails(clickedNode);
      }
    });

    // é—œé–‰è©³æƒ…é¢æ¿
    closeBtn?.addEventListener('click', () => {
      if (detailsPanel) detailsPanel.style.display = 'none';
    });

    // æ»‘é¼ ç§»å‹•äº‹ä»¶ï¼ˆé«˜äº®æ•ˆæœï¼‰
    canvas.addEventListener('mousemove', (e) => {
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      const hoveredNode = findNodeAtPosition(tree, x, y);
      canvas.style.cursor = hoveredNode ? 'pointer' : 'grab';
    });
  }

  function findNodeAtPosition(node: SkillNode, x: number, y: number): SkillNode | null {
    if (node.x !== undefined && node.y !== undefined && node.radius !== undefined) {
      const distance = Math.sqrt(Math.pow(x - node.x, 2) + Math.pow(y - node.y, 2));
      if (distance <= node.radius) {
        return node;
      }
    }

    if (node.children) {
      for (const child of node.children) {
        const found = findNodeAtPosition(child, x, y);
        if (found) return found;
      }
    }

    return null;
  }

  function showSkillDetails(node: SkillNode) {
    const panel = document.getElementById('skill-details-panel');
    const nameEl = document.getElementById('skill-name');
    const descEl = document.getElementById('skill-description');
    const levelEl = document.getElementById('skill-level');
    const iconEl = document.getElementById('skill-icon');

    if (!panel || !nameEl || !descEl || !levelEl || !iconEl) return;

    nameEl.textContent = node.name;
    descEl.textContent = `é€™æ˜¯ ${node.name} æŠ€èƒ½çš„è©³ç´°èªªæ˜ã€‚`;
    levelEl.textContent = `ç­‰ç´š: ${node.level}/5`;
    iconEl.style.backgroundColor = node.color;

    panel.style.display = 'block';
  }
</script>

<style>
  .skills-panel {
    padding: 1rem;
  }

  .panel-title {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: #ffd700;
    font-size: 1.25rem;
    margin: 0 0 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid rgba(255, 215, 0, 0.3);
  }

  .skill-tree-wrapper {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .skill-tree-container {
    position: relative;
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 215, 0, 0.2);
    border-radius: 8px;
    overflow: hidden;
  }

  #skill-tree-canvas {
    display: block;
    width: 100%;
    height: 500px;
  }

  .zoom-controls {
    position: absolute;
    top: 1rem;
    right: 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .zoom-btn {
    width: 36px;
    height: 36px;
    background: rgba(0, 0, 0, 0.6);
    border: 1px solid rgba(255, 215, 0, 0.3);
    border-radius: 4px;
    color: #ffd700;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .zoom-btn:hover {
    background: rgba(255, 215, 0, 0.2);
    border-color: #ffd700;
  }

  .skill-details-panel {
    position: absolute;
    top: 1rem;
    left: 1rem;
    width: 250px;
    padding: 1rem;
    background: rgba(10, 14, 39, 0.95);
    border: 2px solid #ffd700;
    border-radius: 8px;
    z-index: 10;
  }

  .close-btn {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    width: 24px;
    height: 24px;
    background: transparent;
    border: none;
    color: #888;
    cursor: pointer;
    transition: color 0.2s;
  }

  .close-btn:hover {
    color: #ffd700;
  }

  .skill-icon {
    width: 60px;
    height: 60px;
    margin: 0 auto 1rem;
    border-radius: 50%;
    border: 3px solid #ffd700;
  }

  .skill-name {
    text-align: center;
    color: #ffd700;
    margin: 0 0 0.5rem;
  }

  .skill-description {
    color: #b0b0b0;
    font-size: 0.9rem;
    line-height: 1.5;
    margin: 0 0 1rem;
  }

  .skill-meta {
    display: flex;
    justify-content: space-between;
    font-size: 0.8rem;
    color: #888;
  }

  .skill-tree-hint {
    text-align: center;
    color: #888;
    font-size: 0.85rem;
    margin: 0;
  }

  .skill-tree-hint i {
    margin-right: 0.4rem;
  }

  @media (max-width: 768px) {
    #skill-tree-canvas {
      height: 350px;
    }

    .skill-details-panel {
      width: calc(100% - 2rem);
      left: 1rem;
      right: 1rem;
    }
  }
</style>
