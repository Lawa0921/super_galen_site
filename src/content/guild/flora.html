<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flora 芙老師 | 豐饒甜食店</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Noto+Serif+TC:wght@300;400;700&display=swap" rel="stylesheet">
    <!-- Updated to 6.5.1 for Threads Icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        :root {
            /* Palette Refresh: Cream & Matcha (Light Theme) */
            --c-bg: #F9F7F2; /* Warm Vanilla Paper */
            --c-bg-transparent: rgba(255, 255, 255, 0.65); /* Frosted Glass */
            --c-text: #5D4037; /* Dark Roast Coffee */
            --c-text-light: #8D6E63; /* Milk Coffee */

            --c-brand: #78866B; /* Sage Green (Muted Olive) */
            --c-accent: #A4C639; /* Fresh Matcha (Highlights) */
            --c-warm: #D4A373; /* Caramel / Gold */
            --c-berry: #C27867; /* Dried Berry (Pop color) */

            --font-display: 'Cinzel', serif;
            --font-body: 'Noto Serif TC', serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: var(--c-bg);
            color: var(--c-text);
            font-family: var(--font-body);
            overflow-x: hidden;
            opacity: 0;
            transition: opacity 1s ease;
            cursor: crosshair;
        }

        /* Selection Color */
        ::selection {
            background: var(--c-brand);
            color: white;
        }

        /* Custom "Whisk" Cursor Effect */
        #custom-cursor-follower {
            position: fixed;
            top: 0; left: 0;
            pointer-events: none;
            font-size: 24px;
            z-index: 9999;
            transform: translate(-50%, -50%);
            opacity: 0;
            transition: opacity 0.2s;
            mix-blend-mode: multiply; /* Better for light bg */
            color: var(--c-brand);
        }

        body:hover #custom-cursor-follower {
            opacity: 1;
        }

        body.loaded {
            opacity: 1;
        }

        /* Scroll Progress Bar (Piping Bag) */
        #piping-progress {
            position: fixed;
            top: 0; left: 0;
            height: 6px;
            background: linear-gradient(90deg, var(--c-brand), var(--c-warm));
            width: 0%;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(120, 134, 107, 0.3);
            border-radius: 0 4px 4px 0;
        }

        #canvas-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: -1;
        }

        main {
            position: relative;
            z-index: 1;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        section {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 6rem 0;
            position: relative;
        }

        /* Typography */
        h1, h2, h3, h4 {
            font-family: var(--font-display);
            font-weight: 700;
            line-height: 1.1;
        }

        h1 {
            font-size: clamp(3.5rem, 10vw, 7rem);
            color: var(--c-brand);
            text-align: center;
            margin-bottom: 0.5rem;
            /* Softer shadow for light theme */
            text-shadow: 2px 2px 0px rgba(164, 198, 57, 0.2);
            position: relative;
            display: inline-block;
        }

        h2 {
            font-size: clamp(2rem, 5vw, 4rem);
            margin-bottom: 3rem;
            color: var(--c-brand);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            text-align: center;
            position: relative;
        }

        h2::after {
            content: '';
            display: block;
            width: 60px;
            height: 3px;
            background: var(--c-warm);
            margin: 1rem auto 0;
        }

        h3 {
            font-size: 1.5rem;
            color: var(--c-text);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        p {
            font-size: 1.15rem;
            line-height: 2;
            margin-bottom: 1.5rem;
            color: var(--c-text-light);
            font-weight: 400;
        }

        .highlight {
            color: var(--c-berry);
            font-weight: 700;
            background: linear-gradient(120deg, rgba(194, 120, 103, 0.1) 0%, rgba(194, 120, 103, 0) 100%);
            padding: 0 4px;
        }

        /* Layout Utilities */
        .glass-panel {
            background: var(--c-bg-transparent);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            padding: 3rem;
            border-radius: 20px;
            /* Soft, paper-like shadow */
            box-shadow: 0 20px 60px rgba(93, 64, 55, 0.08), inset 0 0 0 1px rgba(255,255,255,0.5);
            margin-bottom: 4rem;
            transform: translateY(50px);
            opacity: 0;
            position: relative;
            overflow: hidden;
        }

        .glass-panel::before {
            content: '';
            position: absolute;
            top: 0; left: 0; width: 100%; height: 6px;
            background: repeating-linear-gradient(
                45deg,
                var(--c-brand),
                var(--c-brand) 10px,
                var(--c-bg) 10px,
                var(--c-bg) 20px
            );
            opacity: 0.5;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 4rem;
            align-items: center;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
        }

        @media (max-width: 900px) {
            .grid-2 { grid-template-columns: 1fr; gap: 2rem; }
        }

        /* Hero Specifics */
        .avatar-frame {
            width: 280px;
            height: 280px;
            border-radius: 50%;
            margin: 0 auto 2rem;
            padding: 8px;
            border: 2px dashed var(--c-brand);
            position: relative;
            background: white;
        }

        .avatar-frame img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid var(--c-bg);
            box-shadow: 0 10px 30px rgba(93, 64, 55, 0.15);
        }

        .hero-tagline {
            font-size: 1.2rem;
            letter-spacing: 0.3em;
            text-transform: uppercase;
            color: var(--c-text-light);
            margin-bottom: 2rem;
            text-align: center;
            font-weight: 700;
        }

        /* Stats Section */
        .stat-row {
            margin-bottom: 1.5rem;
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-family: var(--font-display);
            color: var(--c-brand);
            font-weight: 700;
        }

        .stat-bar-bg {
            width: 100%;
            height: 8px;
            background: rgba(93, 64, 55, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .stat-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--c-brand), var(--c-warm));
            width: 0%;
        }

        /* Services / Alchemy */
        .alchemy-card {
            background: rgba(255,255,255,0.6);
            padding: 2rem;
            border-radius: 12px;
            border: 1px solid rgba(120, 134, 107, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .alchemy-card:hover {
            transform: translateY(-8px);
            background: white;
            box-shadow: 0 15px 30px rgba(93, 64, 55, 0.08);
            border-color: var(--c-warm);
        }

        .alchemy-icon {
            font-size: 2.5rem;
            color: var(--c-brand);
            margin-bottom: 1rem;
        }

        /* Gallery */
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            grid-auto-rows: 250px;
            gap: 1.5rem;
        }

        .g-item {
            position: relative;
            overflow: hidden;
            border-radius: 12px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.05);
            cursor: pointer;
            background: white;
            padding: 10px; /* Polaroid style frame */
        }

        .g-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 4px;
            transition: transform 0.6s cubic-bezier(0.2, 1, 0.3, 1);
        }

        .g-item:hover img {
            transform: scale(1.05);
        }

        .g-1 { grid-column: span 6; }
        .g-2 { grid-column: span 6; }
        .g-3 { grid-column: span 4; }
        .g-4 { grid-column: span 8; }

        @media (max-width: 768px) {
            .g-1, .g-2, .g-3, .g-4 { grid-column: span 12; }
        }

        /* Footer */
        .social-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: white;
            border: 2px solid var(--c-brand);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: var(--c-brand);
            text-decoration: none;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

        .social-circle::before {
            content: '';
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--c-brand);
            transform: scale(0);
            transition: transform 0.3s ease;
            z-index: 1; /* Under icon but above bg */
            border-radius: 50%;
        }

        .social-circle i {
            position: relative;
            z-index: 2;
            transition: color 0.3s;
        }

        .social-circle:hover {
            border-color: var(--c-brand);
        }

        .social-circle:hover i {
            color: white;
        }

        .social-circle:hover::before {
            transform: scale(1);
        }

        /* Loader */
        #loader {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--c-bg);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            transition: opacity 0.8s ease;
        }

        .spinner {
            font-size: 3rem;
            color: var(--c-brand);
            animation: spin 2s cubic-bezier(0.68, -0.55, 0.27, 1.55) infinite; /* Jelly Spin */
        }

        @keyframes spin { 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <div id="piping-progress"></div>
    <div id="custom-cursor-follower"><i class="fa-solid fa-wand-magic-sparkles"></i></div>

    <div id="loader">
        <i class="fa-solid fa-cookie-bite spinner"></i>
        <div style="margin-top: 1rem; font-family: var(--font-display); color: var(--c-text-light); letter-spacing: 2px;">FLORA'S PATISSERIE</div>
    </div>

    <div id="canvas-container"></div>

    <main>
        <!-- HERO -->
        <section id="hero">
            <div style="text-align: center;">
                <div class="avatar-frame">
                    <img src="/assets/img/guild/flora/profile.webp" alt="Flora">
                </div>
                <div class="hero-tagline">丰饶甜食店 | Est. 17 Years</div>
                <h1>Flora 芙老師</h1>
                <p style="max-width: 600px; margin: 2rem auto; font-style: italic; border-left: 3px solid var(--c-brand); padding-left: 1rem; text-align: left; background: rgba(255,255,255,0.4); padding: 1.5rem; border-radius: 0 10px 10px 0;">
                    "甜點是通往幸福的最短途徑，是連結人、土地與情感的最佳入口。"
                </p>
                <div style="margin-top: 2rem;">
                     <i class="fa-solid fa-angles-down" style="font-size: 2rem; color: var(--c-text-light); animation: bounce 2s infinite;"></i>
                </div>
            </div>
        </section>

        <!-- INTRO & STATS -->
        <section id="intro">
            <div class="glass-panel">
                <div class="grid-2">
                    <div>
                        <h2><i class="fa-solid fa-seedling" style="font-size: 0.8em; margin-right: 10px; color: var(--c-brand);"></i> Master Chef</h2>
                        <p>
                            我是 <span class="highlight">Flora 芙老師</span>，品牌是豐饒甜食店。
                            在甜點領域深耕 17 年，從台灣到海外，走過教學、研發、品牌經營三條戰線。
                        </p>
                        <p>
                            教學對象橫跨幼兒園、國高中到成人職訓，也曾在馬來西亞與印度用英文授課，把甜點變成一種跨文化的共同語言。
                        </p>
                    </div>
                    <div>
                        <!-- RPG STATS -->
                        <div class="stat-row">
                            <div class="stat-header"><span>SWEETNESS</span> <span>100%</span></div>
                            <div class="stat-bar-bg"><div class="stat-bar-fill" data-width="100%"></div></div>
                        </div>
                        <div class="stat-row">
                            <div class="stat-header"><span>PRECISION (R&D)</span> <span>98%</span></div>
                            <div class="stat-bar-bg"><div class="stat-bar-fill" data-width="98%"></div></div>
                        </div>
                        <div class="stat-row">
                            <div class="stat-header"><span>TEACHING</span> <span>95%</span></div>
                            <div class="stat-bar-bg"><div class="stat-bar-fill" data-width="95%"></div></div>
                        </div>
                        <div class="stat-row">
                            <div class="stat-header"><span>CULTURE LINK</span> <span>99%</span></div>
                            <div class="stat-bar-bg"><div class="stat-bar-fill" data-width="99%"></div></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- ALCHEMY / SERVICES -->
        <section id="alchemy">
            <h2><i class="fa-solid fa-mortar-pestle" style="font-size: 0.8em; margin-right: 15px;"></i> The Sweet Alchemy</h2>
            <div class="grid-3">
                <div class="alchemy-card">
                    <div class="alchemy-icon"><i class="fa-solid fa-utensils"></i></div>
                    <h3>Product 產品</h3>
                    <p>從菜單設計、成本結構到定價邏輯。打造不僅美味，更具備商業生存能力的甜點產品線。</p>
                </div>
                <div class="alchemy-card">
                    <div class="alchemy-icon"><i class="fa-solid fa-chalkboard-user"></i></div>
                    <h3>Education 教育</h3>
                    <p>課程模組化設計。將複雜的甜點工藝拆解為系統化知識，跨越年齡與國界的專業教學。</p>
                </div>
                <div class="alchemy-card">
                    <div class="alchemy-icon"><i class="fa-solid fa-book-open-reader"></i></div>
                    <h3>Culture 文化</h3>
                    <p>融入永續與在地議題。用企業經營的角度操作甜點，讓產品成為連結土地情感的載體。</p>
                </div>
            </div>
        </section>

        <!-- STORY -->
        <section id="story">
            <div class="glass-panel" style="text-align: center; border-color: var(--c-warm);">
                <i class="fa-solid fa-earth-asia" style="font-size: 3rem; color: var(--c-brand); margin-bottom: 2rem;"></i>
                <h2>台灣的故事</h2>
                <p style="max-width: 800px; margin: 0 auto; font-size: 1.3rem; color: var(--c-text);">
                    現在，我聚焦在用甜點說出台灣的故事。<br>
                    把<span class="highlight">海洋、土地、文化、教育</span>放進產品裡。
                </p>
                <div style="margin: 3rem auto; height: 1px; background: rgba(93, 64, 55, 0.1); width: 100px;"></div>
                <p>
                    讓每一份甜點不只是商品，而是一個可以被理解、被記住、也被分享的價值載體。
                </p>
            </div>
        </section>

        <!-- GALLERY -->
        <section id="gallery">
            <h2 style="margin-bottom: 4rem;">Showcase</h2>
            <div class="gallery-grid">
                <div class="g-item g-1"><img src="/assets/img/guild/flora/showcase_tree.webp" alt="Tree"></div>
                <div class="g-item g-2"><img src="/assets/img/guild/flora/showcase_slice.webp" alt="Slice"></div>
                <div class="g-item g-4"><img src="/assets/img/guild/flora/showcase_floral.webp" alt="Floral"></div>
                <div class="g-item g-3"><img src="/assets/img/guild/flora/showcase_cupcake.webp" alt="Cupcake"></div>
            </div>
        </section>

        <!-- FOOTER -->
        <section id="footer" style="min-height: 50vh; justify-content: flex-end; padding-bottom: 4rem;">
            <div style="text-align: center;">
                <h2 style="font-size: 2rem; color: var(--c-text);">Connect with Flora</h2>
                <div class="social-links" style="display: flex; justify-content: center; gap: 2rem; margin: 3rem 0;">
                    <a href="https://www.threads.com/@flora_setsuna_tw" target="_blank" class="social-circle" aria-label="Threads">
                        <i class="fa-brands fa-threads"></i>
                    </a>
                    <a href="https://www.facebook.com/FlowGateau" target="_blank" class="social-circle" aria-label="Facebook">
                        <i class="fa-brands fa-facebook-f"></i>
                    </a>
                </div>
                <p style="opacity: 0.5; font-size: 0.9rem;">
                    Made with love by SuperGalen's Dungeon
                </p>
            </div>
        </section>

    </main>

    <!-- IMPORT MAP -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <!-- LIBRARIES -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.4/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.4/ScrollTrigger.min.js"></script>

    <style>
        @keyframes bounce { 0%, 20%, 50%, 80%, 100% {transform: translateY(0);} 40% {transform: translateY(-10px);} 60% {transform: translateY(-5px);} }
    </style>

    <!-- SCRIPT INJECTION POINT -->
    <script type="module">
        import * as THREE from 'three';

        // --- GSAP INIT ---
        gsap.registerPlugin(ScrollTrigger);

        // --- THREE.JS SCENE SETUP ---
        const container = document.getElementById('canvas-container');
        const scene = new THREE.Scene();
        // Light Cream Fog for Paper aesthetic
        scene.fog = new THREE.FogExp2(0xF9F7F2, 0.02);
        //scene.background = new THREE.Color(0xF9F7F2); // Let CSS handle BG, use alpha for renderer

        const camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.1, 100);
        camera.position.z = 10;

        const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        container.appendChild(renderer.domElement);

        // --- HELPER: TEXT TO TEXTURE ---
        function createIconTexture(iconChar, color) {
            const canvas = document.createElement('canvas');
            canvas.width = 128;
            canvas.height = 128;
            const ctx = canvas.getContext('2d');

            ctx.font = '900 80px "Font Awesome 6 Free"';
            ctx.fillStyle = color;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';

            ctx.fillText(iconChar, 64, 64);

            const tex = new THREE.CanvasTexture(canvas);
            return tex;
        }

        // --- CREATE ICONS (Pastry Palette) ---
        const icons = [
            { char: '\uf1fd', color: '#78866B' }, // Cake (Sage)
            { char: '\uf810', color: '#D4A373' }, // Cupcake (Caramel)
            { char: '\uf563', color: '#8D6E63' }, // Cookie (Cocoa)
            { char: '\uf094', color: '#A4C639' }, // Lemon (Matcha)
            { char: '\uf179', color: '#C27867' }, // Apple (Berry)
            { char: '\uf02d', color: '#78866B' }, // Book (Sage)
        ];

        const sprites = [];
        const group = new THREE.Group();
        scene.add(group);

        document.fonts.ready.then(() => {
            const materials = icons.map(icon => {
                const map = createIconTexture(icon.char, icon.color);
                return new THREE.SpriteMaterial({ map: map, transparent: true, opacity: 0.9 });
            });

            for (let i = 0; i < 70; i++) { // Slightly more density for pop
                const matIndex = Math.floor(Math.random() * materials.length);
                const sprite = new THREE.Sprite(materials[matIndex]);

                sprite.position.set(
                    (Math.random() - 0.5) * 25,
                    (Math.random() - 0.5) * 35,
                    (Math.random() - 0.5) * 15
                );

                const scale = Math.random() * 0.7 + 0.4;
                sprite.scale.set(scale, scale, 1);

                sprite.userData = {
                    floatSpeed: (Math.random() * 0.01) + 0.005,
                    floatOffset: Math.random() * Math.PI * 2,
                    initialY: sprite.position.y,
                    initialX: sprite.position.x
                };

                group.add(sprite);
                sprites.push(sprite);
            }
        });

        // --- PARTICLE SYSTEM (CONFETTI BURST) ---
        const particleCount = 150;
        const particleGeo = new THREE.BufferGeometry();
        const particlePositions = new Float32Array(particleCount * 3);
        const particleColors = new Float32Array(particleCount * 3);
        const particleVelocities = [];
        const particleLife = new Float32Array(particleCount);

        particleGeo.setAttribute('position', new THREE.BufferAttribute(particlePositions, 3));
        particleGeo.setAttribute('color', new THREE.BufferAttribute(particleColors, 3));

        const particleMat = new THREE.PointsMaterial({
            size: 0.15,
            vertexColors: true,
            transparent: true,
            opacity: 0
        });

        const particleSystem = new THREE.Points(particleGeo, particleMat);
        scene.add(particleSystem);

        const paletteColors = [
            new THREE.Color('#78866B'),
            new THREE.Color('#D4A373'),
            new THREE.Color('#C27867'),
            new THREE.Color('#A4C639')
        ];

        for(let i=0; i<particleCount; i++) {
            particleLife[i] = 0;
            particleVelocities.push(new THREE.Vector3());
        }

        function triggerBurst(x, y, z) {
            let activeCount = 0;
            for(let i=0; i<particleCount; i++) {
                if(particleLife[i] <= 0 && activeCount < 25) {
                    particleLife[i] = 1.0;

                    particlePositions[i*3] = x;
                    particlePositions[i*3+1] = y;
                    particlePositions[i*3+2] = z;

                    // Random color from palette
                    const col = paletteColors[Math.floor(Math.random() * paletteColors.length)];
                    particleColors[i*3] = col.r;
                    particleColors[i*3+1] = col.g;
                    particleColors[i*3+2] = col.b;

                    const theta = Math.random() * Math.PI * 2;
                    const phi = Math.random() * Math.PI;
                    const speed = Math.random() * 0.2 + 0.1;

                    particleVelocities[i].set(
                        Math.sin(phi) * Math.cos(theta) * speed,
                        Math.sin(phi) * Math.sin(theta) * speed,
                        Math.cos(phi) * speed
                    );

                    activeCount++;
                }
            }
            particleSystem.geometry.attributes.position.needsUpdate = true;
            particleSystem.geometry.attributes.color.needsUpdate = true;
        }

        // --- ANIMATION LOOP ---
        const mouse = new THREE.Vector2();
        const clock = new THREE.Clock();

        function animate() {
            const time = clock.getElapsedTime();

            // 1. Sprite Physics
            const vector = new THREE.Vector3(mouse.x, mouse.y, 0.5);
            vector.unproject(camera);
            const dir = vector.sub(camera.position).normalize();
            const distance = -camera.position.z / dir.z;
            const worldMouse = camera.position.clone().add(dir.multiplyScalar(distance));

            sprites.forEach(sprite => {
                const baseY = sprite.userData.initialY + Math.sin(time + sprite.userData.floatOffset) * 0.5;

                // Gentle sway
                sprite.position.x = THREE.MathUtils.lerp(sprite.position.x, sprite.userData.initialX + Math.cos(time * 0.5 + sprite.userData.floatOffset) * 0.5, 0.05);

                // Mouse interaction
                const dx = sprite.position.x - worldMouse.x * 10;
                const dy = sprite.position.y - worldMouse.y * 10;
                const dist = Math.sqrt(dx*dx + dy*dy);

                if(dist < 4) {
                    const force = (4 - dist) * 0.8;
                    sprite.position.x += dx * force * 0.05;
                    sprite.position.y += dy * force * 0.05;
                    sprite.scale.x = THREE.MathUtils.lerp(sprite.scale.x, 1.2, 0.1);
                    sprite.scale.y = THREE.MathUtils.lerp(sprite.scale.y, 1.2, 0.1);
                } else {
                    // Normalize scale
                    sprite.scale.x = THREE.MathUtils.lerp(sprite.scale.x, sprite.scale.x > 0.8 ? 0.6 : sprite.scale.x, 0.1);
                    sprite.scale.y = THREE.MathUtils.lerp(sprite.scale.y, sprite.scale.y > 0.8 ? 0.6 : sprite.scale.y, 0.1);
                }

                sprite.position.y = THREE.MathUtils.lerp(sprite.position.y, baseY, 0.1);
            });

            // 2. Particles
            const positions = particleSystem.geometry.attributes.position.array;
            let activeParticles = false;

            for(let i=0; i<particleCount; i++) {
                if(particleLife[i] > 0) {
                    activeParticles = true;
                    particleLife[i] -= 0.015;

                    positions[i*3] += particleVelocities[i].x;
                    positions[i*3+1] += particleVelocities[i].y;
                    positions[i*3+2] += particleVelocities[i].z;

                    particleVelocities[i].y -= 0.003; // Light gravity
                    particleVelocities[i].x *= 0.98; // Drag
                    particleVelocities[i].z *= 0.98;
                } else {
                    positions[i*3] = 9999;
                }
            }
            if(activeParticles) {
                particleSystem.geometry.attributes.position.needsUpdate = true;
                particleMat.opacity = 1;
            } else {
                particleMat.opacity = 0;
            }

            // 3. Camera/Group Parallax
            group.rotation.y = THREE.MathUtils.lerp(group.rotation.y, mouse.x * 0.1, 0.05);
            group.rotation.x = THREE.MathUtils.lerp(group.rotation.x, mouse.y * 0.05, 0.05);

            renderer.render(scene, camera);
            requestAnimationFrame(animate);
        }
        animate();

        // --- EVENTS ---
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        window.addEventListener('mousemove', (e) => {
            mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;

            const cursor = document.getElementById('custom-cursor-follower');
            if(cursor) {
                gsap.to(cursor, {x: e.clientX, y: e.clientY, duration: 0.1});
            }
        });

        window.addEventListener('click', (e) => {
            const vec = new THREE.Vector3(mouse.x, mouse.y, 0.5);
            vec.unproject(camera);
            const dir = vec.sub(camera.position).normalize();
            const pos = camera.position.clone().add(dir.multiplyScalar(8));

            triggerBurst(pos.x, pos.y, pos.z);

            // Pop nearby sprites
            sprites.forEach(sprite => {
                if(sprite.position.distanceTo(pos) < 6) {
                    gsap.to(sprite.scale, { x: 1.0, y: 1.0, duration: 0.15, yoyo: true, repeat: 1 });
                    sprite.userData.floatOffset += Math.PI / 2;
                }
            });
        });

        // --- SCROLL ANIMATIONS ---

        gsap.to("#piping-progress", {
            width: "100%",
            ease: "none",
            scrollTrigger: {
                trigger: "body",
                start: "top top",
                end: "bottom bottom",
                scrub: 0.3
            }
        });

        gsap.utils.toArray('.glass-panel').forEach(panel => {
            gsap.fromTo(panel,
                { opacity: 0, y: 60 },
                {
                    opacity: 1,
                    y: 0,
                    duration: 1.2,
                    ease: "power3.out",
                    scrollTrigger: {
                        trigger: panel,
                        start: "top 85%"
                    }
                }
            );
        });

        gsap.utils.toArray('.stat-bar-fill').forEach(bar => {
            gsap.to(bar, {
                width: bar.getAttribute('data-width'),
                duration: 1.5,
                ease: "power2.out",
                scrollTrigger: {
                    trigger: bar,
                    start: "top 90%"
                }
            });
        });

        gsap.from('.alchemy-card', {
            y: 50,
            opacity: 0,
            stagger: 0.1,
            duration: 0.8,
            ease: "back.out(1.7)",
            scrollTrigger: {
                trigger: '.grid-3',
                start: "top 80%"
            }
        });

        gsap.from('.g-item', {
            scale: 0.9,
            opacity: 0,
            rotation: 5,
            stagger: 0.1,
            duration: 0.8,
            scrollTrigger: {
                trigger: '.gallery-grid',
                start: "top 80%"
            }
        });

        // Deep Dive Camera
        gsap.to(camera.position, {
            z: 4,
            y: -15,
            scrollTrigger: {
                trigger: 'body',
                start: "top top",
                end: "bottom bottom",
                scrub: 1
            }
        });

        // --- PAGE LOAD ---
        window.addEventListener('load', () => {
            document.body.classList.add('loaded');
            const loader = document.getElementById('loader');
            if(loader) {
                gsap.to(loader, { opacity: 0, duration: 0.8, onComplete: () => loader.remove() });
            }
        });

    </script>
</body>
</html>