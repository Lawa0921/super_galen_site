<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Liloyee | æ·±æµ·çš„å¤¢å¢ƒäººé­š</title>
    <meta name="description" content="Liloyee çš„å¤¢å¢ƒæª”æ¡ˆ - æ•¸å­¸ã€å¯«ä½œèˆ‡æ·±æµ·çš„å¹¸é‹å¯¶è—ã€‚">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Zen+Maru+Gothic:wght@400;700&family=Noto+Serif+TC:wght@400;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        :root {
            --c-deep: #001e36;
            --c-water: #006994;
            --c-accent: #00f3ff;
            --c-pink: #ff9aa2;
            --c-gold: #ffd700;
            --f-title: 'Cinzel', serif;
            --f-body: 'Zen Maru Gothic', sans-serif;
            --f-serif: 'Noto Serif TC', serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background-color: var(--c-deep);
            color: white;
            font-family: var(--f-body);
            overflow-x: hidden;
            width: 100%;
        }

        /* --- THREE.JS CANVAS --- */
        #canvas-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            transition: opacity 2s;
            opacity: 0;
        }

        /* --- UI LAYOUT --- */
        main {
            position: relative;
            z-index: 10;
        }

        section {
            position: relative;
            min-height: 100vh;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            padding: 2rem;
            pointer-events: none; /* Pass through to canvas */
        }

        .content-box {
            pointer-events: auto;
            max-width: 800px;
            width: 100%;
            padding: 2rem;
            background: rgba(0, 30, 54, 0.4);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            box-shadow: 0 0 30px rgba(0, 243, 255, 0.1);
            text-align: center;
            transform: translateY(50px);
            opacity: 0;
            transition: transform 1s, opacity 1s;
        }

        .content-box.visible {
            transform: translateY(0);
            opacity: 1;
        }

        h1 {
            font-family: var(--f-title);
            font-size: 8vw;
            background: linear-gradient(to bottom, #fff, var(--c-accent));
            -webkit-background-clip: text;
            color: transparent;
            text-shadow: 0 0 30px var(--c-accent);
            margin-bottom: 1rem;
        }

        h2 {
            font-family: var(--f-serif);
            font-size: 2.5rem;
            color: var(--c-accent);
            margin-bottom: 1.5rem;
        }

        p {
            font-size: 1.1rem;
            line-height: 1.8;
            margin-bottom: 1.5rem;
            color: #e0f7fa;
        }

        .tag {
            display: inline-block;
            padding: 5px 15px;
            border: 1px solid var(--c-accent);
            color: var(--c-accent);
            border-radius: 50px;
            font-size: 0.9rem;
            margin: 0 5px;
        }

        /* --- STORY LOG SECTION --- */
        #story-log {
            padding: 4rem 2rem;
            display: flex; flex-direction: column; gap: 4rem;
            align-items: center;
            pointer-events: none;
        }
        .story-card {
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.1), rgba(0, 30, 54, 0.8));
            backdrop-filter: blur(10px);
            border: 1px solid var(--c-accent);
            padding: 4rem;
            border-radius: 50%;
            aspect-ratio: 1;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            max-width: 400px;
            width: 100%;
            text-align: center;
            box-shadow: inset 0 0 30px rgba(255,255,255,0.2), 0 0 20px rgba(0, 243, 255, 0.2);
            opacity: 0;
            transform: translateY(50px) scale(0.9);
            transition: transform 0.3s;
            pointer-events: auto;
        }
        .story-card:hover {
            transform: translateY(0) scale(1.05) !important; /* Override GSAP slightly on hover */
            box-shadow: inset 0 0 50px rgba(255,255,255,0.4), 0 0 40px rgba(0, 243, 255, 0.4);
        }
        .story-card h3 { color: var(--c-accent); margin-bottom: 1rem; font-family: var(--f-title); }
        .story-card p { color: #fff; font-size: 1.1rem; }

        /* --- BUBBLE GALLERY SECTION --- */
        #bubble-zone {
            height: 350vh; /* Extended for more content */
            position: relative;
            overflow: hidden;
            pointer-events: none;
        }

        .bubble-container {
            position: absolute;
            border-radius: 50%;
            cursor: pointer;
            pointer-events: auto;
            display: flex; justify-content: center; align-items: center;
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.2), rgba(255,255,255,0.05) 60%, rgba(255,255,255,0) 70%);
            box-shadow: inset 0 0 20px rgba(255,255,255,0.3), 0 0 10px rgba(255,255,255,0.1);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.3);
            transition: transform 0.3s;
            will-change: transform;
            overflow: hidden;
            z-index: 15;
        }

        .bubble-container:hover {
            transform: scale(1.1);
            box-shadow: inset 0 0 30px rgba(255,255,255,0.5), 0 0 20px rgba(0,243,255,0.4);
        }

        .bubble-container img {
            width: 100%; height: 100%; object-fit: cover;
            opacity: 0.6;
            transition: 0.5s;
            transform: scale(1.1);
            filter: blur(2px);
        }

        .bubble-container:hover img {
            opacity: 1;
            filter: blur(0);
        }

        .bubble-label {
            position: absolute;
            color: white;
            font-family: var(--f-title);
            text-shadow: 0 0 5px black;
            font-weight: bold;
            pointer-events: none;
            opacity: 0.8;
            z-index: 2;
        }

        /* --- FLOATING SEA CREATURES --- */
        .sea-creature {
            position: absolute;
            font-size: 2rem;
            color: rgba(0, 243, 255, 0.3);
            pointer-events: none;
            z-index: 5;
            filter: blur(1px);
        }

        /* SWIMMING MERMAID GUIDE (Side scrolling) */
        .mermaid-guide {
            position: fixed;
            top: 20%; right: 5%;
            width: 100px; height: 100px;
            border-radius: 50%;
            background: rgba(0, 30, 54, 0.8);
            backdrop-filter: blur(5px);
            border: 3px solid var(--c-accent);
            box-shadow: 0 0 20px var(--c-accent);
            z-index: 999; /* Increased z-index */
            opacity: 1; /* Always visible */
            pointer-events: none;
            display: flex; justify-content: center; align-items: center;
            color: var(--c-accent);
            font-size: 3rem;
        }
        .mermaid-guide::after {
            content: 'Follow Me!';
            position: absolute; bottom: -25px; left: 50%; transform: translateX(-50%);
            white-space: nowrap;
            font-family: var(--f-title);
            color: var(--c-accent);
            font-size: 0.8rem;
            text-shadow: 0 0 5px black;
        }

        /* --- SAND & FOOTER --- */
        #sand-section {
            height: 50vh;
            display: flex; justify-content: center; align-items: flex-end;
            padding-bottom: 5rem;
        }

        #site-footer {
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent); /* Gradient contrast */
            color: #fff;
            padding: 4rem 2rem;
            text-align: center;
            position: relative;
            z-index: 20;
            text-shadow: 0 0 10px #000;
        }

        #site-footer h3 {
            font-family: var(--f-serif);
            color: #fff;
            margin-bottom: 2rem;
            text-shadow: 0 0 10px black;
            font-size: 1.5rem;
        }

        /* Social Icons hidden initially */
        .chest-social-icons {
            position: fixed; /* Fixed position for stability */
            bottom: 15%; left: 50%; transform: translateX(-50%) scale(0);
            display: flex; gap: 1rem;
            pointer-events: none;
            opacity: 0;
            transition: 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 9999;
        }
        .chest-social-icons.active {
            opacity: 1;
            transform: translateX(-50%) scale(1);
            pointer-events: auto;
        }
        .chest-btn {
            width: 70px; height: 70px; border-radius: 50%;
            background: var(--c-deep);
            border: 2px solid var(--c-gold);
            color: var(--c-gold);
            display: flex; justify-content: center; align-items: center;
            font-size: 2rem; text-decoration: none;
            backdrop-filter: blur(5px);
            transition: 0.3s;
        }
        .chest-btn:hover { background: var(--c-gold); color: #000; box-shadow: 0 0 20px var(--c-gold); transform: scale(1.1); }


        /* --- MODALS --- */
        #text-modal, #lightbox {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,30,54, 0.95);
            z-index: 9999;
            display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none;
            transition: opacity 0.3s;
        }
        #text-modal.active, #lightbox.active { opacity: 1; pointer-events: auto; }

        .modal-content {
            background: transparent;
            border: 2px solid var(--c-accent);
            padding: 3rem;
            max-width: 600px;
            border-radius: 20px;
            box-shadow: 0 0 50px var(--c-accent);
            text-align: center;
            position: relative;
            background: rgba(0,0,0,0.8);
        }
        .modal-content h3 { color: var(--c-accent); margin-bottom: 1rem; font-size: 2rem; }
        .modal-content p { color: #fff; font-size: 1.2rem; }

        #lightbox img {
            max-width: 90vw; max-height: 80vh;
            border: 4px solid var(--c-gold);
            border-radius: 10px;
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.3);
        }

        #nav-back {
            position: fixed; top: 20px; left: 20px; z-index: 100;
            color: white; text-decoration: none; font-weight: bold;
            background: rgba(0,0,0,0.3); padding: 10px 20px; border-radius: 30px;
            border: 1px solid rgba(255,255,255,0.3);
            backdrop-filter: blur(5px);
            transition: 0.3s;
        }
        #nav-back:hover { background: white; color: var(--c-deep); }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {transform: translateY(0);}
            40% {transform: translateY(-20px);}
            60% {transform: translateY(-10px);}
        }

        /* Mobile */
        @media (max-width: 768px) {
            h1 { font-size: 15vw; }
            .content-box { padding: 1.5rem; }
            .bubble-container { transform: scale(0.9); }
            .mermaid-guide { width: 60px; height: 60px; right: 10px; }
            .chest-btn { width: 50px; height: 50px; font-size: 1.5rem; }
        }

    </style>
</head>
<body>

    <a href="/guild/" id="nav-back"><i class="fa-solid fa-arrow-left"></i> å›å…¬æœƒ</a>
    <div id="canvas-container"></div>

    <!-- Intro Overlay -->
    <div id="intro-overlay" style="position: fixed; top:0; left:0; width:100%; height:100%; background: var(--c-deep); z-index: 10000; display: flex; flex-direction:column; justify-content: center; align-items: center; transition: opacity 1s;">
        <h1 style="font-size: 5rem; text-shadow: 0 0 30px var(--c-accent); margin-bottom: 2rem;">Liloyee</h1>
        <button id="enter-btn" style="background: transparent; border: 2px solid var(--c-accent); color: var(--c-accent); padding: 1rem 3rem; font-size: 1.5rem; border-radius: 50px; cursor: pointer; transition: 0.3s; font-family: var(--f-title);">
            <i class="fa-solid fa-water"></i> DIVE IN
        </button>
    </div>

    <audio id="bgm" loop>
        <source src="/assets/audio/underwater.mp3" type="audio/mpeg">
    </audio>

    <!-- Modals -->
    <div id="lightbox"><img src="" alt="Full Image"></div>
    <div id="text-modal">
        <div class="modal-content">
            <h3 id="modal-title">Title</h3>
            <p id="modal-text">Content goes here.</p>
            <p style="margin-top:2rem; font-size:0.9rem; color:#aaa;">(é»æ“Šä»»æ„è™•é—œé–‰)</p>
        </div>
    </div>

    <!-- Swimming Mermaid Guide -->
    <div class="mermaid-guide" id="mermaid">
        <span style="font-size: 4rem; filter: drop-shadow(0 0 10px var(--c-accent));">ğŸ§œâ€â™€ï¸</span>
    </div>

    <!-- Social Icons Container (Pop from Chest) -->
    <div id="chest-socials" class="chest-social-icons">
        <a href="https://www.threads.net/@liloyee_0224" target="_blank" class="chest-btn"><i class="fa-brands fa-threads"></i></a>
        <a href="https://www.instagram.com/liloyee_0224/" target="_blank" class="chest-btn"><i class="fa-brands fa-instagram"></i></a>
    </div>

    <main>
        <!-- HERO -->
        <section id="hero">
            <h1 data-text="LILOYEE">LILOYEE</h1>
            <p style="letter-spacing: 5px; color: var(--c-accent); text-transform: uppercase;">Angel // Writer // Dreamer</p>
            <i class="fa-solid fa-chevron-down" style="margin-top: 3rem; animation: bounce 2s infinite; color: var(--c-accent);"></i>
        </section>

        <!-- STORY LOG -->
        <section id="story-log">
            <div class="story-card">
                <h3><i class="fa-solid fa-graduation-cap"></i> ç¤¾æœƒå¿ƒç†ç³» x å¥§æ•¸è€å¸«</h3>
                <p>æˆ‘æ˜¯ä¾†è‡ªé¦¬ä¾†è¥¿äºçš„ç¤¾æœƒå¿ƒç†ç³»ç•¢æ¥­ç”Ÿï¼Œç›®å‰æ“”ä»»å¥§æ•¸æ•¸å­¸è€å¸«ã€‚</p>
                <p>é›–ç„¶æ•™çš„æ˜¯ç†æ€§é‚è¼¯ï¼Œä½†å…§å¿ƒæ·±æ„›è‘—å¿ƒç†å­¸èˆ‡ç¤¾æœƒå­¸çš„æ„Ÿæ€§çŸ¥è­˜ã€‚</p>
            </div>
            <div class="story-card">
                <h3><i class="fa-solid fa-pen-nib"></i> å¤¢æƒ³æˆç‚ºä½œå®¶</h3>
                <p>é€™è¼©å­æœ€å¤§çš„é¡˜æœ›æ˜¯ç”¨æº«æŸ”å¹½é»˜çš„æ–‡å­—ï¼Œå¯«ä¸‹ç•¢ç”Ÿçš„ç¶“æ­·ã€‚</p>
                <p>æˆ‘æƒ³æŠŠæ•…äº‹å“¼æˆæ›²å­ï¼Œè®“è²éŸ³èµ°é€²å¤§å®¶çš„å¿ƒè£¡ã€‚</p>
            </div>
            <div class="story-card">
                <h3><i class="fa-solid fa-cloud-moon"></i> å¤šå¤¢ç—‡å€™ç¾¤</h3>
                <p>æˆ‘çš„å¤¢å¢ƒä¸–ç•Œæœ‰é¡è‰²ã€æœ‰è§¸è¦ºã€æœ‰ç—›è¦ºï¼Œå°±åƒæ¯å¤©é–‹ç›²ç›’ä¸€æ¨£ç²¾å½©ï¼</p>
                <p>æ­¡è¿ä¾†æ‰¾æˆ‘è§£å¤¢ï¼Œåˆ†æä½ çš„æ½›æ„è­˜ç‹€æ…‹ã€‚</p>
            </div>
        </section>

        <!-- BUBBLE GALLERY -->
        <div id="bubble-zone">
            <!-- Bubbles injected by JS -->

            <!-- Sea Creatures Container -->
            <div id="sea-creatures"></div>
        </div>

        <!-- SAND PILE -->
        <section id="sand-section">
            <div class="content-box" style="max-width: 500px; margin-bottom: 5rem; background: transparent; box-shadow: none; border: none;">
                <!-- Replaced text with visual cue for chest -->
                <p style="text-shadow: 0 0 10px black; opacity: 0.8; font-size: 1.2rem;">(é»æ“Šå¯¶ç®±æ‰“é–‹ç§˜å¯†)</p>
            </div>
        </section>

        <!-- FOOTER -->
        <footer id="site-footer">
            <h3><a href="/guild/" style="color: inherit; text-decoration: none;">SuperGalen's Dungeon</a></h3>
            <p style="font-size: 0.8rem;">&copy; 2024 Liloyee Guild Page</p>
        </footer>

    </main>

    <!-- Libs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/ScrollTrigger.min.js"></script>

    <script>
        gsap.registerPlugin(ScrollTrigger);

        // --- CONTENT DATA ---
        const contentMap = {
            0: { title: "æˆ‘æ˜¯èª°?", text: "å–²å‘¼ (ï½€ãƒ»Ï‰ãƒ»Â´)ã‚<br>æˆ‘æ˜¯ä¸€åç•¢æ¥­æ–¼ç¤¾æœƒå¿ƒç†ç³»çš„å­¸ç”Ÿï¼Œæ˜¯å€‹é¦¬ä¾†è¥¿äºäººã€‚<br>ç›®å‰æ˜¯ä¸€åå¥§æ•¸æ•¸å­¸è€å¸«ï¼Œä¹Ÿéå¸¸ç†±æ„›éå»å°±è®€çš„ç¤¾æœƒå­¸å’Œå¿ƒç†å­¸ç›¸é—œçš„çŸ¥è­˜ğŸ¤©" },
            3: { title: "æˆ‘çš„å¤¢æƒ³", text: "é€™è¼©å­æœ€æƒ³è¦æˆç‚ºä¸€åä½œå®¶âœï¸<br>æˆ‘æƒ³æŠŠç•¢ç”Ÿçš„ç¶“æ­·éƒ½ç”¨æº«æŸ”å¹½é»˜çš„æ–‡å­—å¯«ä¸‹ï¼Œæƒ³æŠŠæ•…äº‹å“¼æˆä¸€é¦–ä¸€é¦–çš„æ›²å­ï¼Œè®“æˆ‘çš„æ•…äº‹ä¸æ­¢èƒ½è¢«çœ‹è¦‹é‚„èƒ½ç”¨è²éŸ³èµ°é€²å¤§å®¶çš„å¿ƒè£¡â¤ï¸" },
            5: { title: "å¤šå¤¢ç—‡å€™ç¾¤", text: "å¤šå¤¢ç—‡è®“æˆ‘ç¶“å¸¸åœ¨å¤¢è£¡æ—…è¡Œã€‚<br>å¤¢è£¡çš„ä¸–ç•Œæœ‰é¡è‰²ã€æœ‰è§¸è¦ºã€æœ‰æº«åº¦ã€æœ‰ç—›è¦ºã€‚<br>æ¯æ¬¡ç¡è¦ºæœƒåƒæŠ½ç›²ç›’ä¸€æ¨£å¥½ç©å–”ï¼ğŸ¤£" },
            8: { title: "é—œæ–¼è§£å¤¢", text: "æˆ‘æœ‰è‡ªå·±ç ”ç©¶è§£å¤¢å’Œäººæ ¼åˆ†æï¼Œæœƒå¾å¤¢å¢ƒæƒ…ç·’ã€å ´æ™¯ã€ç”Ÿæ´»ç’°å¢ƒå’Œè¿‘æ³åˆ†æå€‹äººç‹€æ…‹ã€‚<br>å°æˆ‘è€Œè¨€éƒ½æ˜¯å¥½ç©æœ‰è¶£æœ‰æ„ç¾©çš„äº‹ğŸ¥°" },
            12: { title: "å¹¸é‹ S ç´š", text: "æˆ‘é‹æ°£éå¸¸å¥½ğŸ€<br>é€™è¼©å­æŠ½éæ‰‹æ©Ÿã€è€³æ©Ÿï¼Œä¹Ÿæ²’é‡åˆ°éå£æœ‹å‹ã€‚<br>å¯èƒ½æ—¥å­å¶çˆ¾æœ‰é»æŒ‘æˆ°ï¼Œä½†ç¸½æœƒæœ‰äº›å¹¸é‹å¹¸ç¦çš„å¥½äº‹â£ï¸" },
            15: { title: "èˆˆè¶£æ„›å¥½", text: "çŸ®çŸ®åæ—¥ç³»é‚„æœ‰é»å‹•æ¼«å®…ï¼Œä¹Ÿå–œæ­¡åšæ‰‹å¸³ã€å¯«æ—¥è¨˜ã€æ•´ç†æ±è¥¿ã€è£æ‰®ã€å”±æ­Œã€‚<br>é‚„æœ‰æˆ‘æœ€æœ€æœ€å–œæ­¡å²è¿ªå¥‡äº†ğŸ’™" }
        };

        const galleryImages = [];
        for(let i=1; i<=18; i++) {
            const num = i < 10 ? '0'+i : i;
            galleryImages.push(`/assets/img/guild/liloyee/gallery_${num}.webp`);
        }

        // --- THREE.JS SETUP ---
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x001e36, 0.02);

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 20;

        const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        // --- LIGHTS ---
        const ambientLight = new THREE.AmbientLight(0x404040, 1.5); // Reduced slightly to allow specular pop
        scene.add(ambientLight);

        const dirLight = new THREE.DirectionalLight(0xffffff, 1.5); // Increased for shine
        dirLight.position.set(0, 50, 20);
        scene.add(dirLight);

        const pileLight = new THREE.PointLight(0xffaa00, 2, 60);
        pileLight.position.set(0, -60, 20);
        scene.add(pileLight);

        // --- ROUND PARTICLES (CanvasTexture) ---
        function createCircleTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 32; canvas.height = 32;
            const context = canvas.getContext('2d');
            const gradient = context.createRadialGradient(16, 16, 0, 16, 16, 16);
            gradient.addColorStop(0, 'rgba(255,255,255,1)');
            gradient.addColorStop(0.5, 'rgba(0,243,255,0.5)');
            gradient.addColorStop(1, 'rgba(0,0,0,0)');
            context.fillStyle = gradient;
            context.fillRect(0,0,32,32);
            const texture = new THREE.CanvasTexture(canvas);
            return texture;
        }

        const particlesGeom = new THREE.BufferGeometry();
        const pCount = 1500;
        const pPos = new Float32Array(pCount * 3);
        for(let i=0; i<pCount; i++) {
            pPos[i*3] = (Math.random()-0.5) * 100;
            pPos[i*3+1] = (Math.random()-0.5) * 200;
            pPos[i*3+2] = (Math.random()-0.5) * 100;
        }
        particlesGeom.setAttribute('position', new THREE.BufferAttribute(pPos, 3));
        const particlesMat = new THREE.PointsMaterial({
            color: 0xffffff,
            size: 0.5,
            map: createCircleTexture(),
            transparent: true,
            opacity: 0.8,
            depthWrite: false,
            blending: THREE.AdditiveBlending
        });
        const particleSystem = new THREE.Points(particlesGeom, particlesMat);
        scene.add(particleSystem);

        // --- SAND DUNE ---
        const sandY = -70;
        function getSandHeight(x, z) {
            // Note: In PlaneGeometry, 'y' coord is mapped to Z in world space due to rotation
            return Math.sin(x * 0.1) * 2 + Math.cos(z * 0.1) * 2 + Math.sin(x*0.3 + z*0.2)*1;
        }

        const sandGeom = new THREE.PlaneGeometry(200, 100, 64, 64);
        const pos = sandGeom.attributes.position;
        for (let i = 0; i < pos.count; i++) {
            const x = pos.getX(i);
            const y = pos.getY(i); // This corresponds to world Z before rotation
            const height = Math.sin(x * 0.1) * 2 + Math.cos(y * 0.1) * 2 + Math.sin(x*0.3 + y*0.2)*1;
            pos.setZ(i, height);
        }
        sandGeom.computeVertexNormals();
        const sandMat = new THREE.MeshStandardMaterial({
            color: 0xedc9af,
            roughness: 1,
            metalness: 0,
            flatShading: true
        });
        const sandMesh = new THREE.Mesh(sandGeom, sandMat);
        sandMesh.rotation.x = -Math.PI / 2;
        sandMesh.position.y = sandY;
        scene.add(sandMesh);

        // --- ICON TEXTURE HELPER ---
        function createIconTexture(char, color) {
            const canvas = document.createElement('canvas');
            canvas.width = 256; canvas.height = 256;
            const ctx = canvas.getContext('2d');
            // FontAwesome Solid
            ctx.font = '900 150px "Font Awesome 6 Free"';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillStyle = color;
            ctx.shadowColor = "rgba(0,0,0,0.5)";
            ctx.shadowBlur = 10;
            ctx.fillText(char, 128, 128);
            return new THREE.CanvasTexture(canvas);
        }

        // --- TREASURE CHEST (SPRITE) ---
        let chestSprite;
        let isChestOpen = false;

        // fa-box-open: \uf49e, fa-gem: \uf3a5
        const chestTexClosed = createIconTexture('\uf49e', '#ffd700');
        const chestTexOpen = createIconTexture('\uf3a5', '#00f3ff');

        const chestMat = new THREE.SpriteMaterial({ map: chestTexClosed });
        chestSprite = new THREE.Sprite(chestMat);
        // Position on sand
        const chestBaseY = getSandHeight(0, -5) + sandY + 3;
        chestSprite.position.set(0, chestBaseY, -5);
        chestSprite.scale.set(8, 8, 1);
        chestSprite.name = 'ChestSprite';
        scene.add(chestSprite);


        // --- TREASURES (SPRITES) ---
        const treasures = [];

        const treasureTypes = [
            // Wealth
            { char: '\uf51e', color: '#ffd700', category: 'wealth' }, // Gold Coins
            { char: '\uf51e', color: '#c0c0c0', category: 'wealth' }, // Silver Coins
            { char: '\uf3a5', color: '#ff0055', category: 'wealth' }, // Red Gem
            { char: '\uf3a5', color: '#00f3ff', category: 'wealth' }, // Blue Gem
            { char: '\uf3a5', color: '#50c878', category: 'wealth' }, // Emerald
            { char: '\uf521', color: '#ffd700', category: 'wealth' }, // Crown
            { char: '\uf70b', color: '#ff69b4', category: 'wealth' }, // Ring
            { char: '\uf091', color: '#cd7f32', category: 'wealth' }, // Trophy
            { char: '\uf81d', color: '#85bb65', category: 'wealth' }, // Sack Dollar
            // Artifacts
            { char: '\uf0c3', color: '#9933cc', category: 'artifact' }, // Flask
            { char: '\uf70e', color: '#f4a460', category: 'artifact' }, // Scroll
            { char: '\uf3ed', color: '#708090', category: 'artifact' }, // Shield
            { char: '\uf66d', color: '#a9a9a9', category: 'artifact' }, // Sword (Khanda)
            { char: '\uf72f', color: '#8b0000', category: 'artifact' }, // Wine Bottle
            { char: '\uf6fa', color: '#ffffff', category: 'artifact' }, // Mask
            { char: '\uf644', color: '#ffd700', category: 'artifact' }, // Ankh
            { char: '\uf6d5', color: '#ff4500', category: 'artifact' }, // Dragon
        ];

        // --- SPAWN INITIAL TREASURES ---
        function spawnInitialTreasures() {
            for(let i=0; i<200; i++) {
                const config = treasureTypes[Math.floor(Math.random() * treasureTypes.length)];
                const tex = createIconTexture(config.char, config.color);
                const mat = new THREE.SpriteMaterial({ map: tex });
                const sprite = new THREE.Sprite(mat);

                // Scatter around chest
                const angle = Math.random() * Math.PI * 2;
                const radius = Math.random() * 15 + 3;

                const x = Math.cos(angle) * radius;
                const z = -5 + Math.sin(angle) * radius;
                const y = getSandHeight(x, z) + sandY + 1.5; // Slightly above sand

                sprite.position.set(x, y, z);
                sprite.scale.set(3, 3, 1);

                scene.add(sprite);
            }
        }
        spawnInitialTreasures();

        function spawnTreasure(screenX, screenY) {
            spawnTreasureInternal(screenX, screenY, false);
        }

        function spawnBubbleTreasure(screenX, screenY) {
            spawnTreasureInternal(screenX, screenY, true);
        }

        function spawnTreasureInternal(screenX, screenY, isBubble) {
            if(treasures.length > 150) {
                const old = treasures.shift();
                scene.remove(old.mesh);
            }

            const count = isBubble ? 3 : (Math.floor(Math.random() * 5) + 1);

            for(let k=0; k<count; k++) {
                const vec = new THREE.Vector3();
                let spawnPos;

                if (isBubble) {
                    vec.set(
                        (screenX / window.innerWidth) * 2 - 1,
                        -(screenY / window.innerHeight) * 2 + 1,
                        0.5
                    );
                    vec.unproject(camera);
                    vec.sub(camera.position).normalize();
                    const t = (-2 - camera.position.z) / vec.z;
                    spawnPos = camera.position.clone().add(vec.multiplyScalar(t));
                } else {
                    vec.set(
                        (screenX / window.innerWidth) * 2 - 1,
                        -(screenY / window.innerHeight) * 2 + 1,
                        0.5
                    );
                    vec.unproject(camera);
                    vec.sub(camera.position).normalize();
                    spawnPos = camera.position.clone().add(vec.multiplyScalar(10));
                }

                let config;
                if(isBubble) {
                    // Only Wealth items for bubbles
                    const wealthItems = treasureTypes.filter(t => t.category === 'wealth');
                    config = wealthItems[Math.floor(Math.random() * wealthItems.length)];
                } else {
                    config = treasureTypes[Math.floor(Math.random() * treasureTypes.length)];
                }

                const tex = createIconTexture(config.char, config.color);
                const mat = new THREE.SpriteMaterial({ map: tex });
                const sprite = new THREE.Sprite(mat);

                sprite.position.copy(spawnPos);
                sprite.position.x += (Math.random()-0.5)*2;
                sprite.position.y += (Math.random()-0.5)*2;
                sprite.scale.set(3, 3, 1);

                scene.add(sprite);

                const targetPos = new THREE.Vector3(
                    (Math.random() - 0.5) * 12,
                    sandY,
                    -5 + (Math.random() - 0.5) * 8
                );
                const direction = targetPos.clone().sub(spawnPos).normalize();

                let speed;
                let gravityScale = 1.0;

                if (isBubble) {
                    speed = 0.05 + Math.random() * 0.05;
                    gravityScale = 0.1;
                } else {
                    speed = 0.4 + Math.random() * 0.3;
                }

                treasures.push({
                    mesh: sprite,
                    velocity: direction.multiplyScalar(speed),
                    rotationSpeed: new THREE.Vector3(0,0,0), // Sprites don't rotate 3D
                    gravity: 0.002 * gravityScale
                });
            }
        }


        // --- BUBBLE GENERATION ---
        const bubbleZone = document.getElementById('bubble-zone');
        const creatureZone = document.getElementById('sea-creatures');
        const creatureIcons = ['fa-fish', 'fa-shrimp', 'fa-dragon', 'fa-water'];

        // Spawn Sea Creatures (Moving)
        for(let i=0; i<10; i++) {
            const c = document.createElement('i');
            c.className = `fa-solid ${creatureIcons[Math.floor(Math.random() * creatureIcons.length)]} sea-creature`;
            const startY = Math.random() * 90;
            c.style.top = startY + '%';
            c.style.left = -10 + '%'; // Start off screen
            c.style.fontSize = (Math.random() * 2 + 1) + 'rem';
            creatureZone.appendChild(c);

            // Swim Across
            gsap.to(c, {
                x: '110vw', // Move across screen
                y: (Math.random() - 0.5) * 200,
                duration: 15 + Math.random() * 15,
                repeat: -1,
                ease: "linear",
                delay: Math.random() * 10
            });
        }

        galleryImages.forEach((src, i) => {
            const b = document.createElement('div');
            b.className = 'bubble-container';
            const size = Math.random() * 80 + 100;
            b.style.width = size + 'px';
            b.style.height = size + 'px';

            // Updated Distribution: Concentrate in middle (5% to 60% of container height)
            const top = (i / galleryImages.length) * 55 + 5;
            const left = Math.random() * 80 + 10;

            b.style.top = top + '%';
            b.style.left = left + '%';

            const content = contentMap[i];

            if (content) {
                b.innerHTML = `<span class="bubble-label">${content.title}</span><img src="${src}" alt="Memory" style="opacity:0.4;">`;
                b.style.borderColor = 'var(--c-accent)';
                b.style.boxShadow = '0 0 20px var(--c-accent)';
            } else {
                b.innerHTML = `<img src="${src}" alt="Memory">`;
            }

            b.addEventListener('click', (e) => {
                gsap.to(b, { scale: 1.5, opacity: 0, duration: 0.3, onComplete: () => {
                    b.style.visibility = 'hidden';
                }});

                spawnBubbleTreasure(e.clientX, e.clientY);

                if (content) {
                    const modal = document.getElementById('text-modal');
                    document.getElementById('modal-title').innerText = content.title;
                    document.getElementById('modal-text').innerHTML = content.text;
                    modal.classList.add('active');
                } else {
                    const lb = document.getElementById('lightbox');
                    lb.querySelector('img').src = src;
                    lb.classList.add('active');
                }
            });

            bubbleZone.appendChild(b);

            gsap.to(b, {
                y: '-=50',
                duration: 2 + Math.random()*2,
                repeat: -1,
                yoyo: true,
                ease: "sine.inOut"
            });
        });

        // --- SCROLL LOGIC ---
        let scrollY = 0;
        let maxScroll = document.body.scrollHeight - window.innerHeight;
        const mermaid = document.getElementById('mermaid');

        window.addEventListener('scroll', () => {
            scrollY = window.scrollY;
            maxScroll = document.body.scrollHeight - window.innerHeight;

            // Mermaid Guide follows scroll
            // Moves from top: 20% to top: 80% based on scroll progress
            const progress = Math.min(scrollY / maxScroll, 1);
            const targetTop = 20 + (progress * 60);
            mermaid.style.top = targetTop + '%';
        });

        // Mermaid Swim Animation
        gsap.to(mermaid, {
            y: 20,
            duration: 2,
            repeat: -1,
            yoyo: true,
            ease: "sine.inOut"
        });

        function updateCamera() {
            const progress = Math.min(scrollY / maxScroll, 1);
            const targetY = progress * (sandY + 10);
            camera.position.y += (targetY - camera.position.y) * 0.05;
        }

        // --- INTERACTION: CHEST CLICK ---
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();

        window.addEventListener('click', (event) => {
            // Check interaction with chest sprite
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObject(chestSprite);

            if (intersects.length > 0) {
                toggleChest();
            }
        });

        function toggleChest() {
            isChestOpen = !isChestOpen;
            const icons = document.getElementById('chest-socials');

            if(isChestOpen) {
                // Open Animation
                chestSprite.material.map = chestTexOpen;
                gsap.to(chestSprite.scale, { x: 10, y: 10, duration: 0.2, yoyo: true, repeat: 1 });

                // Light Burst
                const burstColor = new THREE.Color('#ffdd00');
                gsap.to(pileLight, { intensity: 3, duration: 0.5, yoyo: true, repeat: 1 });
                gsap.to(pileLight.color, {
                    r: burstColor.r,
                    g: burstColor.g,
                    b: burstColor.b,
                    duration: 0.5,
                    yoyo: true,
                    repeat: 1
                });

                icons.classList.add('active');

            } else {
                // Close
                chestSprite.material.map = chestTexClosed;
                gsap.to(chestSprite.scale, { x: 8, y: 8, duration: 0.3 });

                icons.classList.remove('active');
            }
        }


        // --- ANIMATION LOOP ---
        const clock = new THREE.Clock();

        function animate() {
            requestAnimationFrame(animate);
            const time = clock.getElapsedTime();

            updateCamera();
            particleSystem.rotation.y = time * 0.02;

            treasures.forEach(t => {
                // Underwater physics
                const g = t.gravity !== undefined ? t.gravity : 0.002;
                t.velocity.y -= g;
                t.velocity.multiplyScalar(0.98);

                t.mesh.position.add(t.velocity);
                t.mesh.rotation.x += t.rotationSpeed.x;
                t.mesh.rotation.y += t.rotationSpeed.y;

                // Exact Floor Collision
                const floorHeight = getSandHeight(t.mesh.position.x, t.mesh.position.z);
                const floorY = sandY + floorHeight + 0.5; // + radius

                if (t.mesh.position.y < floorY) {
                    t.mesh.position.y = floorY;
                    t.velocity.set(0, 0, 0);
                    t.rotationSpeed.set(0, 0, 0);
                }
            });

            renderer.render(scene, camera);
        }
        animate();


        // --- STORY CARDS ANIMATION ---
        gsap.utils.toArray('.story-card').forEach(card => {
            gsap.to(card, {
                opacity: 1, y: 0,
                duration: 1,
                scrollTrigger: {
                    trigger: card,
                    start: "top 80%",
                    toggleActions: "play none none reverse"
                }
            });
        });

        // --- INTRO & UI CLOSERS ---
        document.getElementById('enter-btn').addEventListener('click', () => {
            const overlay = document.getElementById('intro-overlay');
            overlay.style.opacity = '0';
            setTimeout(() => overlay.remove(), 1000);

            const audio = document.getElementById('bgm');
            audio.volume = 0.2;
            audio.play().catch(e => console.log("Audio play failed", e));

            gsap.to('#canvas-container', { opacity: 1, duration: 2 });
        });

        document.getElementById('lightbox').addEventListener('click', () => {
            document.getElementById('lightbox').classList.remove('active');
        });
        document.getElementById('text-modal').addEventListener('click', () => {
            document.getElementById('text-modal').classList.remove('active');
        });
        // Initial canvas fade in moved to enter button

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

    </script>
</body>
</html>