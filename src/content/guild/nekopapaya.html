<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEKOPAPAYA | The Narrative Archive</title>
    <meta name="description" content="NEKOPAPAYA - äººé«”ç‹€æ…‹è§€å¯Ÿåˆ†æå¸« | åº·æ¨‚è‚¡é•· | é¿é¢¨æ¸¯">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js" defer></script>

    <!-- Three.js Import Map -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <style>
        :root {
            /* Palette: Notebook Paper */
            --c-bg: #F9F7F1;       /* Paper White */
            --c-text: #2c2c2c;     /* Ink Black */
            --c-accent: #78C0A8;   /* Sage */
            --c-blue: #7FB2D4;     /* Ink Blue */
            --c-warm: #EAC435;     /* Highlight */
            --c-line: #ddd;        /* Grid Line */

            --f-en: 'Nunito', sans-serif;
            --f-zh: 'Noto Sans TC', sans-serif;
        }

        body.night-mode {
            --c-bg: #2b2b2b;
            --c-text: #e0e0e0;
            --c-accent: #F1C40F;
            --c-line: #444;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background-color: var(--c-bg);
            color: var(--c-text);
            font-family: var(--f-zh);
            overflow-x: hidden;
            line-height: 1.8;
            transition: background-color 0.5s, color 0.5s;
            background-image: linear-gradient(var(--c-line) 1px, transparent 1px),
            linear-gradient(90deg, var(--c-line) 1px, transparent 1px);
            background-size: 40px 40px;
        }

        #webgl-container { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 0; }
        .scroller { position: relative; z-index: 10; pointer-events: none; }
        .interactive-layer { pointer-events: auto; }

        /* --- Bubble Tooltip --- */
        #tooltip {
            position: fixed; pointer-events: none; opacity: 0;
            background: white; padding: 0.8rem 1.2rem;
            border: 2px solid var(--c-text); border-radius: 12px;
            box-shadow: 4px 4px 0px var(--c-text);
            font-family: var(--f-en); color: #2c2c2c; /* Always dark text in tooltip */
            transform: translate(-50%, -150%); transition: opacity 0.2s, transform 0.2s;
            z-index: 100;
        }
        #tooltip::after {
            content: ''; position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%);
            border-width: 8px 8px 0; border-style: solid;
            border-color: var(--c-text) transparent transparent transparent;
        }

        /* --- Mode Switch --- */
        .mode-switch {
            position: fixed; top: 2rem; right: 2rem; z-index: 50;
            background: white; border: 2px solid var(--c-text);
            width: 50px; height: 50px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem; cursor: pointer; pointer-events: auto;
            transition: transform 0.2s; color: #2c2c2c;
        }
        .mode-switch:hover { transform: scale(1.1); background: var(--c-warm); }

        /* --- Sections --- */
        .section {
            min-height: 120vh;
            display: flex; flex-direction: column; justify-content: center;
            padding: 2rem; position: relative;
        }

        .notebook-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 3rem;
            border-radius: 4px;
            border: 2px solid var(--c-text);
            box-shadow: 10px 10px 0px rgba(0,0,0,0.1);
            max-width: 500px;
            position: relative;
            transform-origin: top left;
        }
        .notebook-card::before { /* Tape effect */
            content: ''; position: absolute; top: -15px; left: 50%; transform: translateX(-50%);
            width: 100px; height: 30px; background: rgba(255, 255, 255, 0.6);
            border: 1px dashed #ccc; transform: translateX(-50%) rotate(-2deg);
        }
        body.night-mode .notebook-card {
            background: #333; border-color: #eee; box-shadow: 10px 10px 0px rgba(255,255,255,0.05);
        }

        .pos-left { margin-right: auto; margin-left: 5vw; }
        .pos-right { margin-left: auto; margin-right: 5vw; }
        .pos-center { margin: 0 auto; text-align: center; }

        h1 { font-family: var(--f-en); font-weight: 900; font-size: 3rem; line-height: 1.1; margin-bottom: 0.5rem; }
        h2 { font-family: var(--f-en); font-weight: 700; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--c-accent); margin-bottom: 1rem; border-bottom: 2px dashed var(--c-accent); display: inline-block; }
        h3 { font-size: 1.2rem; font-weight: 700; margin-bottom: 0.5rem; }
        p { font-size: 1rem; opacity: 0.8; margin-bottom: 1rem; }

        .tag {
            display: inline-block; padding: 0.3rem 0.8rem; background: var(--c-text);
            color: var(--c-bg); border-radius: 4px;
            font-size: 0.8rem; font-weight: 700; margin-right: 0.5rem;
        }

        .nav-fixed {
            position: fixed; top: 2rem; left: 2rem; z-index: 50;
            font-family: var(--f-en); font-weight: 900; color: var(--c-text); text-decoration: none;
            padding: 0.5rem 1.2rem; background: var(--c-bg); border: 2px solid var(--c-text); border-radius: 50px;
            pointer-events: auto; transition: transform 0.2s;
        }
        .nav-fixed:hover { transform: scale(1.05); }

        .social-link {
            display: inline-flex; align-items: center; justify-content: center;
            width: 50px; height: 50px; border-radius: 50%; background: var(--c-bg);
            color: var(--c-text); font-size: 1.2rem; margin: 0 0.5rem;
            border: 2px solid var(--c-text);
            transition: transform 0.2s, background 0.2s; text-decoration: none;
        }
        .social-link:hover { transform: translateY(-3px); background: var(--c-accent); color: white; border-color: var(--c-text); }

        /* --- Custom List --- */
        .check-list { list-style: none; padding: 0; }
        .check-list li { margin-bottom: 0.5rem; padding-left: 1.5rem; position: relative; }
        .check-list li::before {
            content: 'âœ“'; position: absolute; left: 0; color: var(--c-accent); font-weight: bold;
        }

        @media(max-width: 768px) {
            .notebook-card { margin: 0 auto !important; width: 100%; max-width: 100%; padding: 2rem; }
            h1 { font-size: 2.5rem; }
            .section { min-height: 80vh; padding: 4rem 1.5rem; }
        }

    </style>
</head>
<body>

    <a href="/guild" class="nav-fixed">â† GUILD</a>
    <div class="mode-switch" id="mode-switch">â˜€</div>
    <div id="tooltip"></div>
    <div id="webgl-container"></div>

    <div class="scroller">

        <!-- 1. Hero -->
        <section class="section">
            <div class="notebook-card pos-left interactive-layer gs-reveal">
                <span class="tag">#Analyst</span> <span class="tag">#Joy</span>
                <h1 style="margin-top: 1rem;">NEKOPAPAYA</h1>
                <p style="font-weight: 700;">äººé«”ç‹€æ…‹è§€å¯Ÿåˆ†æå¸« | åº·æ¨‚è‚¡é•·</p>
                <div style="border-top: 2px solid var(--c-accent); margin: 1rem 0; padding-top: 1rem;">
                    <p>
                        "Hydrogen knocking on your soul."<br>
                        (æ°«æ°«æ•²é†’ä½ çš„å¿ƒéˆ)
                    </p>
                </div>
                <p style="font-size: 0.9rem; opacity: 0.6;">
                    <i class="fa-solid fa-cube"></i> Explore the room to find the stories.
                </p>
            </div>
        </section>

        <!-- 2. Desk: Analysis -->
        <section class="section">
            <div class="notebook-card pos-right interactive-layer gs-reveal" style="max-width: 400px;">
                <h2>METHODOLOGY</h2>
                <h1>The Lab Report.</h1>
                <h3>Subject: Human Connection</h3>
                <p>ä½œç‚ºåˆ†æå¸«ï¼Œæˆ‘çš„å·¥ä½œæ˜¯ç„¡è²åœ°è§€å¯Ÿèˆ‡èª¿é »ã€‚</p>
                <ul class="check-list">
                    <li><strong>Signal Detection:</strong> åœ¨ç†±é¬§ä¸­æ•æ‰è¢«å¿½ç•¥çš„è¨Šè™Ÿã€‚</li>
                    <li><strong>Noise Cancellation:</strong> æ¶ˆé™¤ç¤¾äº¤å£“åŠ›ï¼Œå‰µé€ è‡ªåœ¨ç©ºé–“ã€‚</li>
                    <li><strong>Frequency Matching:</strong> åƒæ°«åŸå­èˆ¬è¼•è¼•æ’æ“Šï¼Œå–šé†’å…±é³´ã€‚</li>
                </ul>
            </div>
        </section>

        <!-- 3. Bookshelf: Stories -->
        <section class="section">
            <div class="notebook-card pos-left interactive-layer gs-reveal">
                <h2>ARCHIVE</h2>
                <h1>Collected Moments.</h1>
                <p>æ¯ä¸€å€‹æ¶ä¸Šçš„ç‰©ä»¶ï¼Œéƒ½æ˜¯ä¸€æ®µç›¸é‡çš„æ•…äº‹ã€‚</p>
                <p>ã€Œé­”äººæªæªã€ä¸åªæ˜¯ç¨±è™Ÿï¼Œæ˜¯ä¸€ç¨®è¡Œå‹•ä»£è™Ÿâ€”â€”å°‡æ•£è½çš„å€‹é«”ï¼Œé€éç†±æƒ…é‡æ–°ç·¨ç¹”æˆç¶²ã€‚</p>
                <div style="background: var(--c-accent); color: white; padding: 0.5rem 1rem; border-radius: 4px; display: inline-block; margin-top: 1rem;">
                    Status: Gathering...
                </div>
            </div>
        </section>

        <!-- 4. Lounge: Haven -->
        <section class="section">
            <div class="notebook-card pos-right interactive-layer gs-reveal">
                <h2>PHILOSOPHY</h2>
                <h1>Safe Haven.</h1>
                <p>é€™è£¡æ˜¯ä¸€å€‹å¯ä»¥åœä¸‹ä¾†ã€åä¸€ä¸‹çš„åœ°æ–¹ã€‚</p>
                <p>
                    <i class="fa-solid fa-mug-hot"></i> <strong>Warmth:</strong> æä¾›ç†±èŒ¶èˆ¬çš„æº«åº¦ã€‚<br>
                    <i class="fa-solid fa-door-open"></i> <strong>Freedom:</strong> æ²’æœ‰å¼·è¿«ï¼Œéš¨æ™‚æ­¡è¿é›¢é–‹æˆ–åŠ å…¥ã€‚
                </p>
            </div>
        </section>

        <!-- 5. Board: Plan -->
        <section class="section">
            <div class="notebook-card pos-center interactive-layer gs-reveal">
                <h2>NEXT EVENT</h2>
                <h1>Ready to Sync?</h1>
                <p>å¦‚æœä½ å‰›å¥½æƒ³åƒèˆ‡ã€æƒ³ä¸€èµ·æ„Ÿå—ï¼Œå°±å¯ä»¥ç§è¨Šæˆ‘ã€‚</p>
                <div style="margin-top: 2rem;">
                    <a href="https://www.threads.net/@nekopapaya" target="_blank" class="social-link"><i class="fa-brands fa-threads"></i></a>
                    <a href="https://www.instagram.com/nekopapaya/" target="_blank" class="social-link"><i class="fa-brands fa-instagram"></i></a>
                </div>
                <p style="font-size: 0.8rem; margin-top: 1rem; opacity: 0.6;">
                    * All interactions are voluntary. No pressure protocol active.
                </p>
            </div>
        </section>

    </div>

    <!-- SCRIPT -->
    <script type="module">
        import * as THREE from 'three';

        // --- Setup ---
        const container = document.getElementById('webgl-container');
        const tooltip = document.getElementById('tooltip');
        const modeSwitch = document.getElementById('mode-switch');

        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0xF9F7F1); // Paper

        // Camera
        const aspect = window.innerWidth / window.innerHeight;
        const d = 10;
        const camera = new THREE.OrthographicCamera(-d * aspect, d * aspect, d, -d, 1, 1000);
        camera.position.set(20, 20, 20);
        camera.lookAt(0, 0, 0);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        container.appendChild(renderer.domElement);

        // Lights
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.7);
        scene.add(ambientLight);
        const dirLight = new THREE.DirectionalLight(0xFFE4C4, 0.8);
        dirLight.position.set(10, 20, 5);
        dirLight.castShadow = true;
        dirLight.shadow.mapSize.width = 2048;
        dirLight.shadow.mapSize.height = 2048;
        scene.add(dirLight);

        // --- Toon Materials & Outline ---
        // Gradient Map for Cell Shading
        const colors = new Uint8Array([240, 240, 240, 100, 100, 100]); // 2 steps
        const gradientMap = new THREE.DataTexture(colors, 2, 1, THREE.LuminanceFormat);
        gradientMap.minFilter = THREE.NearestFilter;
        gradientMap.magFilter = THREE.NearestFilter;
        gradientMap.needsUpdate = true;

        function createToonMat(color) {
            return new THREE.MeshToonMaterial({ color: color, gradientMap: gradientMap });
        }

        const matWood = createToonMat(0xD7B698);
        const matWall = createToonMat(0xFFFFFF);
        const matDark = createToonMat(0x2D3436);
        const matAccent = createToonMat(0x78C0A8);
        const matBlue = createToonMat(0x7FB2D4);
        const matYellow = createToonMat(0xEAC435);
        const matPink = createToonMat(0xFF7675); // Joy color

        const lineMat = new THREE.LineBasicMaterial({ color: 0x2D3436, linewidth: 2 });

        function addOutline(mesh, geo) {
            const edges = new THREE.EdgesGeometry(geo, 20);
            const line = new THREE.LineSegments(edges, lineMat);
            mesh.add(line);
        }

        // --- Scene Construction ---
        const room = new THREE.Group();
        scene.add(room);

        // 1. Structure
        const floorGeo = new THREE.BoxGeometry(14, 0.5, 14);
        const floor = new THREE.Mesh(floorGeo, matWood);
        floor.position.y = -0.25; floor.receiveShadow = true;
        addOutline(floor, floorGeo); room.add(floor);

        const wall1 = new THREE.Mesh(new THREE.BoxGeometry(14, 8, 0.5), matWall);
        wall1.position.set(0, 4, -7.25); wall1.receiveShadow = true; addOutline(wall1, wall1.geometry); room.add(wall1);
        const wall2 = new THREE.Mesh(new THREE.BoxGeometry(0.5, 8, 14), matWall);
        wall2.position.set(-7.25, 4, 0); wall2.receiveShadow = true; addOutline(wall2, wall2.geometry); room.add(wall2);

        // 2. Desk Area
        const desk = new THREE.Group(); desk.position.set(-4, 0, -4); room.add(desk);
        const topGeo = new THREE.BoxGeometry(4, 0.2, 2.5);
        const top = new THREE.Mesh(topGeo, matWood);
        top.position.y = 1.5; top.castShadow = true; top.receiveShadow = true;
        addOutline(top, topGeo); desk.add(top);
        // Legs
        [[-1.8,1], [1.8,1], [-1.8,-1], [1.8,-1]].forEach(pos => {
            const leg = new THREE.Mesh(new THREE.CylinderGeometry(0.1,0.1,1.5), matDark);
            leg.position.set(pos[0], 0.75, pos[1]); desk.add(leg);
        });

        // Prop: Hydrogen Balloon (Sphere + String)
        const balloonGeo = new THREE.SphereGeometry(0.6, 16, 16);
        const balloon = new THREE.Mesh(balloonGeo, matBlue);
        balloon.position.set(-1.5, 3.5, 0);
        addOutline(balloon, balloonGeo);
        balloon.userData = { name: "H2 Balloon", desc: "Hydrogen knocking..." };
        desk.add(balloon);
        // String
        const stringGeo = new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(0,0,0), new THREE.Vector3(0,-2,0)]);
        const string = new THREE.Line(stringGeo, lineMat);
        string.position.y = -0.6; balloon.add(string);

        // Prop: Monitor (Vibe Check)
        const mon = new THREE.Mesh(new THREE.BoxGeometry(2, 1.2, 0.2), matDark);
        mon.position.set(0, 2.4, -0.5); addOutline(mon, mon.geometry); desk.add(mon);
        mon.userData = { name: "Vibe Monitor", desc: "Scanning Frequency" };

        // Prop: Photo Frame
        const photoGeo = new THREE.PlaneGeometry(0.8, 0.8);
        const photoTex = new THREE.TextureLoader().load('/assets/img/guild/nekopapaya/avatar.webp');
        const photo = new THREE.Mesh(photoGeo, new THREE.MeshBasicMaterial({ map: photoTex }));
        photo.position.set(1.2, 1.8, -0.8); photo.rotation.set(-0.1, -0.2, 0); desk.add(photo);
        const frame = new THREE.Mesh(new THREE.BoxGeometry(0.9, 0.9, 0.05), matWall);
        frame.position.set(1.2, 1.8, -0.85); frame.rotation.set(-0.1, -0.2, 0); addOutline(frame, frame.geometry); desk.add(frame);

        // 3. Bookshelf (Stories)
        const shelf = new THREE.Group(); shelf.position.set(0, 0, -6.5); room.add(shelf);
        const shelfBody = new THREE.Mesh(new THREE.BoxGeometry(4, 5, 1), matWood);
        shelfBody.position.y = 2.5; shelfBody.castShadow = true; addOutline(shelfBody, shelfBody.geometry); shelf.add(shelfBody);

        // Prop: Joy Cannon (Cylinder)
        const cannonGeo = new THREE.CylinderGeometry(0.3, 0.3, 0.8);
        const cannon = new THREE.Mesh(cannonGeo, matPink);
        cannon.position.set(1, 5.2, 0); cannon.rotation.z = 0.2;
        addOutline(cannon, cannonGeo);
        cannon.userData = { name: "Party Cannon", desc: "Ready to Celebrate" };
        shelf.add(cannon);

        // 4. Lounge (Haven)
        const lounge = new THREE.Group(); lounge.position.set(3, 0, 3); room.add(lounge);
        const rug = new THREE.Mesh(new THREE.CylinderGeometry(3, 3, 0.05, 32), matAccent);
        rug.position.y = 0.05; rug.receiveShadow = true; lounge.add(rug);

        // Prop: Tea Set
        const teaTable = new THREE.Mesh(new THREE.CylinderGeometry(0.8,0.8,0.5), matWood);
        teaTable.position.set(0, 0.25, 0); addOutline(teaTable, teaTable.geometry); lounge.add(teaTable);
        const pot = new THREE.Mesh(new THREE.SphereGeometry(0.3), matWall);
        pot.position.set(0, 0.7, 0); addOutline(pot, pot.geometry);
        pot.userData = { name: "Tea Pot", desc: "Warmth Serving" }; lounge.add(pot);

        // 5. The Box Cat (Blocky)
        const catGroup = new THREE.Group();
        catGroup.position.set(4, 0.5, 4);
        catGroup.rotation.y = -Math.PI/4;
        room.add(catGroup);

        // Body
        const catBodyGeo = new THREE.BoxGeometry(0.6, 0.5, 0.9);
        const catBody = new THREE.Mesh(catBodyGeo, matYellow);
        catBody.castShadow = true; addOutline(catBody, catBodyGeo);
        catBody.userData = { name: "Box Cat", desc: "The Guardian", type: "cat" };
        catGroup.add(catBody);

        // Head
        const catHeadGroup = new THREE.Group();
        catHeadGroup.position.set(0, 0.4, 0.4);
        catGroup.add(catHeadGroup);

        const headGeo = new THREE.BoxGeometry(0.7, 0.6, 0.6);
        const head = new THREE.Mesh(headGeo, matYellow);
        addOutline(head, headGeo); catHeadGroup.add(head);

        // Ears
        const earGeo = new THREE.ConeGeometry(0.15, 0.3, 4);
        const earL = new THREE.Mesh(earGeo, matDark); earL.position.set(-0.2, 0.45, 0); catHeadGroup.add(earL);
        const earR = new THREE.Mesh(earGeo, matDark); earR.position.set(0.2, 0.45, 0); catHeadGroup.add(earR);

        // Tail
        const tailGeo = new THREE.BoxGeometry(0.1, 0.1, 0.8);
        const tail = new THREE.Mesh(tailGeo, matYellow);
        tail.position.set(0, 0.2, -0.6); tail.rotation.x = 0.5;
        addOutline(tail, tailGeo); catGroup.add(tail);


        // 6. Corkboard (Plans)
        const boardGroup = new THREE.Group(); boardGroup.position.set(-6.9, 4, 2); room.add(boardGroup);
        const board = new THREE.Mesh(new THREE.BoxGeometry(0.1, 3, 4), matWood);
        addOutline(board, board.geometry); boardGroup.add(board);

        // Prop: Whiteboard
        const wbGeo = new THREE.BoxGeometry(0.15, 1.5, 2.5);
        const wb = new THREE.Mesh(wbGeo, matWall);
        wb.position.set(0.1, 0, 0); addOutline(wb, wbGeo);
        wb.userData = { name: "Plan Board", desc: "Gathering Protocol: Active" };
        boardGroup.add(wb);


        // --- Interaction ---
        let scrollY = 0;
        let targetCamPos = new THREE.Vector3(20, 20, 20);
        let targetZoom = 1;
        let targetLookAt = new THREE.Vector3(0,0,0);
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2(-1, -1);
        let isNight = false;

        window.addEventListener('scroll', () => {
            scrollY = window.scrollY;
            const progress = scrollY / (document.body.scrollHeight - window.innerHeight);

            if(progress < 0.1) { // Hero
                targetCamPos.set(20, 20, 20); targetZoom = 1; targetLookAt.set(0,0,0);
            } else if(progress < 0.35) { // Desk
                targetCamPos.set(-5, 10, 5); targetZoom = 2; targetLookAt.set(-4, 2, -4);
            } else if(progress < 0.6) { // Shelf
                targetCamPos.set(5, 8, -5); targetZoom = 2; targetLookAt.set(0, 3, -6.5);
            } else if(progress < 0.85) { // Lounge
                targetCamPos.set(5, 10, 5); targetZoom = 2; targetLookAt.set(3, 1, 3);
            } else { // Board
                targetCamPos.set(-10, 10, 10); targetZoom = 2; targetLookAt.set(-6.9, 4, 2);
            }
        });

        window.addEventListener('mousemove', (e) => {
            mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
            tooltip.style.left = e.clientX + 'px'; tooltip.style.top = e.clientY + 'px';
        });

        // Switch
        const switchGeo = new THREE.BoxGeometry(0.1, 0.4, 0.4);
        const switchMesh = new THREE.Mesh(switchGeo, matDark);
        switchMesh.position.set(-7, 3, 2);
        switchMesh.userData = { name: "Light Switch", desc: "Toggle Mode", type: "switch" };
        room.add(switchMesh);

        modeSwitch.addEventListener('click', (e) => { e.stopPropagation(); toggleNightMode(); });
        window.addEventListener('click', () => {
            if(!hoveredObj) return;
            if (hoveredObj.userData.type === 'switch') toggleNightMode();
            if (hoveredObj.userData.type === 'cat') {
                gsap.to(catGroup.position, { y: 1.5, duration: 0.2, yoyo: true, repeat: 1 });
            }
        });

        function toggleNightMode() {
            isNight = !isNight;
            modeSwitch.innerText = isNight ? 'ğŸŒ™' : 'â˜€';
            if (isNight) {
                document.body.classList.add('night-mode');
                gsap.to(scene.background, { r: 43/255, g: 43/255, b: 43/255, duration: 1 });
                gsap.to(ambientLight, { intensity: 0.2, duration: 1 });
                gsap.to(dirLight, { intensity: 0.2, duration: 1 });
            } else {
                document.body.classList.remove('night-mode');
                gsap.to(scene.background, { r: 249/255, g: 247/255, b: 241/255, duration: 1 });
                gsap.to(ambientLight, { intensity: 0.7, duration: 1 });
                gsap.to(dirLight, { intensity: 0.8, duration: 1 });
            }
        }

        // Loop
        let hoveredObj = null;
        function animate() {
            requestAnimationFrame(animate);
            const time = Date.now() * 0.001;

            camera.position.lerp(targetCamPos, 0.05);
            camera.zoom += (targetZoom - camera.zoom) * 0.05;
            camera.updateProjectionMatrix();
            if(!window.camTarget) window.camTarget = new THREE.Vector3(0,0,0);
            window.camTarget.lerp(targetLookAt, 0.05);
            camera.lookAt(window.camTarget);

            // Animate Props
            balloon.position.y = 3.5 + Math.sin(time)*0.2;
            balloon.rotation.z = Math.sin(time*0.5)*0.1;

            // Cat Head Track
            if(catHeadGroup) {
                catHeadGroup.lookAt(targetLookAt.x + mouse.x*5, 2, targetLookAt.z - mouse.y*5);
            }
            // Tail Wag
            tail.rotation.y = Math.sin(time * 5) * 0.2;

            // Raycast
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(room.children, true);
            let hit = null;
            for(let i=0; i<intersects.length; i++) {
                let obj = intersects[i].object;
                while(obj.parent && obj.parent !== room && !obj.userData.name) obj = obj.parent;
                if(obj.userData.name) { hit = obj; break; }
            }

            if(hit) {
                document.body.style.cursor = 'pointer';
                tooltip.style.opacity = 1;
                tooltip.innerHTML = `<strong>${hit.userData.name}</strong><br>${hit.userData.desc}`;

                if (!hit.userData.originalScale) hit.userData.originalScale = hit.scale.clone();
                const targetScale = hit.userData.originalScale.clone().multiplyScalar(1.1);
                hit.scale.lerp(targetScale, 0.2);
                hoveredObj = hit;
            } else {
                document.body.style.cursor = 'default';
                tooltip.style.opacity = 0;
                hoveredObj = null;
            }

            // Reset
            room.traverse(obj => {
                if (obj.userData.originalScale && obj !== hit) {
                    obj.scale.lerp(obj.userData.originalScale, 0.1);
                }
            });

            renderer.render(scene, camera);
        }
        animate();

        gsap.registerPlugin(ScrollTrigger);
        gsap.utils.toArray('.gs-reveal').forEach(elem => {
            gsap.to(elem, {
                y: 0, opacity: 1, duration: 1, ease: "power2.out",
                scrollTrigger: { trigger: elem, start: "top 85%", toggleActions: "play reverse play reverse" }
            });
        });

        window.addEventListener('resize', () => {
            const aspect = window.innerWidth / window.innerHeight;
            camera.left = -d * aspect; camera.right = d * aspect;
            camera.top = d; camera.bottom = -d;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

    </script>
</body>
</html>