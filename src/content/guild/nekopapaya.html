<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEKOPAPAYA | The Luminous Haven</title>
    <meta name="description" content="NEKOPAPAYA - 人體狀態觀察分析師 | 康樂股長 | 避風港">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;700&family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js" defer></script>

    <!-- Three.js Import Map -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <style>
        :root {
            /* Palette: Luminous */
            --c-text-light: #F9F7F1;
            --c-text-dark: #2D3436;
            --c-accent: #EAC435;

            --f-en: 'Nunito', sans-serif;
            --f-zh: 'Noto Serif TC', serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background-color: #111; /* Start dark */
            color: var(--c-text-light);
            font-family: var(--f-zh);
            overflow-x: hidden;
            line-height: 1.7;
        }

        #webgl-container { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 0; }

        /* UI Layer */
        .scroller { position: relative; z-index: 10; pointer-events: none; }
        .interactive-layer { pointer-events: auto; }

        .section {
            height: 100vh;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            position: relative;
            text-align: center;
            padding: 2rem;
        }

        /* --- Typography --- */
        h1 {
            font-family: var(--f-en); font-weight: 300; font-size: clamp(3rem, 8vw, 6rem);
            letter-spacing: 0.1em; margin-bottom: 1rem;
            text-shadow: 0 0 20px rgba(255,255,255,0.5);
        }
        h2 {
            font-family: var(--f-en); font-weight: 700; font-size: 1rem;
            text-transform: uppercase; letter-spacing: 0.3em;
            color: var(--c-accent); margin-bottom: 2rem;
        }
        p {
            font-size: 1.2rem; max-width: 600px; margin: 0 auto 1.5rem;
            text-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }

        .glass-panel {
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            padding: 3rem;
            border-radius: 100px;
            border: 1px solid rgba(255,255,255,0.1);
            transform: translateY(30px); opacity: 0;
        }

        .light-theme .glass-panel {
            background: rgba(255, 255, 255, 0.3);
            border: 1px solid rgba(255,255,255,0.4);
            color: #2c2c2c;
            text-shadow: none;
        }
        .light-theme h1 { text-shadow: none; color: #2c2c2c; }
        .light-theme p { text-shadow: none; color: #4a4a4a; }
        .light-theme h2 { color: #8A6E00; /* Darker Gold for contrast */ }

        /* Avatar */
        .avatar-frame {
            width: 120px; height: 120px; border-radius: 50%;
            margin: 0 auto 1.5rem;
            border: 2px solid rgba(255,255,255,0.2);
            overflow: hidden;
            box-shadow: 0 0 20px rgba(255,255,255,0.2);
        }
        .avatar-frame img { width: 100%; height: 100%; object-fit: cover; }
        .light-theme .avatar-frame { border-color: rgba(0,0,0,0.1); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }

        /* Socials */
        .social-link {
            display: inline-flex; align-items: center; justify-content: center;
            width: 60px; height: 60px; border-radius: 50%;
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3);
            color: white; font-size: 1.5rem; margin: 0 1rem;
            transition: 0.3s; text-decoration: none;
        }
        .social-link:hover { background: var(--c-accent); border-color: var(--c-accent); transform: scale(1.1); }

        .light-theme .social-link {
            background: rgba(0,0,0,0.05); border-color: rgba(0,0,0,0.1); color: #2c2c2c;
        }
        .light-theme .social-link:hover { color: white; }

        /* Nav */
        .nav-fixed {
            position: fixed; top: 2rem; left: 2rem; z-index: 50;
            font-family: var(--f-en); font-weight: 700;
            color: white; text-decoration: none; opacity: 0.5; transition: 0.3s;
            pointer-events: auto;
        }
        .nav-fixed:hover { opacity: 1; }
        .light-theme .nav-fixed { color: #2c2c2c; }

    </style>
</head>
<body>

    <a href="/guild" class="nav-fixed">← GUILD</a>
    <div id="webgl-container"></div>

    <div class="scroller">

        <!-- 1. Outside: The Cold -->
        <section class="section">
            <div class="glass-panel interactive-layer gs-reveal">
                <div class="avatar-frame">
                    <img src="/assets/img/guild/nekopapaya/avatar.webp" alt="Avatar">
                </div>
                <h2>OBSERVER</h2>
                <h1>NEKOPAPAYA</h1>
                <p>"Hydrogen knocking on your soul."</p>
                <p style="font-size: 0.9rem; opacity: 0.7;">Scroll to Enter the Haven</p>
            </div>
        </section>

        <!-- 2. Transition: The Filter -->
        <section class="section">
            <div class="glass-panel interactive-layer gs-reveal">
                <h2>METHODOLOGY</h2>
                <p>無聲地觀察每個人的狀態與需求。<br>在熱鬧的背後，捕捉微弱的訊號。</p>
            </div>
        </section>

        <!-- 3. Inside: The Warmth -->
        <section class="section" id="inside-section">
            <div class="glass-panel interactive-layer gs-reveal">
                <h2>SAFE HAVEN</h2>
                <h1 style="font-size: 4rem;">WELCOME HOME.</h1>
                <p>這裡是一個可以停下來、坐一下的地方。<br>沒有強迫，只有邀請。</p>
            </div>
        </section>

        <!-- 4. Core: Connection -->
        <section class="section">
            <div class="glass-panel interactive-layer gs-reveal">
                <h2>SYNC PROTOCOL</h2>
                <p>魔人揪揪出動！將孤單的靈魂串連起來。<br>如果你剛好想參與，就可以私訊我。</p>
                <div style="margin-top: 2rem;">
                    <a href="https://www.threads.net/@nekopapaya" target="_blank" class="social-link"><i class="fa-brands fa-threads"></i></a>
                    <a href="https://www.instagram.com/nekopapaya/" target="_blank" class="social-link"><i class="fa-brands fa-instagram"></i></a>
                </div>
            </div>
        </section>

    </div>

    <!-- SCRIPT -->
    <script type="module">
        import * as THREE from 'three';

        // --- Setup ---
        const container = document.getElementById('webgl-container');
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x050510, 0.05); // Start dark fog

        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 100);
        camera.position.set(0, 0, 15);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        // Tone mapping for glow
        renderer.toneMapping = THREE.ReinhardToneMapping;
        container.appendChild(renderer.domElement);

        // --- Objects ---

        // 1. The Dome (Igloo)
        // Icosahedron with glass material
        const domeGeo = new THREE.IcosahedronGeometry(6, 2);
        const domeMat = new THREE.MeshPhysicalMaterial({
            color: 0xffffff,
            roughness: 0.1,
            metalness: 0.1,
            transmission: 0.9,
            thickness: 2.0,
            ior: 1.5,
            side: THREE.DoubleSide,
            clearcoat: 1.0,
            clearcoatRoughness: 0.1
        });
        const dome = new THREE.Mesh(domeGeo, domeMat);
        scene.add(dome);

        // Wireframe overlay for "Tech" feel
        const wireGeo = new THREE.WireframeGeometry(domeGeo);
        const wireMat = new THREE.LineBasicMaterial({ color: 0x88ccff, transparent: true, opacity: 0.1 });
        const wire = new THREE.LineSegments(wireGeo, wireMat);
        dome.add(wire);

        // 2. The Core (Hearth) - Inside
        const coreGeo = new THREE.SphereGeometry(1, 32, 32);
        const coreMat = new THREE.MeshBasicMaterial({ color: 0xFFD700 });
        const core = new THREE.Mesh(coreGeo, coreMat);
        scene.add(core);

        // Core Glow (Sprite)
        const spriteMat = new THREE.SpriteMaterial({
            map: new THREE.TextureLoader().load('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/sprites/glow.png'), // Use standard glow asset or procedural? Let's make procedural canvas to be safe.
            color: 0xFFD700, transparent: true, opacity: 0.8, blending: THREE.AdditiveBlending
        });

        // Canvas Texture for Glow
        const canvas = document.createElement('canvas'); canvas.width=64; canvas.height=64;
        const ctx = canvas.getContext('2d');
        const grad = ctx.createRadialGradient(32,32,0, 32,32,32);
        grad.addColorStop(0, 'rgba(255, 255, 255, 1)');
        grad.addColorStop(1, 'rgba(0, 0, 0, 0)');
        ctx.fillStyle = grad; ctx.fillRect(0,0,64,64);
        const glowTex = new THREE.CanvasTexture(canvas);
        spriteMat.map = glowTex;

        const coreGlow = new THREE.Sprite(spriteMat);
        coreGlow.scale.set(8, 8, 1);
        core.add(coreGlow);

        // 3. Particles (Snow -> Embers)
        const pCount = 500;
        const pGeo = new THREE.BufferGeometry();
        const pPos = new Float32Array(pCount * 3);
        const pVel = new Float32Array(pCount); // Fall speed

        for(let i=0; i<pCount; i++) {
            pPos[i*3] = (Math.random()-0.5) * 40;
            pPos[i*3+1] = (Math.random()-0.5) * 40;
            pPos[i*3+2] = (Math.random()-0.5) * 40;
            pVel[i] = Math.random() * 0.05 + 0.02;
        }
        pGeo.setAttribute('position', new THREE.BufferAttribute(pPos, 3));
        const pMat = new THREE.PointsMaterial({
            color: 0x88ccff, size: 0.2, transparent: true, opacity: 0.6, blending: THREE.AdditiveBlending
        });
        const particles = new THREE.Points(pGeo, pMat);
        scene.add(particles);


        // --- Lights ---
        const ambient = new THREE.AmbientLight(0x404040); // Dim outside
        scene.add(ambient);

        const warmPoint = new THREE.PointLight(0xFFD700, 2, 20); // Warm inside
        warmPoint.position.set(0,0,0);
        scene.add(warmPoint);


        // --- Interaction ---
        let scrollY = 0;
        let insideState = 0; // 0 = Outside, 1 = Inside

        window.addEventListener('scroll', () => {
            scrollY = window.scrollY;
            const maxScroll = document.body.scrollHeight - window.innerHeight;
            const progress = scrollY / maxScroll;

            // Camera Journey
            // 0.0 -> 0.3: Orbit Outside
            // 0.3 -> 0.6: Penetrate Wall (Z: 15 -> 0)
            // 0.6 -> 1.0: Rotate Inside

            if (progress < 0.3) {
                // Outside
                const angle = progress * 2;
                camera.position.x = Math.sin(angle) * 15;
                camera.position.z = Math.cos(angle) * 15;
                camera.position.y = 0;
                setTheme(0);
            } else if (progress < 0.6) {
                // Transition
                const t = (progress - 0.3) / 0.3; // 0 to 1
                // Easing into the core
                camera.position.x = Math.sin(0.6) * 15 * (1-t);
                camera.position.z = Math.cos(0.6) * 15 * (1-t) + t * 4; // End at z=4 inside
                setTheme(t);
            } else {
                // Inside
                const t = (progress - 0.6) / 0.4;
                camera.position.z = 4 - t * 1; // Slight push in
                camera.position.x = Math.sin(t) * 2; // Slight orbit inside
                camera.position.y = Math.cos(t * 2) * 0.5;
                setTheme(1);
            }
            camera.lookAt(0, 0, 0);
        });

        // Theme Switcher (Visuals)
        function setTheme(t) {
            // t = 0 (Dark/Cold) -> 1 (Light/Warm)

            // Fog Color: Dark Blue -> Warm Cream
            const c1 = new THREE.Color(0x050510);
            const c2 = new THREE.Color(0xF9F7F1); // Paper
            scene.fog.color.lerpColors(c1, c2, t);

            // Particle Color: Blue -> Gold
            const p1 = new THREE.Color(0x88ccff);
            const p2 = new THREE.Color(0xFFD700);
            pMat.color.lerpColors(p1, p2, t);

            // Background Color
            const bg1 = new THREE.Color(0x111111);
            const bg2 = new THREE.Color(0xF4F1EC);
            renderer.setClearColor(bg1.lerp(bg2, t));

            // CSS Theme (Threshold)
            if(t > 0.5) {
                document.body.classList.add('light-theme');
            } else {
                document.body.classList.remove('light-theme');
            }
        }


        // Animation Loop
        function animate() {
            requestAnimationFrame(animate);
            const time = Date.now() * 0.001;

            // Rotate Dome
            dome.rotation.y = time * 0.05;

            // Pulse Core
            const pulse = 1 + Math.sin(time * 2) * 0.1;
            core.scale.setScalar(pulse);
            coreGlow.scale.setScalar(8 * pulse);

            // Particles
            const pos = pGeo.attributes.position.array;
            for(let i=0; i<pCount; i++) {
                // Gravity
                pos[i*3+1] -= pVel[i];

                // Wrap around
                if(pos[i*3+1] < -20) pos[i*3+1] = 20;

                // Spiral motion
                const x = pos[i*3];
                const z = pos[i*3+2];
                pos[i*3] = x * Math.cos(0.01) - z * Math.sin(0.01);
                pos[i*3+2] = x * Math.sin(0.01) + z * Math.cos(0.01);
            }
            pGeo.attributes.position.needsUpdate = true;

            renderer.render(scene, camera);
        }
        animate();

        // GSAP
        gsap.registerPlugin(ScrollTrigger);
        gsap.utils.toArray('.gs-reveal').forEach(elem => {
            gsap.to(elem, {
                y: 0, opacity: 1, duration: 1, ease: "power2.out",
                scrollTrigger: { trigger: elem, start: "top 85%", toggleActions: "play reverse play reverse" }
            });
        });

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

    </script>
</body>
</html>