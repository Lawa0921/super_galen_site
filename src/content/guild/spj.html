<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¡è¶´å· - é…’é¤¨è€é—†</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Noto+Serif+TC:wght@400;700;900&family=IM+Fell+English+SC&display=swap" rel="stylesheet">

    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/TextPlugin.min.js"></script>

    <style>
        :root {
            --bg-dark: #120a05;
            --ui-bg: rgba(45, 30, 20, 0.95);
            --ui-border: #a1887f;
            --text-gold: #ffd54f;
            --text-white: #fff3e0;
            --wood-dark: #3e2723;
            --wood-light: #5d4037;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background-color: var(--bg-dark);
            color: var(--text-white);
            font-family: 'Noto Serif TC', serif;
            overflow: hidden; /* Locked until door opens */
        }

        #canvas-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0;
        }

        /* --- Intro Door Overlay --- */
        #door-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 2000;
            display: flex;
            cursor: pointer;
        }

        .door-panel {
            width: 50%; height: 100%;
            background-color: #25160c;
            /* Wood Texture */
            background-image: repeating-linear-gradient(90deg, #25160c 0, #1a0f08 20px, #2e1b0f 40px);
            position: relative;
            box-shadow: inset 0 0 100px #000;
            transition: transform 1.5s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex; align-items: center; justify-content: center;
        }

        .door-left { border-right: 2px solid #000; }
        .door-right { border-left: 2px solid #000; }

        .door-handle {
            width: 20px; height: 100px;
            background: #8d6e63;
            border-radius: 10px;
            box-shadow: 2px 2px 10px #000;
        }

        #door-overlay.open .door-left { transform: translateX(-100%); }
        #door-overlay.open .door-right { transform: translateX(100%); }

        .door-hint {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: var(--text-gold); font-family: 'Cinzel'; font-size: 2rem;
            text-shadow: 0 0 20px #000;
            z-index: 2001; pointer-events: none;
            transition: opacity 0.5s;
        }
        #door-overlay.open .door-hint { opacity: 0; }

        /* --- Scroll Track --- */
        .scroll-track { height: 500vh; }

        /* --- UI Layer --- */
        #ui-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            z-index: 10;
            opacity: 0; /* Hidden until door opens */
            transition: opacity 1s;
        }
        #ui-layer.visible { opacity: 1; }

        /* Return Nav */
        .nav-return {
            position: fixed; top: 2rem; left: 2rem;
            color: var(--text-gold); text-decoration: none;
            font-family: 'Cinzel'; font-size: 0.9rem; letter-spacing: 2px;
            pointer-events: auto; background: rgba(0,0,0,0.6); padding: 10px 20px;
            border: 1px solid var(--ui-border);
            transition: 0.3s;
        }
        .nav-return:hover { background: var(--text-gold); color: #000; }

        /* Character Sprite */
        .char-container {
            position: absolute;
            bottom: 30vh; right: 10vw;
            width: 350px; height: 350px;
            transition: transform 0.5s ease-out;
            pointer-events: none;
        }
        .char-img {
            width: 100%; height: 100%; object-fit: cover;
            border-radius: 50%;
            border: 4px solid var(--text-gold);
            box-shadow: 0 0 50px rgba(255, 183, 77, 0.3);
            background: #000;
        }
        .speaker-tag {
            position: absolute; bottom: -15px; left: 50%; transform: translateX(-50%);
            background: #3e2723; color: var(--text-gold);
            padding: 5px 15px; border: 1px solid var(--text-gold);
            font-family: 'Cinzel'; font-size: 0.8rem;
        }

        /* Dialogue Box */
        .dialogue-box {
            position: absolute;
            bottom: 5vh; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 800px; height: 22vh;
            background: var(--ui-bg);
            border: 4px double var(--ui-border);
            border-radius: 8px;
            padding: 2rem;
            pointer-events: auto;
            box-shadow: 0 10px 50px rgba(0,0,0,0.9);
            display: flex; flex-direction: column;
        }
        .dialogue-text {
            font-size: 1.2rem; line-height: 1.8; color: #eceff1;
            flex: 1;
        }
        .dialogue-prompt {
            text-align: right; color: var(--text-gold); font-family: 'Cinzel';
            font-size: 0.8rem; opacity: 0.7; animation: pulse 1s infinite;
        }
        @keyframes pulse { 50% { opacity: 0.3; } }

        /* Parchment Overlay (Quest Log) */
        #quest-parchment {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.8);
            width: 90%; max-width: 700px; height: 80vh;
            background: #f0e6d2;
            box-shadow: 0 20px 60px rgba(0,0,0,0.9);
            padding: 4rem 3rem;
            opacity: 0; pointer-events: none;
            z-index: 20;
            color: #3e2723;
            overflow-y: auto;
            clip-path: polygon(0 2%, 2% 0, 98% 0, 100% 2%, 100% 98%, 98% 100%, 2% 100%, 0 98%);
            transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.5s;
            /* Simple noise texture */
            background-image: url('data:image/svg+xml;utf8,<svg width="100" height="100" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.5" numOctaves="3"/></filter><rect width="100%" height="100%" filter="url(%23n)" opacity="0.15"/></svg>');
        }

        #quest-parchment.visible {
            opacity: 1; pointer-events: auto;
            transform: translate(-50%, -50%) scale(1);
        }

        .parchment-header {
            text-align: center; font-family: 'Cinzel'; font-size: 2.5rem;
            border-bottom: 2px solid #3e2723; padding-bottom: 1rem; margin-bottom: 2rem;
            color: #5d4037; font-weight: bold;
        }

        .quest-item {
            margin-bottom: 2rem; border-bottom: 1px dashed rgba(62, 39, 35, 0.3); padding-bottom: 1rem;
        }
        .quest-title {
            font-family: 'Cinzel'; font-weight: bold; font-size: 1.4rem;
            display: flex; justify-content: space-between; color: #3e2723;
        }
        .quest-desc {
            font-family: 'Noto Serif TC'; font-size: 1.1rem; color: #5d4037; margin-top: 0.5rem; line-height: 1.6;
        }

        .seal-close {
            position: absolute; top: 1rem; right: 1rem;
            width: 40px; height: 40px;
            background: #8b0000; color: #fff;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-weight: bold; cursor: pointer;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.4);
        }

        /* Skill Board */
        #skill-board {
            position: absolute; top: 20vh; left: 15vw;
            width: 320px;
            background: #3e2723;
            border: 6px solid #25160c;
            padding: 2rem;
            transform: rotate(-2deg);
            box-shadow: 5px 10px 20px rgba(0,0,0,0.6);
            opacity: 0;
        }
        .skill-title { text-align: center; border-bottom: 1px solid #a1887f; padding-bottom: 10px; margin-bottom: 1rem; font-family: 'Cinzel'; font-size: 1.5rem; color: #ffd54f; }
        .skill-list li { margin-bottom: 0.8rem; font-family: 'Noto Serif TC'; color: #d7ccc8; font-size: 1.1rem; }

        /* Footer Socials */
        .footer-socials {
            position: fixed; bottom: 2rem; right: 2rem;
            display: flex; gap: 1rem;
            pointer-events: auto;
            opacity: 0;
        }
        .social-btn {
            background: var(--text-gold); color: #000;
            padding: 10px 20px; font-family: 'Cinzel';
            text-decoration: none; border-radius: 4px;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }

        /* Hover Hint */
        #hover-hint {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8); color: #fff; padding: 10px 20px;
            border-radius: 4px; pointer-events: none; opacity: 0; transition: opacity 0.2s;
            z-index: 100; font-family: 'Cinzel';
        }

    </style>
</head>
<body>

    <!-- Door Overlay -->
    <div id="door-overlay" onclick="enterTavern()">
        <div class="door-panel door-left"><div class="door-handle" style="margin-left: auto; margin-right: 10px;"></div></div>
        <div class="door-panel door-right"><div class="door-handle" style="margin-left: 10px;"></div></div>
        <div class="door-hint">CLICK TO ENTER</div>
    </div>

    <div id="canvas-container"></div>
    <div id="hover-hint">Interact</div>

    <a href="/guild/" class="nav-return">LEAVE TAVERN</a>

    <div class="scroll-track"></div>

    <div id="ui-layer">

        <div class="char-container" id="character">
            <img src="/assets/img/guild/spj/avatar.webp" class="char-img">
            <div class="speaker-tag">SPJ</div>
        </div>

        <div id="skill-board">
            <div class="skill-title">SPECIALS</div>
            <ul class="skill-list" style="list-style: none; padding: 0;">
                <li>ğŸº Code Synthesis (Lager)</li>
                <li>ğŸ· Materialization (Red)</li>
                <li>â˜• Mana Potion (Coffee)</li>
                <li>ğŸ“œ Legend Writing</li>
            </ul>
        </div>

        <div class="dialogue-box">
            <div class="dialogue-text" id="dialogue-text"></div>
            <div class="dialogue-prompt">â–¼ SCROLL TO CONTINUE</div>
        </div>

        <!-- Quest Log -->
        <div id="quest-parchment">
            <div class="seal-close" onclick="closeScroll()">X</div>
            <div class="parchment-header">QUEST LOG</div>

            <div class="quest-item">
                <div class="quest-title">TEXT TOWN <span style="color: #8b0000; font-size: 1rem;">RANK S</span></div>
                <div class="quest-desc">
                    ä»¥ã€Œå¤©æ›¸ç³»çµ±ã€ç‚ºæ ¸å¿ƒçš„å…·ç¾åŒ–å¯¦é©—ã€‚åœ¨é€™å€‹ä¸–ç•Œè£¡ï¼Œæ–‡å­—ä¸åƒ…æ˜¯æè¿°ï¼Œæ›´æ˜¯æ§‹æˆç‰©ç†æ³•å‰‡çš„åŸºçŸ³ã€‚æˆ‘è©¦åœ–ç”¨ä»£ç¢¼é‡å»ºæƒ³åƒåŠ›çš„é‚Šç•Œã€‚
                </div>
            </div>

            <div class="quest-item">
                <div class="quest-title">SEPAJUAN GUILD <span style="color: #8b0000; font-size: 1rem;">RANK A</span></div>
                <div class="quest-desc">
                    ç¾å¯¦ä¸–ç•Œçš„å†’éšªè€…é›†æ•£åœ°ã€‚é€™æ˜¯ä¸€å€‹é€£çµå‰µé€ è€…ã€é–‹ç™¼è€…èˆ‡å¤¢æƒ³å®¶çš„ Nexusã€‚æˆ‘å€‘åœ¨æ­¤çµ„éšŠã€åˆ†äº«è³‡æºï¼Œä¸¦ä¸€åŒæ”»ç•¥åç‚ºã€Œç¾å¯¦ã€çš„å‰¯æœ¬ã€‚
                </div>
            </div>

            <div class="quest-item">
                <div class="quest-title">CHRONICLES <span style="color: #8b0000; font-size: 1rem;">RANK B</span></div>
                <div class="quest-desc">
                    ç´€éŒ„é–‹ç™¼éç¨‹ä¸­çš„è¡€æ·šèˆ‡æ­¡ç¬‘ã€‚æˆ‘ä¸åªé—œæ³¨çµæœï¼Œæ›´åœ¨æ„é‚£ç‡ƒç‡’çš„éç¨‹ã€‚æ¯ä¸€è¡Œä»£ç¢¼èƒŒå¾Œï¼Œéƒ½æœ‰ä¸€å€‹å€¼å¾—è¢«å‚³å”±çš„æ•…äº‹ã€‚
                </div>
            </div>
        </div>

        <div class="footer-socials" id="footer-socials">
            <a href="https://www.threads.net/@spj.story" target="_blank" class="social-btn">THREADS</a>
        </div>

    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';

        // --- Init Scene ---
        const container = document.getElementById('canvas-container');
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x120a05, 0.02);

        const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 100);
        camera.position.set(0, 3, 20); // Start far out (outside door)

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 1.5));
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.toneMappingExposure = 1.3;
        container.appendChild(renderer.domElement);

        // --- Lighting ---
        const ambientLight = new THREE.AmbientLight(0xffe0b2, 0.8);
        scene.add(ambientLight);

        const candleLight = new THREE.PointLight(0xff5722, 2, 20);
        candleLight.position.set(2, 1.5, 1);
        candleLight.castShadow = true;
        scene.add(candleLight);

        // Fireplace Light (Background)
        const fireLight = new THREE.PointLight(0xff3d00, 3, 30);
        fireLight.position.set(5, 2, -10);
        scene.add(fireLight);

        // --- Textures (Procedural Wood) ---
        function createWoodTexture(color1, color2) {
            const canvas = document.createElement('canvas');
            canvas.width = 512; canvas.height = 512;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = color1;
            ctx.fillRect(0,0,512,512);

            // Grain
            ctx.fillStyle = color2;
            for(let i=0; i<5000; i++) {
                const x = Math.random() * 512;
                const y = Math.random() * 512;
                const w = Math.random() * 100 + 20;
                const h = Math.random() * 2 + 1;
                ctx.globalAlpha = 0.1;
                ctx.fillRect(x,y,w,h);
            }

            const tex = new THREE.CanvasTexture(canvas);
            tex.wrapS = THREE.RepeatWrapping;
            tex.wrapT = THREE.RepeatWrapping;
            return tex;
        }

        const woodTexDark = createWoodTexture('#3e2723', '#1a0f08');
        const woodTexLight = createWoodTexture('#5d4037', '#3e2723');

        // --- Environment ---
        const clickableObjects = [];

        // 1. Counter
        const tableMat = new THREE.MeshStandardMaterial({
            map: woodTexLight, roughness: 0.6, metalness: 0.1
        });
        const table = new THREE.Mesh(new THREE.BoxGeometry(30, 1, 15), tableMat);
        table.position.set(0, -1, 0);
        table.receiveShadow = true;
        scene.add(table);

        // 2. Back Wall & Fireplace
        const wallGroup = new THREE.Group();
        wallGroup.position.set(0, 0, -8);

        // Shelves
        const shelfGeo = new THREE.BoxGeometry(12, 0.3, 1.5);
        const s1 = new THREE.Mesh(shelfGeo, tableMat); s1.position.y = 2;
        const s2 = new THREE.Mesh(shelfGeo, tableMat); s2.position.y = 4;
        wallGroup.add(s1, s2);

        // Bottles (Interactive)
        const bottleGeo = new THREE.CylinderGeometry(0.25, 0.25, 1, 8);
        const bottleColors = [0xef5350, 0x66bb6a, 0x42a5f5, 0xffca28, 0xab47bc];

        for(let i=0; i<12; i++) {
            const mat = new THREE.MeshStandardMaterial({
                color: bottleColors[i%5],
                transparent: true, opacity: 0.9, roughness: 0.1
            });
            const b = new THREE.Mesh(bottleGeo, mat);
            b.position.set((i-6)*1.5, Math.random()>0.5?2.6:4.6, 0);
            b.userData = { id: 'bottle', flavor: i };
            wallGroup.add(b);
            // Hitbox for bottle
            const hit = new THREE.Mesh(new THREE.BoxGeometry(1, 2, 1), new THREE.MeshBasicMaterial({visible:false}));
            hit.position.copy(b.position);
            hit.position.z += -8; // World pos adjustment
            hit.position.y += 0;
            hit.userData = { id: 'bottle', flavor: i };
            clickableObjects.push(hit);
            scene.add(hit); // Add to scene, not group, for simpler raycast logic or need to calc world pos
        }
        // Note: Adding hits to scene requires correct world transforms.
        // Let's re-do bottle hitboxes to be simpler: Check intersection on bottle mesh itself?
        // Yes, scene.add(wallGroup) makes children world coords relative.
        // Raycaster handles nested objects if we recursive check.

        scene.add(wallGroup);
        // Add bottles to clickable directly
        wallGroup.children.forEach(c => {
            if(c.userData.id === 'bottle') clickableObjects.push(c);
        });

        // 3. Quest Book
        const bookGroup = new THREE.Group();
        const coverMat = new THREE.MeshStandardMaterial({ color: 0x3e2723, roughness: 0.8 });
        const book = new THREE.Mesh(new THREE.BoxGeometry(2, 0.3, 3), coverMat);
        const pages = new THREE.Mesh(new THREE.BoxGeometry(1.8, 0.15, 2.8), new THREE.MeshStandardMaterial({ color: 0xffffff }));
        pages.position.y = 0.15;
        bookGroup.add(book, pages);
        bookGroup.position.set(-2, -0.4, 3);
        bookGroup.rotation.y = 0.3;
        bookGroup.userData = { id: 'book' };
        scene.add(bookGroup);
        clickableObjects.push(book); // Raycast on book mesh

        // 4. Tankard
        const mugGroup = new THREE.Group();
        const mug = new THREE.Mesh(new THREE.CylinderGeometry(0.4, 0.5, 1.2, 16), new THREE.MeshStandardMaterial({ color: 0x8d6e63 }));
        mug.position.y = 0.6;
        mugGroup.add(mug);
        mugGroup.position.set(2, -0.5, 3);
        mugGroup.userData = { id: 'mug' };
        scene.add(mugGroup);
        clickableObjects.push(mug);

        // 5. Candle
        const candle = new THREE.Mesh(new THREE.CylinderGeometry(0.1, 0.1, 0.8, 8), new THREE.MeshStandardMaterial({color: 0xffffff}));
        candle.position.copy(candleLight.position);
        candle.position.y -= 0.5;
        scene.add(candle);

        // --- Door Interaction ---
        window.enterTavern = () => {
            document.getElementById('door-overlay').classList.add('open');
            document.body.style.overflow = 'auto'; // Unlock scroll

            // Camera Zoom In
            gsap.to(camera.position, {
                z: 8,
                y: 3,
                duration: 2,
                ease: "power2.inOut",
                onComplete: () => {
                    document.getElementById('ui-layer').classList.add('visible');
                    // Start dialogue
                    updateDialogue(0);
                }
            });
        };

        // --- Raycasting ---
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();

        window.addEventListener('click', (e) => {
            if (e.target.closest('a, button, .seal-close, #door-overlay')) return;

            mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(clickableObjects, true); // Recursive

            if (intersects.length > 0) {
                // Find parent with userData
                let target = intersects[0].object;
                while(target && !target.userData.id) { target = target.parent; }

                if (target) {
                    const id = target.userData.id;
                    if (id === 'book') openScroll();
                    if (id === 'mug') {
                        gsap.to(mugGroup.position, { y: 0.5, duration: 0.2, yoyo: true, repeat: 1 });
                        setDialogue("é€™æ¯é…’æ•¬ä½ ï¼ä¹¾æ¯ï¼");
                    }
                    if (id === 'bottle') {
                        const flavors = ["é€™ç“¶æ˜¯ã€Œé™¤éŒ¯è—¥æ°´ã€ï¼Œå‘³é“æœ‰é»è‹¦ã€‚", "é€™æ˜¯ã€Œéˆæ„Ÿé‡€ã€ï¼Œå–äº†æœƒæ•´æ™šç¡ä¸è‘—ã€‚", "ã€Œå›æ»¾å·è»¸ã€...å–”ä¸å°ï¼Œé€™æ˜¯é™³å¹´å¨å£«å¿Œã€‚", "å°å¿ƒï¼Œé‚£æ˜¯ã€Œç„¡é™è¿´åœˆã€çƒˆé…’ã€‚"];
                        setDialogue(flavors[target.userData.flavor % flavors.length]);
                    }
                }
            }
        });

        // Hover Hint
        window.addEventListener('mousemove', (e) => {
            mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(clickableObjects, true);
            const hint = document.getElementById('hover-hint');

            if (intersects.length > 0) {
                document.body.style.cursor = 'pointer';
                hint.style.opacity = 1;
                let target = intersects[0].object;
                while(target && !target.userData.id) { target = target.parent; }

                if (target && target.userData.id === 'book') hint.innerText = "READ LOG";
                else if (target && target.userData.id === 'mug') hint.innerText = "TOAST";
                else if (target && target.userData.id === 'bottle') hint.innerText = "INSPECT";
            } else {
                document.body.style.cursor = 'default';
                hint.style.opacity = 0;
            }
        });

        window.openScroll = () => {
            document.getElementById('quest-parchment').classList.add('visible');
        };
        window.closeScroll = () => {
            document.getElementById('quest-parchment').classList.remove('visible');
        };

        function setDialogue(text) {
            const el = document.getElementById('dialogue-text');
            el.innerHTML = text; // Direct update for interactions
        }

        // --- Animation Loop ---
        const clock = new THREE.Clock();
        function animate() {
            requestAnimationFrame(animate);
            const time = clock.getElapsedTime();
            candleLight.intensity = 2 + Math.sin(time * 10) * 0.3;
            fireLight.intensity = 3 + Math.sin(time * 5) * 0.5;
            renderer.render(scene, camera);
        }
        animate();

        // --- Scroll Narrative ---
        gsap.registerPlugin(ScrollTrigger);

        const script = [
            { text: "å˜¿ï¼Œæ­¡è¿å…‰è‡¨ï¼æˆ‘æ˜¯ SPJï¼Œé€™è£¡çš„é…’é¤¨è€é—†ã€‚", camera: { x:0, y:3, z:8 }, skill: false },
            { text: "çœ‹çœ‹ç‰†ä¸Šçš„èœå–®ï¼Œéƒ½æ˜¯æˆ‘çš„ç‰¹èª¿ã€‚ä»£ç¢¼èˆ‡é­”æ³•çš„æ··åˆé«”ã€‚", camera: { x: -2, y: 3.5, z: 6 }, skill: true },
            { text: "æ¡Œä¸Šé‚£æœ¬<span style='color:#ffd54f'>ã€Œä»»å‹™æ—¥èªŒã€</span>ï¼Œè¨˜è¼‰è‘—æˆ‘å°æ–‡å­—å°é®çš„æ§‹æƒ³ã€‚ä½ å¯ä»¥æ‰“é–‹çœ‹çœ‹ã€‚", camera: { x: -2, y: 1, z: 5 }, skill: false },
            { text: "æˆ‘å¸Œæœ›èƒ½å»ºç«‹ä¸€å€‹å…¬æœƒï¼Œè®“æ‰€æœ‰å‰µé€ è€…ä¸å†å­¤å–®ã€‚", camera: { x: 0, y: 3, z: 8 }, skill: false },
            { text: "æœŸå¾…ä½ çš„åŠ å…¥ï¼Œå†’éšªè€…ã€‚ç¥ä½ æ—…é€”æ„‰å¿«ï¼", camera: { x: 2, y: 1, z: 5 }, skill: false, footer: true }
        ];

        const textBox = document.getElementById('dialogue-text');

        // Helper to update dialogue
        function updateDialogue(idx) {
            if (textBox.dataset.index != idx) {
                textBox.dataset.index = idx;
                const beat = script[idx];
                gsap.to(textBox, { opacity: 0, duration: 0.2, onComplete: () => {
                    textBox.innerHTML = beat.text;
                    gsap.to(textBox, { opacity: 1, duration: 0.2 });
                }});

                if (beat.camera) {
                    gsap.to(camera.position, {
                        x: beat.camera.x, y: beat.camera.y, z: beat.camera.z,
                        duration: 1.5, ease: "power2.inOut"
                    });
                }

                gsap.to("#skill-board", { opacity: beat.skill ? 1 : 0 });
                gsap.to("#footer-socials", { opacity: beat.footer ? 1 : 0 });
            }
        }

        ScrollTrigger.create({
            trigger: ".scroll-track",
            start: "top top",
            end: "bottom bottom",
            onUpdate: (self) => {
                // Only update if door is open
                if (!document.getElementById('door-overlay').classList.contains('open')) return;

                const idx = Math.min(Math.floor(self.progress * script.length), script.length - 1);
                updateDialogue(idx);
            }
        });

        // Remove Loader
        window.addEventListener('load', () => {
            gsap.to("#loader", { opacity: 0, duration: 0.5, onComplete: () => document.getElementById("loader").remove() });
        });

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

    </script>
</body>
</html>
