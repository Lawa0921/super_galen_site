<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Â°ûË∂¥Âç∑ - ÈÖíÈ§®ËÄÅÈóÜ</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Noto+Serif+TC:wght@400;700;900&family=IM+Fell+English+SC&display=swap" rel="stylesheet">

    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/TextPlugin.min.js"></script>

    <style>
        :root {
            --bg-dark: #0f0a05;
            --ui-bg: rgba(30, 20, 10, 0.95);
            --ui-border: #8d6e63;
            --text-gold: #ffb74d;
            --text-white: #fbe9e7;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background-color: var(--bg-dark);
            color: var(--text-white);
            font-family: 'Noto Serif TC', serif;
            overflow-x: hidden;
        }

        #canvas-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
        }

        /* --- Scroll Track --- */
        .scroll-track { height: 500vh; }

        /* --- UI Layer --- */
        #ui-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        /* Return Nav */
        .nav-return {
            position: fixed; top: 2rem; left: 2rem;
            color: var(--text-gold); text-decoration: none;
            font-family: 'Cinzel'; font-size: 0.9rem; letter-spacing: 2px;
            pointer-events: auto; background: rgba(0,0,0,0.6); padding: 10px 20px;
            border: 1px solid var(--ui-border);
            transition: 0.3s;
        }
        .nav-return:hover { background: var(--text-gold); color: #000; }

        /* Character Sprite (Innkeeper) */
        .char-container {
            position: absolute;
            bottom: 30vh; right: 10vw; /* Positioned behind counter */
            width: 350px; height: 350px;
            transition: transform 0.5s ease-out;
        }
        .char-img {
            width: 100%; height: 100%; object-fit: cover;
            border-radius: 50%;
            border: 4px solid var(--text-gold);
            box-shadow: 0 0 50px rgba(255, 183, 77, 0.3);
            background: #000;
        }
        .speaker-tag {
            position: absolute; bottom: -15px; left: 50%; transform: translateX(-50%);
            background: #3e2723; color: var(--text-gold);
            padding: 5px 15px; border: 1px solid var(--text-gold);
            font-family: 'Cinzel'; font-size: 0.8rem;
        }

        /* Dialogue Box */
        .dialogue-box {
            position: absolute;
            bottom: 5vh; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 800px; height: 22vh;
            background: var(--ui-bg);
            border: 4px double var(--ui-border);
            border-radius: 8px;
            padding: 2rem;
            pointer-events: auto;
            box-shadow: 0 10px 50px rgba(0,0,0,0.9);
            display: flex; flex-direction: column;
        }
        .dialogue-text {
            font-size: 1.2rem; line-height: 1.8; color: #eceff1;
            flex: 1;
        }
        .dialogue-prompt {
            text-align: right; color: var(--text-gold); font-family: 'Cinzel';
            font-size: 0.8rem; opacity: 0.7; animation: pulse 1s infinite;
        }
        @keyframes pulse { 50% { opacity: 0.3; } }

        /* Interaction Overlay (Project Menu) */
        #project-menu {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 80%; max-width: 900px;
            background: rgba(20, 10, 5, 0.98);
            border: 2px solid var(--text-gold);
            padding: 3rem;
            display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
            opacity: 0; pointer-events: none; /* Hidden by default */
            z-index: 20;
        }

        .menu-visible { opacity: 1 !important; pointer-events: auto !important; }

        .menu-item {
            border: 1px solid #5d4037; padding: 1.5rem; text-align: center;
            transition: 0.3s; cursor: pointer;
        }
        .menu-item:hover { background: #3e2723; border-color: var(--text-gold); }
        .menu-item h3 { color: var(--text-gold); font-family: 'Cinzel'; margin-bottom: 0.5rem; }
        .menu-item p { font-size: 0.9rem; color: #ccc; }

        /* Skill Board (On Wall) */
        #skill-board {
            position: absolute; top: 20vh; left: 15vw;
            width: 300px;
            background: url('data:image/svg+xml;utf8,<svg width="100" height="100" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><rect width="100%" height="100%" fill="%233e2723"/></svg>');
            border: 8px solid #281a14;
            padding: 2rem;
            transform: rotate(-2deg);
            box-shadow: 5px 10px 20px rgba(0,0,0,0.5);
            opacity: 0; /* Animated in */
        }
        .skill-title { text-align: center; border-bottom: 2px solid #fff; padding-bottom: 5px; margin-bottom: 1rem; font-family: 'IM Fell English SC'; font-size: 1.5rem; }
        .skill-list li { margin-bottom: 0.5rem; font-family: 'Noto Serif TC'; }

        /* Instructions */
        .instructions {
            position: fixed; bottom: 30vh; width: 100%; text-align: center;
            color: var(--text-gold); font-family: 'Cinzel'; text-shadow: 0 0 5px #000;
            pointer-events: none; opacity: 0; transition: opacity 0.5s;
        }

        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #0f0a05; z-index: 9999;
            display: flex; align-items: center; justify-content: center;
            color: var(--text-gold); font-family: 'Cinzel'; letter-spacing: 5px;
        }

    </style>
</head>
<body>

    <div id="loader">OPENING TAVERN DOORS...</div>

    <div id="canvas-container"></div>
    <a href="/guild/" class="nav-return">LEAVE TAVERN</a>

    <div class="scroll-track"></div>

    <div id="ui-layer">

        <!-- Character -->
        <div class="char-container" id="character">
            <img src="/assets/img/guild/spj/avatar.webp" class="char-img">
            <div class="speaker-tag">SPJ</div>
        </div>

        <!-- Skill Board (Wall) -->
        <div id="skill-board">
            <div class="skill-title">TODAY'S SPECIALS</div>
            <ul class="skill-list" style="list-style: none; padding: 0;">
                <li>üç∫ Code Synthesis (Lager)</li>
                <li>üç∑ Materialization (Red)</li>
                <li>‚òï Coffee (Mana Potion)</li>
                <li>üìú Creative Writing</li>
            </ul>
        </div>

        <!-- Interaction Prompt -->
        <div class="instructions" id="interaction-hint">CLICK THE BOOK TO VIEW QUESTS</div>

        <!-- Dialogue Box -->
        <div class="dialogue-box">
            <div class="dialogue-text" id="dialogue-text"></div>
            <div class="dialogue-prompt">‚ñº SCROLL TO CONTINUE</div>
        </div>

        <!-- Project Menu (Overlay) -->
        <div id="project-menu">
            <div style="grid-column: 1/-1; text-align: center; font-family: 'Cinzel'; color: var(--text-gold); font-size: 2rem; margin-bottom: 1rem;">Quest Log</div>
            <div class="menu-item">
                <h3>Text Town</h3>
                <p>A world materialized from pure language.</p>
            </div>
            <div class="menu-item">
                <h3>Adventure Guild</h3>
                <p>The nexus for real-world creators.</p>
            </div>
            <div class="menu-item">
                <h3>Chronicles</h3>
                <p>Recording the warmth of the journey.</p>
            </div>
            <div style="grid-column: 1/-1; text-align: center; margin-top: 1rem;">
                <button onclick="closeMenu()" style="background:none; border:1px solid #8d6e63; color: #fff; padding: 5px 15px; cursor: pointer; font-family: 'Cinzel';">CLOSE</button>
            </div>
        </div>

    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';

        // --- Init Scene ---
        const container = document.getElementById('canvas-container');
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x0f0a05, 0.04);

        const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 100);
        camera.position.set(0, 3, 8); // Seated position

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 1.5));
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        container.appendChild(renderer.domElement);

        // --- Lighting ---
        const ambientLight = new THREE.AmbientLight(0xffb74d, 0.2);
        scene.add(ambientLight);

        // Candle Light (Warm, Flickering)
        const candleLight = new THREE.PointLight(0xff5722, 1.5, 15);
        candleLight.position.set(2, 1.5, 1);
        candleLight.castShadow = true;
        scene.add(candleLight);

        // Window Light (Cool, Blue) - From left
        const windowLight = new THREE.SpotLight(0x4fc3f7, 2);
        windowLight.position.set(-10, 5, 0);
        windowLight.target.position.set(0, 0, 0);
        windowLight.castShadow = true;
        scene.add(windowLight);
        scene.add(windowLight.target);

        // --- Environment ---
        const clickableObjects = [];

        // 1. Counter Table
        const tableGeo = new THREE.BoxGeometry(20, 1, 10);
        const tableMat = new THREE.MeshStandardMaterial({ color: 0x3e2723, roughness: 0.8 });
        const table = new THREE.Mesh(tableGeo, tableMat);
        table.position.set(0, -1, 0);
        table.receiveShadow = true;
        scene.add(table);

        // 2. The Quest Book (Interactive)
        const bookGroup = new THREE.Group();
        const coverGeo = new THREE.BoxGeometry(2, 0.3, 3);
        const coverMat = new THREE.MeshStandardMaterial({ color: 0x5d4037 });
        const book = new THREE.Mesh(coverGeo, coverMat);
        book.castShadow = true;

        // Pages
        const pageGeo = new THREE.BoxGeometry(1.8, 0.1, 2.8);
        const pageMat = new THREE.MeshStandardMaterial({ color: 0xf5f5f5 });
        const pages = new THREE.Mesh(pageGeo, pageMat);
        pages.position.y = 0.15;

        bookGroup.add(book, pages);
        bookGroup.position.set(-1.5, -0.4, 2);
        bookGroup.rotation.y = 0.5;
        bookGroup.userData = { id: 'book' };
        scene.add(bookGroup);
        clickableObjects.push(book); // Only cover is mesh, need to check intersection on group children or bounding box?
        // Simplification: Add hidden hitbox
        const bookHitbox = new THREE.Mesh(new THREE.BoxGeometry(2.5, 1, 3.5), new THREE.MeshBasicMaterial({visible:false}));
        bookHitbox.position.copy(bookGroup.position);
        bookHitbox.rotation.copy(bookGroup.rotation);
        bookHitbox.userData = { id: 'book' };
        scene.add(bookHitbox);
        clickableObjects.push(bookHitbox);

        // 3. Tankard (Interactive)
        const tankardGroup = new THREE.Group();
        const mugGeo = new THREE.CylinderGeometry(0.4, 0.5, 1.2, 16);
        const mugMat = new THREE.MeshStandardMaterial({ color: 0x8d6e63 });
        const mug = new THREE.Mesh(mugGeo, mugMat);
        mug.castShadow = true;
        mug.position.y = 0.6;

        // Foam
        const foamGeo = new THREE.CylinderGeometry(0.35, 0.35, 0.1, 16);
        const foamMat = new THREE.MeshStandardMaterial({ color: 0xffecb3 });
        const foam = new THREE.Mesh(foamGeo, foamMat);
        foam.position.y = 1.2;

        tankardGroup.add(mug, foam);
        tankardGroup.position.set(1.5, -0.5, 2.5);
        tankardGroup.userData = { id: 'mug' };
        scene.add(tankardGroup);

        const mugHitbox = new THREE.Mesh(new THREE.BoxGeometry(1, 2, 1), new THREE.MeshBasicMaterial({visible:false}));
        mugHitbox.position.copy(tankardGroup.position);
        mugHitbox.position.y += 0.5;
        mugHitbox.userData = { id: 'mug' };
        scene.add(mugHitbox);
        clickableObjects.push(mugHitbox);

        // 4. Candle
        const waxGeo = new THREE.CylinderGeometry(0.1, 0.1, 0.8, 8);
        const waxMat = new THREE.MeshStandardMaterial({ color: 0xffffff, emissive: 0xffaa00, emissiveIntensity: 0.2 });
        const candle = new THREE.Mesh(waxGeo, waxMat);
        candle.position.copy(candleLight.position);
        candle.position.y -= 0.5;
        scene.add(candle);

        // 5. Background Shelves
        const shelfGroup = new THREE.Group();
        const shelfGeo = new THREE.BoxGeometry(10, 0.2, 2);
        const shelf = new THREE.Mesh(shelfGeo, tableMat);
        shelf.position.set(0, 3, -5);
        shelfGroup.add(shelf);

        // Bottles
        const bottleGeo = new THREE.CylinderGeometry(0.2, 0.2, 1, 8);
        const bottleColors = [0xff0000, 0x00ff00, 0x0000ff, 0xffff00];
        for(let i=0; i<8; i++) {
            const mat = new THREE.MeshStandardMaterial({ color: bottleColors[i%4], transparent: true, opacity: 0.8 });
            const b = new THREE.Mesh(bottleGeo, mat);
            b.position.set(-4 + i*1.2, 3.6, -5);
            shelfGroup.add(b);
        }
        scene.add(shelfGroup);

        // --- Interaction Logic ---
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();

        window.addEventListener('click', (e) => {
            mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;

            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(clickableObjects);

            if (intersects.length > 0) {
                const id = intersects[0].object.userData.id;
                if (id === 'book') {
                    openMenu();
                } else if (id === 'mug') {
                    toastAnim();
                }
            }
        });

        // Toast Animation
        function toastAnim() {
            gsap.to(tankardGroup.position, { y: 0.5, duration: 0.2, yoyo: true, repeat: 1 });
            gsap.to(tankardGroup.rotation, { z: -0.2, duration: 0.2, yoyo: true, repeat: 1 });
            // Add particles? Simplified for performance
        }

        // --- Menu Logic ---
        window.openMenu = () => {
            document.getElementById('project-menu').classList.add('menu-visible');
        };
        window.closeMenu = () => {
            document.getElementById('project-menu').classList.remove('menu-visible');
        };

        // --- Animation Loop ---
        const clock = new THREE.Clock();

        function animate() {
            requestAnimationFrame(animate);
            const time = clock.getElapsedTime();

            // Flicker Candle
            candleLight.intensity = 1.5 + Math.sin(time * 10) * 0.3 + Math.cos(time * 25) * 0.2;

            // Float Foam
            foam.position.y = 1.2 + Math.sin(time * 2) * 0.02;

            renderer.render(scene, camera);
        }
        animate();

        // --- GSAP Narrative Director ---
        gsap.registerPlugin(ScrollTrigger, TextPlugin);

        // Script
        const script = [
            { text: "ÂòøÔºå‰Ω†‰æÜ‰∫Ü„ÄÇÂ§ñÈù¢Â§©Ê∞£‰∏çÂ•ΩÂêßÔºüÂø´ÈÄ≤‰æÜÊöñÊöñË∫´Â≠ê„ÄÇ", camera: { x:0, y:3, z:8 }, showSkill: false },
            { text: "ÈÄôË£°ÁöÑ„ÄåËèúÂñÆ„ÄçÈÇÑÁÆóË±êÂØå„ÄÇ‰Ω†Ë¶Å‰æÜÈªû‰ª£Á¢ºÁâπË™øÔºåÈÇÑÊòØÈóúÊñºÂÖ∑ÁèæÂåñÁöÑÊïÖ‰∫ãÔºü", camera: { x: -2, y: 3.5, z: 6 }, showSkill: true }, // Zoom to Wall
            { text: "ÊàëÊ≠£Âú®ÂØ´‰∏ÄÊú¨ÂÜíÈö™Êó•Ë™å... ÈóúÊñº„ÄåÊñáÂ≠óÂ∞èÈéÆ„ÄçÁöÑÂÇ≥Ë™™„ÄÇÂ¶ÇÊûú‰Ω†ÊúâËààË∂£ÔºåÂèØ‰ª•ÁøªÁøªÊ°å‰∏äÈÇ£Êú¨Êõ∏„ÄÇ", camera: { x: -1.5, y: 1, z: 4 }, showSkill: false, hint: true }, // Look at Book
            { text: "‰∏çÂè™ÊòØÊïÖ‰∫ã„ÄÇÊàëÈÇÑÊÉ≥Âª∫Á´ã‰∏ÄÂÄã„ÄåÂÖ¨ÊúÉ„Äç„ÄÇÈÄ£ÁµêÊâÄÊúâÂÉèÊàëÂÄëÈÄôÊ®£Â≠§Áç®ÁöÑÂâµÈÄ†ËÄÖ„ÄÇ", camera: { x: 0, y: 3, z: 8 }, showSkill: false }, // Back to Center
            { text: "ÈÄôÊùØÈÖíÊï¨‰Ω†ÔºåÊú™‰æÜÁöÑÂÜíÈö™Â§•‰º¥„ÄÇ‰πæÊùØÔºÅ", camera: { x: 1.5, y: 1, z: 4 }, showSkill: false } // Look at Mug
        ];

        const char = document.getElementById('character');
        const textBox = document.getElementById('dialogue-text');

        ScrollTrigger.create({
            trigger: ".scroll-track",
            start: "top top",
            end: "bottom bottom",
            onUpdate: (self) => {
                const p = self.progress;
                const idx = Math.min(Math.floor(p * script.length), script.length - 1);
                const beat = script[idx];

                // Update Text
                if (textBox.dataset.index != idx) {
                    textBox.dataset.index = idx;
                    gsap.to(textBox, { text: beat.text, duration: 1 });

                    // Camera Move
                    if (beat.camera) {
                        gsap.to(camera.position, {
                            x: beat.camera.x, y: beat.camera.y, z: beat.camera.z,
                            duration: 1.5, ease: "power2.inOut"
                        });
                    }

                    // Show/Hide Skill Board
                    if (beat.showSkill) {
                        gsap.to("#skill-board", { opacity: 1, x: 0, duration: 0.5 });
                    } else {
                        gsap.to("#skill-board", { opacity: 0, x: -50, duration: 0.5 });
                    }

                    // Show Hint
                    if (beat.hint) {
                        gsap.to("#interaction-hint", { opacity: 1, duration: 0.5, delay: 1 });
                    } else {
                        gsap.to("#interaction-hint", { opacity: 0, duration: 0.3 });
                    }
                }
            }
        });

        // Loader
        window.addEventListener('load', () => {
            gsap.to("#loader", { opacity: 0, duration: 0.5, onComplete: () => document.getElementById("loader").remove() });
        });

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

    </script>
</body>
</html>
