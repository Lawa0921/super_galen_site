<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>塞趴卷 - 具現化系鍊金術師</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Noto+Serif+TC:wght@400;700;900&family=VT323&display=swap" rel="stylesheet">

    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/TextPlugin.min.js"></script>

    <style>
        :root {
            --bg-dark: #1a100a;
            --ui-bg: rgba(20, 10, 5, 0.9);
            --ui-border: #d4af37;
            --text-gold: #ffcc00;
            --text-white: #f0f0f0;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background-color: var(--bg-dark);
            color: var(--text-white);
            font-family: 'Noto Serif TC', serif;
            overflow-x: hidden;
        }

        /* --- Background --- */
        #canvas-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
        }

        /* --- Scroll Track (Invisible) --- */
        .scroll-track {
            height: 600vh; /* 6 Narrative Beats */
        }

        /* --- Visual Novel UI --- */
        #vn-stage {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            z-index: 10;
            display: flex; flex-direction: column; justify-content: space-between;
        }

        /* Character Sprite Container */
        .char-container {
            position: absolute;
            bottom: 30vh; /* Sit above text box */
            left: 50%;
            transform: translateX(-50%);
            width: 300px; height: 300px;
            transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .char-img {
            width: 100%; height: 100%;
            object-fit: cover;
            border-radius: 50%;
            border: 4px solid var(--ui-border);
            box-shadow: 0 0 30px rgba(255, 200, 0, 0.3);
            background: #000;
        }

        .speaker-tag {
            position: absolute;
            bottom: -20px; left: 50%; transform: translateX(-50%);
            background: var(--ui-border);
            color: #000;
            font-family: 'Cinzel', serif;
            font-weight: bold;
            padding: 5px 20px;
            border-radius: 4px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }

        /* Dialogue Box */
        .dialogue-box {
            position: absolute;
            bottom: 5vh; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 800px;
            height: 20vh;
            background: var(--ui-bg);
            border: 3px double var(--ui-border);
            border-radius: 8px;
            padding: 2rem;
            pointer-events: auto;
            box-shadow: 0 10px 50px rgba(0,0,0,0.8);
            display: flex; flex-direction: column;
        }

        .dialogue-content {
            font-size: 1.2rem;
            line-height: 1.6;
            color: #eee;
            flex: 1;
        }

        .dialogue-hint {
            font-family: 'VT323', monospace;
            color: var(--text-gold);
            text-align: right;
            font-size: 1.2rem;
            animation: blink 1s infinite;
        }
        @keyframes blink { 50% { opacity: 0; } }

        /* Floating Content Panels (Projects) */
        .panel {
            position: absolute;
            top: 20vh;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid var(--ui-border);
            padding: 2rem;
            max-width: 400px;
            opacity: 0;
            transform: translateY(20px);
            pointer-events: auto;
        }

        .panel-title {
            color: var(--text-gold);
            font-family: 'Cinzel';
            font-size: 1.5rem;
            border-bottom: 1px solid #555;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
        }

        .panel-img {
            width: 100%; height: 150px;
            background: #333;
            margin-bottom: 1rem;
            border: 1px solid #555;
            object-fit: cover;
        }

        /* --- Navigation --- */
        .nav-return {
            position: fixed; top: 2rem; left: 2rem;
            color: var(--text-gold);
            text-decoration: none;
            font-family: 'Cinzel';
            font-weight: bold;
            pointer-events: auto;
            z-index: 100;
            background: rgba(0,0,0,0.5);
            padding: 10px;
            border: 1px solid var(--ui-border);
        }

        .loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 999;
            display: flex; align-items: center; justify-content: center;
            color: var(--text-gold); font-family: 'Cinzel'; font-size: 2rem;
        }

    </style>
</head>
<body>

    <div class="loader" id="loader">LOADING TAVERN...</div>

    <a href="/guild/" class="nav-return">EXIT GAME</a>

    <div id="canvas-container"></div>

    <!-- The Scroll Trigger -->
    <div class="scroll-track"></div>

    <!-- Visual Novel Stage -->
    <div id="vn-stage">

        <!-- Character -->
        <div class="char-container" id="character">
            <img src="/assets/img/guild/spj/avatar.webp" class="char-img">
            <div class="speaker-tag">SPJ</div>
        </div>

        <!-- Dialogue -->
        <div class="dialogue-box">
            <div class="dialogue-content" id="dialogue-text"></div>
            <div class="dialogue-hint">▼ SCROLL TO CONTINUE</div>
        </div>

        <!-- Pop-up Panels -->
        <!-- Panel 1: Text Town -->
        <div class="panel" id="panel-texttown" style="right: 10%;">
            <div class="panel-title">PROJECT: TEXT TOWN</div>
            <img src="https://placehold.co/400x200/1a100a/ffcc00?text=Text+Town" class="panel-img">
            <p>天書系統核心。<br>將語言轉化為物理現實的煉金術。</p>
        </div>

        <!-- Panel 2: Guild -->
        <div class="panel" id="panel-guild" style="left: 10%;">
            <div class="panel-title">SEPAJUAN GUILD</div>
            <img src="https://placehold.co/400x200/1a100a/ffcc00?text=Guild" class="panel-img">
            <p>現實世界的冒險者公會。<br>組隊、資源共享、情報交換。</p>
        </div>

        <!-- Panel 3: Stats -->
        <div class="panel" id="panel-stats" style="right: 15%;">
            <div class="panel-title">CHARACTER STATS</div>
            <p><strong>CLASS:</strong> Materialization Alchemist</p>
            <p><strong>SKILL:</strong> Code Synthesis</p>
            <p><strong>MANA:</strong> Coffee (High)</p>
            <div style="margin-top: 1rem; border-top: 1px dotted #555; padding-top: 0.5rem; text-align: center;">
                <a href="https://www.threads.net/@spj.story" target="_blank" style="color: var(--text-gold); text-decoration: none;">[ VIEW PROFILE ]</a>
            </div>
        </div>

    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';

        // --- Init Scene ---
        const container = document.getElementById('canvas-container');
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x1a100a, 0.02);

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 100);
        camera.position.z = 10;

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 1.5));
        container.appendChild(renderer.domElement);

        // --- Background Atmosphere ---
        // Floating Dust/Sparks
        const pCount = 500;
        const pGeo = new THREE.BufferGeometry();
        const pPos = new Float32Array(pCount * 3);
        for(let i=0; i<pCount*3; i++) {
            pPos[i] = (Math.random() - 0.5) * 40;
        }
        pGeo.setAttribute('position', new THREE.BufferAttribute(pPos, 3));
        const pMat = new THREE.PointsMaterial({
            color: 0xffcc00,
            size: 0.1,
            transparent: true,
            opacity: 0.6
        });
        const particles = new THREE.Points(pGeo, pMat);
        scene.add(particles);

        // Background Shelves/Beams (Abstract)
        const beams = new THREE.Group();
        const beamGeo = new THREE.BoxGeometry(1, 20, 1);
        const beamMat = new THREE.MeshBasicMaterial({ color: 0x2c1e14 });

        for(let i=0; i<10; i++) {
            const b = new THREE.Mesh(beamGeo, beamMat);
            b.position.set((i-5)*5, 0, -10 + Math.random()*5);
            beams.add(b);
        }
        scene.add(beams);

        // --- Animation Loop ---
        const clock = new THREE.Clock();
        function animate() {
            requestAnimationFrame(animate);
            const time = clock.getElapsedTime();

            particles.rotation.y = time * 0.05;
            beams.position.x = Math.sin(time * 0.1) * 2; // Subtle parallax sway

            renderer.render(scene, camera);
        }
        animate();

        // --- GSAP Logic (The Director) ---
        gsap.registerPlugin(ScrollTrigger, TextPlugin);

        // Remove Loader
        window.addEventListener('load', () => {
            gsap.to("#loader", { opacity: 0, duration: 0.5, onComplete: () => document.getElementById("loader").remove() });
        });

        // Narrative Script
        const script = [
            { text: "歡迎來到我的酒館，冒險者。我是這裡的負責人——塞趴卷 (SPJ)。" },
            { text: "如你所見，我是一名具現化系鍊金術師... 或者用你們的話說，軟體工程師。" },
            { text: "我正在進行一項名為「文字小鎮」的實驗。透過代碼，我能將純粹的語言轉化為物理現實。", panel: "#panel-texttown", pos: "left" },
            { text: "但一個人的力量是有限的。我夢想建立一個龐大的「冒險公會」，連結所有孤獨的創造者。", panel: "#panel-guild", pos: "right" },
            { text: "我們在這裡組隊、分享情報、紀錄傳說。每一個專案，都是一次偉大的遠征。", panel: "#panel-stats", pos: "center" },
            { text: "那麼，你準備好加入這場冒險了嗎？" }
        ];

        // Character & Text Logic
        const char = document.getElementById('character');
        const textBox = document.getElementById('dialogue-text');

        // Define Timeline based on Scroll
        // We use scrollTrigger to update the state index

        ScrollTrigger.create({
            trigger: ".scroll-track",
            start: "top top",
            end: "bottom bottom",
            onUpdate: (self) => {
                const p = self.progress;
                const idx = Math.min(Math.floor(p * script.length), script.length - 1);
                const beat = script[idx];

                // Update Text (Typewriter effect check)
                if (textBox.dataset.index != idx) {
                    textBox.dataset.index = idx;
                    gsap.to(textBox, { text: beat.text, duration: 1, ease: "none" });

                    // Character Movement
                    if (beat.pos === "left") {
                        gsap.to(char, { x: "-120%", scale: 0.8, duration: 0.5 });
                    } else if (beat.pos === "right") {
                        gsap.to(char, { x: "20%", scale: 0.8, duration: 0.5 }); // Move to right side
                    } else {
                        gsap.to(char, { x: "-50%", scale: 1, duration: 0.5 }); // Center
                    }

                    // Panel Management
                    document.querySelectorAll('.panel').forEach(p => {
                        gsap.to(p, { opacity: 0, y: 20, duration: 0.3 });
                    });

                    if (beat.panel) {
                        gsap.to(beat.panel, { opacity: 1, y: 0, duration: 0.5, delay: 0.2 });
                    }
                }
            }
        });

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

    </script>
</body>
</html>
