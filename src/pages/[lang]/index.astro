---
/**
 * RPG é¢¨æ ¼é¦–é 
 * å‹•æ…‹è·¯ç”±ï¼š/zh-TW/, /zh-CN/, /en/, /ja/, /ko/
 */
import BaseLayout from '@components/layout/BaseLayout.astro';
import LanguageSwitcher from '@components/i18n/LanguageSwitcher.astro';
import StatusBar from '@components/rpg/StatusBar.astro';
import GameTabs from '@components/rpg/GameTabs.astro';
import SkillTreePanel from '@components/rpg/SkillTreePanel.astro';
import InventoryPanel from '@components/rpg/InventoryPanel.astro';
import AchievementsPanel from '@components/rpg/AchievementsPanel.astro';
import WalletConnect from '@components/web3/WalletConnect.astro';
import { languages, type Language, useTranslations } from '@i18n/index';

export function getStaticPaths() {
  // æ”¯æ´çš„èªè¨€åˆ—è¡¨ï¼ˆå¿…é ˆåœ¨ getStaticPaths å…§å®šç¾©ï¼‰
  const supportedLangs = Object.keys(languages) as Language[];
  return supportedLangs.map((lang) => ({
    params: { lang },
  }));
}

const { lang } = Astro.params as { lang: Language };
const { t, all: trans } = useTranslations(lang);

// é é¢æ¨™é¡Œ
const pageTitle = trans.site?.title || "SuperGalen's Dungeon";
const pageDescription = trans.site?.description || 'RPG é¢¨æ ¼æŠ€è¡“éƒ¨è½æ ¼';

// å±¬æ€§è³‡æ–™
const attributes = [
  { key: 'STR', name: trans.attributes?.STR?.name || 'åŠ›é‡', value: 75, desc: trans.attributes?.STR?.desc || 'ç¨‹å¼ç¢¼çš„åŸ·è¡ŒåŠ›' },
  { key: 'INT', name: trans.attributes?.INT?.name || 'æ™ºåŠ›', value: 88, desc: trans.attributes?.INT?.desc || 'è§£æ±ºå•é¡Œçš„èƒ½åŠ›' },
  { key: 'BUG', name: trans.attributes?.BUG?.name || 'é™¤éŒ¯', value: 92, desc: trans.attributes?.BUG?.desc || 'ç™¼ç¾ä¸¦ä¿®å¾©éŒ¯èª¤' },
  { key: 'SAN', name: trans.attributes?.SAN?.name || 'ç†æ™º', value: 45, desc: trans.attributes?.SAN?.desc || 'é¢å°éœ€æ±‚è®Šæ›´çš„å¿ƒæ™º' },
  { key: 'STS', name: trans.attributes?.STS?.name || 'è€å£“', value: 78, desc: trans.attributes?.STS?.desc || 'è™•ç†é«˜å£“ç’°å¢ƒ' },
  { key: 'CAF', name: trans.attributes?.CAF?.name || 'å’–å•¡', value: 95, desc: trans.attributes?.CAF?.desc || 'å’–å•¡å› ä¾è³´ç¨‹åº¦' },
  { key: 'OVT', name: trans.attributes?.OVT?.name || 'åŠ ç­', value: 60, desc: trans.attributes?.OVT?.desc || 'åŠ ç­è€å—åŠ›' },
  { key: 'DLN', name: trans.attributes?.DLN?.name || 'æ­»ç·š', value: 85, desc: trans.attributes?.DLN?.desc || 'è¶• Deadline çš„èƒ½åŠ›' },
  { key: 'LUK', name: trans.attributes?.LUK?.name || 'é‹æ°£', value: 50, desc: trans.attributes?.LUK?.desc || 'ä¸€æ¬¡å°±éçš„æ©Ÿç‡' },
];
---

<BaseLayout title={pageTitle} description={pageDescription} lang={lang}>
  <div class="rpg-interface">
    <header class="site-header">
      <div class="header-content">
        <h1 class="site-title">{pageTitle}</h1>
        <LanguageSwitcher currentLang={lang} currentPath={Astro.url.pathname} />
      </div>
    </header>

    <div class="game-container">
      <!-- ç‹€æ…‹åˆ— -->
      <StatusBar lang={lang} />

      <!-- é ç±¤å°èˆª -->
      <GameTabs lang={lang} activeTab="status" />

      <!-- é ç±¤å…§å®¹å€åŸŸ -->
      <div class="tab-content">
        <!-- ç‹€æ…‹é¢æ¿ -->
        <div class="tab-panel active" id="status-tab">
          <div class="status-panel">
            <h3 class="panel-title">
              <i class="fas fa-chart-bar"></i>
              {trans.status?.attributes || 'è§’è‰²å±¬æ€§'}
            </h3>
            <div class="attributes-grid">
              {attributes.map((attr) => (
                <div class="attribute-item">
                  <div class="attr-header">
                    <span class="attr-key">{attr.key}</span>
                    <span class="attr-name">{attr.name}</span>
                    <span class="attr-value">{attr.value}</span>
                  </div>
                  <div class="attr-bar">
                    <div class="attr-fill" style={`width: ${attr.value}%`}></div>
                  </div>
                  <p class="attr-desc">{attr.desc}</p>
                </div>
              ))}
            </div>
          </div>
        </div>

        <!-- æŠ€èƒ½é¢æ¿ -->
        <div class="tab-panel" id="skills-tab">
          <SkillTreePanel lang={lang} />
        </div>

        <!-- æ•…äº‹é¢æ¿ -->
        <div class="tab-panel" id="story-tab">
          <div class="story-panel">
            <h3 class="panel-title">
              <i class="fas fa-book"></i>
              {trans.story?.title || 'å†’éšªæ•…äº‹'}
            </h3>
            <div class="story-content">
              <p>{trans.story?.intro || 'ä¸€ä½å¾æ­¦è¡“é¤¨è½‰è·åˆ°ç¨‹å¼ä¸–ç•Œçš„å†’éšªè€…...'}</p>
            </div>
          </div>
        </div>

        <!-- ç‰©å“æ¬„é¢æ¿ -->
        <div class="tab-panel" id="inventory-tab">
          <InventoryPanel lang={lang} />
        </div>

        <!-- æˆå°±é¢æ¿ -->
        <div class="tab-panel" id="achievements-tab">
          <AchievementsPanel lang={lang} />
        </div>

        <!-- å¤¥ä¼´é¢æ¿ -->
        <div class="tab-panel" id="party-tab">
          <div class="party-panel">
            <h3 class="panel-title">
              <i class="fas fa-users"></i>
              {trans.party?.title || 'å¤¥ä¼´'}
            </h3>
            <div class="party-grid" id="party-grid">
              <p>{trans.party?.empty || 'ç›®å‰æ²’æœ‰å¤¥ä¼´åŠ å…¥éšŠä¼'}</p>
            </div>
          </div>
        </div>

        <!-- è³¼è²·é¢æ¿ -->
        <div class="tab-panel" id="purchase-tab">
          <div class="purchase-panel">
            <h3 class="panel-title">
              <i class="fas fa-shopping-cart"></i>
              {trans.purchase?.title || 'è³¼è²· SGT'}
            </h3>
            <div class="purchase-content">
              <!-- éŒ¢åŒ…é€£æ¥çµ„ä»¶ -->
              <WalletConnect lang={lang} />

              <!-- SGT ä»£å¹£è³‡è¨Šï¼ˆéŒ¢åŒ…é€£æ¥å¾Œé¡¯ç¤ºï¼‰ -->
              <div class="sgt-info" id="sgt-info" style="display: none;">
                <div class="sgt-balance-card">
                  <div class="sgt-icon">
                    <i class="fas fa-coins"></i>
                  </div>
                  <div class="sgt-details">
                    <span class="sgt-label">{trans.purchase?.sgt_balance || 'SGT é¤˜é¡'}</span>
                    <span class="sgt-amount" id="sgt-balance">0.0000</span>
                  </div>
                </div>

                <!-- è³¼è²·è¡¨å–® -->
                <div class="purchase-form" id="purchase-form">
                  <div class="form-group">
                    <label for="usdt-amount">{trans.purchase?.usdt_amount || 'USDT æ•¸é‡'}</label>
                    <input
                      type="number"
                      id="usdt-amount"
                      min="1"
                      step="1"
                      placeholder="100"
                      class="form-input"
                    />
                  </div>
                  <div class="exchange-rate">
                    <i class="fas fa-exchange-alt"></i>
                    <span id="exchange-preview">0 USDT = 0 SGT</span>
                  </div>
                  <button class="purchase-btn" id="purchase-btn" disabled>
                    <i class="fas fa-shopping-cart"></i>
                    {trans.purchase?.buy_sgt || 'è³¼è²· SGT'}
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</BaseLayout>

<style>
  .rpg-interface {
    min-height: 100vh;
    background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%);
  }

  .site-header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    padding: 0.75rem 2rem;
    background: rgba(10, 14, 39, 0.95);
    border-bottom: 1px solid #ffd700;
    z-index: 100;
  }

  .header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    max-width: 1400px;
    margin: 0 auto;
  }

  .site-title {
    font-size: 1.3rem;
    color: #ffd700;
    margin: 0;
  }

  .game-container {
    padding-top: 60px;
    max-width: 1400px;
    margin: 0 auto;
  }

  .tab-content {
    min-height: 500px;
  }

  .tab-panel {
    display: none;
    padding: 1.5rem;
    animation: fadeIn 0.3s ease;
  }

  .tab-panel.active {
    display: block;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .panel-title {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: #ffd700;
    font-size: 1.25rem;
    margin: 0 0 1.5rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid rgba(255, 215, 0, 0.3);
  }

  /* å±¬æ€§é¢æ¿æ¨£å¼ */
  .attributes-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1rem;
  }

  .attribute-item {
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 215, 0, 0.2);
    border-radius: 8px;
    padding: 1rem;
    transition: all 0.2s ease;
  }

  .attribute-item:hover {
    border-color: #ffd700;
    background: rgba(255, 215, 0, 0.05);
  }

  .attr-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
  }

  .attr-key {
    background: #ffd700;
    color: #0a0e27;
    padding: 0.15rem 0.4rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: bold;
  }

  .attr-name {
    color: #e0e0e0;
    font-weight: 500;
  }

  .attr-value {
    margin-left: auto;
    color: #ffd700;
    font-weight: bold;
  }

  .attr-bar {
    height: 8px;
    background: rgba(0, 0, 0, 0.5);
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 0.5rem;
  }

  .attr-fill {
    height: 100%;
    background: linear-gradient(to right, #ffd700, #ffaa00);
    border-radius: 4px;
    transition: width 0.5s ease;
  }

  .attr-desc {
    margin: 0;
    font-size: 0.8rem;
    color: #888;
  }

  /* æŠ€èƒ½æ¨¹é¢æ¿ */
  .skill-tree-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
  }

  #skill-tree-canvas {
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 215, 0, 0.2);
    border-radius: 8px;
    max-width: 100%;
  }

  .skill-tree-hint {
    color: #888;
    font-size: 0.85rem;
  }

  /* å…¶ä»–é¢æ¿é€šç”¨æ¨£å¼ */
  .story-panel,
  .inventory-panel,
  .achievements-panel,
  .party-panel,
  .purchase-panel {
    color: #e0e0e0;
  }

  .story-content {
    line-height: 1.8;
    background: rgba(0, 0, 0, 0.3);
    padding: 1.5rem;
    border-radius: 8px;
  }

  .inventory-grid,
  .achievements-grid,
  .party-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    gap: 0.5rem;
  }

  /* è³¼è²·é¢æ¿ */
  .purchase-content {
    max-width: 500px;
    margin: 0 auto;
  }

  .sgt-info {
    margin-top: 1.5rem;
    animation: fadeIn 0.3s ease;
  }

  .sgt-balance-card {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1.25rem;
    background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 170, 0, 0.05));
    border: 1px solid rgba(255, 215, 0, 0.3);
    border-radius: 12px;
    margin-bottom: 1.5rem;
  }

  .sgt-icon {
    font-size: 2rem;
    color: #ffd700;
  }

  .sgt-details {
    display: flex;
    flex-direction: column;
  }

  .sgt-label {
    font-size: 0.85rem;
    color: #888;
  }

  .sgt-amount {
    font-size: 1.5rem;
    font-weight: bold;
    color: #ffd700;
  }

  .purchase-form {
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 215, 0, 0.2);
    border-radius: 12px;
    padding: 1.5rem;
  }

  .form-group {
    margin-bottom: 1rem;
  }

  .form-group label {
    display: block;
    margin-bottom: 0.5rem;
    color: #b0b0b0;
    font-size: 0.9rem;
  }

  .form-input {
    width: 100%;
    padding: 0.75rem 1rem;
    background: rgba(0, 0, 0, 0.4);
    border: 1px solid rgba(255, 215, 0, 0.3);
    border-radius: 8px;
    color: #e0e0e0;
    font-size: 1rem;
    transition: border-color 0.2s;
  }

  .form-input:focus {
    outline: none;
    border-color: #ffd700;
  }

  .form-input::placeholder {
    color: #666;
  }

  .exchange-rate {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem;
    background: rgba(100, 149, 237, 0.1);
    border-radius: 8px;
    margin-bottom: 1rem;
    color: #6495ed;
    font-size: 0.9rem;
  }

  .purchase-btn {
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 1rem;
    background: linear-gradient(135deg, #ffd700, #ffaa00);
    border: none;
    border-radius: 8px;
    color: #0a0e27;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .purchase-btn:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
  }

  .purchase-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  @media (max-width: 768px) {
    .game-container {
      padding-top: 50px;
    }

    .tab-panel {
      padding: 1rem;
    }

    .attributes-grid {
      grid-template-columns: 1fr;
    }
  }
</style>

<script>
  // åˆå§‹åŒ–éŠæˆ²ç³»çµ±
  import { initGameState, getGameState } from '@scripts/core/gamestate';
  import { getWalletManager, initWalletManager } from '@scripts/web3/wallet-manager';
  import { initPurchaseManager, getPurchaseManager } from '@scripts/web3/purchase-manager';
  import { initSGTBalance, getSGTBalance } from '@scripts/web3/sgt-balance';
  import { getContractsConfig } from '@scripts/web3/contracts-config';

  // å…Œæ›æ¯”ä¾‹ï¼ˆ1 USDT = 30 SGTï¼Œèˆ‡åˆç´„ä¸€è‡´ï¼‰
  const EXCHANGE_RATE = 30;

  document.addEventListener('DOMContentLoaded', async () => {
    console.log('ğŸ® SuperGalen Dungeon åˆå§‹åŒ–ä¸­...');

    // åˆå§‹åŒ–éŠæˆ²ç‹€æ…‹
    initGameState();
    console.log('âœ“ éŠæˆ²ç‹€æ…‹å·²åˆå§‹åŒ–');

    // åˆå§‹åŒ– Web3 æ¨¡çµ„
    await initWalletManager();
    console.log('âœ“ éŒ¢åŒ…ç®¡ç†å™¨å·²åˆå§‹åŒ–');

    await initSGTBalance();
    console.log('âœ“ SGT é¤˜é¡é¡¯ç¤ºå™¨å·²åˆå§‹åŒ–');

    await initPurchaseManager();
    console.log('âœ“ è³¼è²·ç®¡ç†å™¨å·²åˆå§‹åŒ–');

    // ç›£è½éŠæˆ²äº‹ä»¶
    document.addEventListener('playerDied', () => {
      console.log('ğŸ’€ ç©å®¶æ­»äº¡ï¼Œé–‹å§‹å¾©æ´»å€’æ•¸...');
    });

    document.addEventListener('playerRevived', () => {
      console.log('âœ¨ ç©å®¶å·²å¾©æ´»ï¼');
    });

    document.addEventListener('gameStateUpdated', (e: Event) => {
      const customEvent = e as CustomEvent;
      console.log('ğŸ“Š éŠæˆ²ç‹€æ…‹æ›´æ–°:', customEvent.detail);
    });

    // è¨­ç½®è³¼è²·é¢æ¿äº’å‹•
    setupPurchasePanel();

    console.log('ğŸ° SuperGalen Dungeon æº–å‚™å°±ç·’ï¼');
  });

  function setupPurchasePanel() {
    const sgtInfoEl = document.getElementById('sgt-info');
    const usdtAmountInput = document.getElementById('usdt-amount') as HTMLInputElement;
    const exchangePreviewEl = document.getElementById('exchange-preview');
    const purchaseBtn = document.getElementById('purchase-btn');
    const sgtBalanceEl = document.getElementById('sgt-balance');

    // ç›£è½éŒ¢åŒ…é€£æ¥äº‹ä»¶
    document.addEventListener('wallet:connect', async (e: Event) => {
      const customEvent = e as CustomEvent;
      if (customEvent.detail?.success && sgtInfoEl) {
        sgtInfoEl.style.display = 'block';

        // æ›´æ–° SGT é¤˜é¡
        const sgtBalance = getSGTBalance();
        await sgtBalance.refresh();
      }
    });

    document.addEventListener('wallet:disconnect', () => {
      if (sgtInfoEl) {
        sgtInfoEl.style.display = 'none';
      }
      if (sgtBalanceEl) {
        sgtBalanceEl.textContent = '0.0000';
      }
    });

    // ç›£è½ SGT é¤˜é¡æ›´æ–°äº‹ä»¶
    document.addEventListener('sgtBalanceUpdated', (e: Event) => {
      const customEvent = e as CustomEvent;
      if (sgtBalanceEl && customEvent.detail?.newBalance) {
        const balance = parseFloat(customEvent.detail.newBalance);
        sgtBalanceEl.textContent = balance.toFixed(4);
      }
    });

    // è™•ç† USDT è¼¸å…¥è®Šæ›´
    usdtAmountInput?.addEventListener('input', () => {
      const usdtAmount = parseFloat(usdtAmountInput.value) || 0;
      const sgtAmount = usdtAmount * EXCHANGE_RATE;

      if (exchangePreviewEl) {
        exchangePreviewEl.textContent = `${usdtAmount} USDT = ${sgtAmount.toLocaleString()} SGT`;
      }

      if (purchaseBtn) {
        (purchaseBtn as HTMLButtonElement).disabled = usdtAmount <= 0;
      }
    });

    // è™•ç†è³¼è²·æŒ‰éˆ•é»æ“Š
    purchaseBtn?.addEventListener('click', async () => {
      const wallet = getWalletManager();
      const state = wallet.getState();

      if (!state.isConnected) {
        // å˜—è©¦é€£æ¥éŒ¢åŒ…
        await wallet.connect();
        return;
      }

      const usdtAmount = parseFloat(usdtAmountInput?.value || '0');
      if (usdtAmount <= 0) {
        alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„ USDT æ•¸é‡');
        return;
      }

      // ä½¿ç”¨è³¼è²·ç®¡ç†å™¨åŸ·è¡Œè³¼è²·
      const purchaseManager = getPurchaseManager();
      await purchaseManager.purchaseSGT();
    });

    // æª¢æŸ¥åˆå§‹é€£æ¥ç‹€æ…‹
    try {
      const wallet = getWalletManager();
      const state = wallet.getState();
      if (state.isConnected && sgtInfoEl) {
        sgtInfoEl.style.display = 'block';
      }
    } catch {
      // éŒ¢åŒ…ç®¡ç†å™¨å°šæœªåˆå§‹åŒ–
    }
  }
</script>
